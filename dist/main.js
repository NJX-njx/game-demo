class N{constructor(){if(N.instance)return N.instance;N.instance=this}async loadJSON(t){const e=await fetch(t);if(!e.ok)throw new Error(`Failed to load JSON: ${t}`);return await e.json()}async loadImg(t){return new Promise((e,s)=>{const i=new Image;i.src=t,i.onload=()=>e(i),i.onerror=a=>s(new Error(`Failed to load image: ${t}`))})}}const Q=new N;class L{constructor(){if(L.instance)return L.instance;L.instance=this}async load(){this.tempCanvas=document.querySelector("canvas#buffer"),this.texturesURL=await Q.loadJSON("assets/imgs/Textures.json"),this.textures={};const t=new Map,e=[];for(const i of Object.keys(this.texturesURL))for(const a of Object.keys(this.texturesURL[i]))e.push(this.texturesURL[i][a]);const s=e.map(async i=>{const a=await fetch(i);if(!a.ok)throw new Error(`Failed to load image: ${i}`);const n=await a.blob(),o=await createImageBitmap(n);t.set(i,o)});await Promise.all(s);for(const i of Object.keys(this.texturesURL)){this.textures[i]={};for(const a of Object.keys(this.texturesURL[i]))this.textures[i][a]=t.get(this.texturesURL[i][a])}}getTexture(t,e="0"){return this.textures[t]&&this.textures[t][e]?this.textures[t][e]:null}}const D=new L;let m=class T{constructor(t=0,e=0){this.x=t,this.y=e}copy(){return new T(this.x,this.y)}getAxis(t){return t===0?this.x:this.y}add(t,e){return new T(this.x+t,this.y+e)}addVector(t){return this.add(t.x,t.y)}sub(t,e){return this.add(-t,-e)}subVector(t){return this.sub(t.x,t.y)}addEqual(t){return this.x+=t.x,this.y+=t.y,this}subEqual(t){return this.x-=t.x,this.y-=t.y,this}scale(t){return new T(this.x*t,this.y*t)}magnitude(){return Math.sqrt(this.x**2+this.y**2)}normalize(){const t=this.magnitude();return t===0?new T(0,0):new T(this.x/t,this.y/t)}dot(t){return this.x*t.x+this.y*t.y}rotate(t){const e=Math.cos(t),s=Math.sin(t),i=this.x*e-this.y*s,a=this.x*s+this.y*e;return new T(i,a)}angle(){return Math.atan2(this.y,this.x)}round(){return new T(Math.round(this.x),Math.round(this.y))}};class I{static instance;constructor(t){if(I.instance)return I.instance;I.instance=this,this.canvas=t,this.ctx=t.getContext("2d"),this.x=0,this.y=0,this.left=!1,this.right=!1,t.addEventListener("mousemove",e=>this.move(e)),t.addEventListener("mousedown",e=>this.down(e)),t.addEventListener("mouseup",e=>this.up(e)),window.addEventListener("blur",()=>this.onBlur()),window.addEventListener("focus",()=>this.onFocus())}move(t){const e=this.canvas.getBoundingClientRect();this.x=(t.clientX-e.left)*(this.canvas.width/e.width),this.y=(t.clientY-e.top)*(this.canvas.height/e.height),this.x=Math.max(0,Math.min(this.x,this.canvas.width)),this.y=Math.max(0,Math.min(this.y,this.canvas.height))}down(t){t.button===0&&(this.left=!0),t.button===2&&(this.right=!0)}up(t){t.button===0&&(this.left=!1),t.button===2&&(this.right=!1)}draw(t){t.drawImage(D.getTexture("cursor"),12,9,16,22,this.x-4,this.y-5,16,22)}get position(){return new m(this.x,this.y)}onBlur(){E.isPaused||(E.pause(),console.log("æ¸¸æˆå·²è‡ªåŠ¨æš‚åœï¼ˆçª—å£å¤±åŽ»ç„¦ç‚¹ï¼‰")),this.left=!1,this.right=!1}onFocus(){console.log("çª—å£èŽ·å¾—ç„¦ç‚¹")}}const J=new I(document.getElementById("ui-canvas"));class P{status;KEYMAP=new Map([["ShiftLeft","LShift"],["ShiftRight","RShift"],["ControlLeft","LCtrl"],["ControlRight","RCtrl"],["AltLeft","LAlt"],["AltRight","RAlt"],["MetaLeft","LWin"],["MetaRight","RWin"],["Escape","Esc"],["F1","F1"],["F2","F2"],["F3","F3"],["F4","F4"],["F5","F5"],["F6","F6"],["F7","F7"],["F8","F8"],["F9","F9"],["F10","F10"],["F11","F11"],["F12","F12"],["Digit0","0"],["Digit1","1"],["Digit2","2"],["Digit3","3"],["Digit4","4"],["Digit5","5"],["Digit6","6"],["Digit7","7"],["Digit8","8"],["Digit9","9"],["KeyA","A"],["KeyB","B"],["KeyC","C"],["KeyD","D"],["KeyE","E"],["KeyF","F"],["KeyG","G"],["KeyH","H"],["KeyI","I"],["KeyJ","J"],["KeyK","K"],["KeyL","L"],["KeyM","M"],["KeyN","N"],["KeyO","O"],["KeyP","P"],["KeyQ","Q"],["KeyR","R"],["KeyS","S"],["KeyT","T"],["KeyU","U"],["KeyV","V"],["KeyW","W"],["KeyX","X"],["KeyY","Y"],["KeyZ","Z"],["ArrowUp","Up"],["ArrowDown","Down"],["ArrowLeft","Left"],["ArrowRight","Right"],["Home","Home"],["End","End"],["PageUp","Page Up"],["PageDown","Page Down"],["Enter","Enter"],["Space","Space"],["Backspace","Backspace"],["Tab","Tab"],["Delete","Delete"],["Insert","Insert"],["CapsLock","Caps Lock"],["NumLock","Num Lock"],["ScrollLock","Scroll Lock"],["Pause","Pause"],["PrintScreen","Print Screen"],["Numpad0","NUMPAD0"],["Numpad1","NUMPAD1"],["Numpad2","NUMPAD2"],["Numpad3","NUMPAD3"],["Numpad4","NUMPAD4"],["Numpad5","NUMPAD5"],["Numpad6","NUMPAD6"],["Numpad7","NUMPAD7"],["Numpad8","NUMPAD8"],["Numpad9","NUMPAD9"],["NumpadMultiply","Mul"],["NumpadAdd","Add"],["NumpadSubtract","Sub"],["NumpadDecimal","Dec"],["NumpadDivide","Div"],["ContextMenu","Apps"],["Help","Help"]]);constructor(){if(P.instance)return P.instance;P.instance=this,this.status=new Map,this.KEYMAP.forEach((t,e)=>{this.status.set(t,!1)}),document.addEventListener("keydown",t=>{const e=this.KEYMAP.get(t.code);this.status.has(e)&&this.status.set(e,!0)}),document.addEventListener("keyup",t=>{const e=this.KEYMAP.get(t.code);this.status.has(e)&&this.status.set(e,!1)}),addEventListener("keydown",t=>{t.preventDefault()})}isKeyDown(t){return this.status.get(t)||!1}isKeysDown(t){let e=!1;return t.forEach(s=>{e=e||this.isKeyDown(s)}),e}}const ot=new P;class ht{constructor(){this.mouse=J,this.keyboard=ot,this.keyPrevState=new Map,this.keyCurrState=new Map}update(){[...this.keyboard.KEYMAP.values(),"ClickLeft","ClickRight"].forEach(e=>{this.keyPrevState.set(e,this.keyCurrState.get(e)||!1),this.keyCurrState.set(e,this.isKeyDown(e))})}isKeyDown(t){return t==="ClickLeft"?this.mouse.left:t==="ClickRight"?this.mouse.right:this.keyboard.isKeyDown(t)}isKeysDown(t){return t.some(e=>this.isKeyDown(e))}isAllKeysDown(t){return t.every(e=>this.isKeyDown(e))}isFirstDown(t){return this.keyCurrState.get(t)&&!this.keyPrevState.get(t)}isHeld(t){return this.keyCurrState.get(t)}isReleased(t){return!this.keyCurrState.get(t)&&this.keyPrevState.get(t)}}const w=new ht;class C{constructor(){if(C.instance)return C.instance;C.instance=this,this.backgroundMusic=null,this.init()}handleClick=()=>{const t=new Audio;t.muted=!0,t.play().catch(()=>{}),document.removeEventListener("click",this.handleClick)};init(){document.addEventListener("click",this.handleClick)}async load(){this.sounds={},this.soundsURL=await Q.loadJSON("assets/audios/Sounds.json");for(const t of Object.keys(this.soundsURL)){this.sounds[t]={};for(const e of Object.keys(this.soundsURL[t])){const s=new Audio(this.soundsURL[t][e]);s.loop=!1,this.sounds[t][e]=s}}}async playSound(t,e=0){const s=this.sounds[t]&&this.sounds[t][e];if(s)if(s.paused)s.currentTime=0,s.play().catch(i=>{console.error(`Error playing sound: ${t+e}`,i)});else{if(t==="walk")return;const i=s.cloneNode();i.currentTime=0,i.play().catch(a=>{console.error(`Error playing sound: ${t+e}`,a)})}}}const K=new C,u={game:{tick:"GAME_TICK",battle:{start:"GAME_BATTLE_START",end:"GAME_BATTLE_END"},enter:{shop:"GAME_ENTER_SHOP"},finish:"GAME_FINISH"},item:{gain:"ITEM_GAIN",use:"ITEM_USE"},player:{die:"PLAYER_DIE",hpPercent:"PLAYER_HP_PERCENT",heal:"PLAYER_HEAL",dealDamage:"PLAYER_DEAL_DAMAGE",takeDamage:"PLAYER_TAKE_DAMAGE",fatelDmg:"PLAYER_FATEL_DAMAGE"},enemy:{die:"ENEMY_DIE"},boss:{},interaction:{trigger:"MAP_INTERACTION_TRIGGER"}};class O{constructor(){if(O.instance)return O.instance;O.instance=this,this.listeners=new Map,this.validEvents=new Set,this._completedEvents=new Set,this._initValidEvents(u)}_initValidEvents(t){for(const e in t)typeof t[e]=="object"?this._initValidEvents(t[e]):this.validEvents.add(t[e])}_checkEvent(t){this.validEvents.has(t)||console.warn(`[EventBus] äº‹ä»¶ "${t}" ä¸å­˜åœ¨`)}on({event:t,handler:e,priority:s=0,maxCalls:i=1/0,onDispose:a=null,source:n=null}){this._checkEvent(t),this.listeners.has(t)||this.listeners.set(t,[]);const o=this.listeners.get(t),d={handler:e,priority:s,maxCalls:i,callCount:0,onDispose:a,source:n},x=o.findIndex(A=>s>A.priority);return x===-1?o.push(d):o.splice(x,0,d),()=>this.off(t,e)}off(t,e){this._checkEvent(t);const s=this.listeners.get(t);s&&this.listeners.set(t,s.filter(i=>i.handler===e?(i.onDispose&&i.onDispose(),!1):!0))}offBySource(t){for(const[e,s]of this.listeners.entries()){const i=s.filter(a=>a.source&&a.source===t?(a.onDispose&&a.onDispose(),!1):!0);i.length>0?this.listeners.set(e,i):this.listeners.delete(e)}}emit(t,e){this._checkEvent(t);const s=this.listeners.get(t);if(s)for(const i of[...s]){try{i.handler(e)}catch(a){console.error(`[EventBus] ${t} handler error`,a)}i.callCount++,i.callCount>=i.maxCalls&&this.off(t,i.handler)}}emitInterruptible(t,e){this._checkEvent(t);const s=this.listeners.get(t);if(!s)return!1;for(const i of[...s]){let a=!1;try{a=i.handler(e)===!0}catch(n){console.error(`[EventBus] ${t} handler error`,n)}if(i.callCount++,i.callCount>=i.maxCalls&&this.off(t,i.handler),a)return!0}return!1}emitReduce(t,e,s){this._checkEvent(t);const i=this.listeners.get(t);if(!i)return e;let a=e;for(const n of[...i]){try{const o=n.handler(a);o!==void 0&&(a=s(a,o))}catch(o){console.error(`[EventBus] ${t} handler error`,o)}n.callCount++,n.callCount>=n.maxCalls&&this.off(t,n.handler)}return a}getCompletedEvents(){return Array.from(this._completedEvents)}restoreCompletedEvents(t){Array.isArray(t)&&(this._completedEvents=new Set(t))}completeEvent(t){this._completedEvents.add(t)}isEventCompleted(t){return this._completedEvents.has(t)}}const f=new O;class b{constructor(t,e){this.position=t,this.size=e}add(t,e=new Vector(0,0)){return new b(t.addVector(this.position),e.addVector(this.size))}getCenter(){return this.position.addVector(this.size.scale(.5))}getTopLeft(){return this.position}getBottomRight(){return this.position.addVector(this.size)}contains(t){const e=this.getTopLeft(),s=this.getBottomRight();return t.x>=e.x&&t.x<=s.x&&t.y>=e.y&&t.y<=s.y}checkHit(t){const e=this.getTopLeft().x,s=this.getBottomRight().x,i=this.getTopLeft().y,a=this.getBottomRight().y,n=t.getTopLeft().x,o=t.getBottomRight().x,d=t.getTopLeft().y,x=t.getBottomRight().y;return!(s<=n||e>=o||i>=x||a<=d)}checkHits(t,e){for(let s of t)if(this.checkHit(s))return e(),s;return null}merge(t){let e=new Vector(Math.min(this.position.x,t.position.x),Math.min(this.position.y,t.position.y)),s=new Vector(Math.max(this.position.x+this.size.x,t.position.x+t.size.x),Math.max(this.position.y+this.size.y,t.position.y+t.size.y));return tt(e,s)}clip(t){let e=new Vector(Math.max(this.position.x,t.position.x),Math.max(this.position.y,t.position.y)),s=new Vector(Math.min(this.position.x+this.size.x,t.position.x+t.size.x),Math.min(this.position.y+this.size.y,t.position.y+t.size.y));return tt(e,s)}}const tt=(r,t)=>r.x>=t.x||r.y>=t.y?null:new b(r,t.subVector(r));class lt extends b{constructor(t,e,s){super(new m(t.x,t.y),new m(e.x,e.y)),this.type=s}}class ct extends b{constructor(t,e,s,i,a={}){super(new m(t.x,t.y),new m(e.x,e.y)),this.type=s,this.autoTrigger=!!i;for(const n in a)n!=="position"&&n!=="size"&&(this[n]=a[n]);this.__id=Math.random().toString(36).substr(2,9)}}class H{constructor(){if(H.instance)return H.instance;H.instance=this,this.backgrounds=[],this.blocks=[],this.textures=[],this.interactions=[],this.mapHitBox=new b(new m(0,0),new m(1280,720)),this._triggeredInteractionIds=new Set,this._completedEvents=new Set}async loadRoom(t,e){const s=`assets/stages/layer${t}/room${e}.json`;try{const i=await Q.loadJSON(s);this.rawMapData=JSON.parse(JSON.stringify(i)),this.currentLayer=typeof t=="string"?parseInt(t,10):t,this.currentRoom=typeof e=="string"?parseInt(e,10):e,this.playerSpawn=i.playerSpawn?{...i.playerSpawn}:null,this.enemySpawns=Array.isArray(i.enemySpawns)?i.enemySpawns.map(n=>({...n})):[],this.backgrounds=(i.backgrounds||[]).map(n=>({...n})),this.blocks=(i.blocks||[]).map(n=>new lt(n.position,n.size,n.type)),this.textures=(i.textures||[]).map(n=>({...n}));const a=(i.interactions||[]).map(n=>new ct(n.position,n.size,n.type,n.autoTrigger,n));this.interactions=[...a.filter(n=>n.autoTrigger),...a.filter(n=>!n.autoTrigger)],this._triggeredInteractionIds.clear(),console.log("ðŸ—ºï¸ åŠ è½½äº¤äº’ç‚¹:",this.interactions.map(n=>({type:n.type,position:n.position,size:n.size,autoTrigger:n.autoTrigger,can_be_used_when:n.can_be_used_when,positionType:typeof n.position,sizeType:typeof n.size,hasAddVector:typeof n.position?.addVector})))}catch(i){console.error("MapManager.loadRoom error:",i)}}getPlayerSpawn(){return this.playerSpawn}getEnemySpawns(){return this.enemySpawns||[]}getBlockHitboxes(){return this.blocks||[]}getInteractionHitboxes(){return this.interactions||[]}update(t,e){try{if(!e||!this.interactions||this.interactions.length===0)return;const s=e.hitbox||e.getHitbox?.();if(!s)return;for(let i=0;i<this.interactions.length;i++){const a=this.interactions[i];if(!a)continue;const n=s.checkHit(a),o=this._triggeredInteractionIds.has(a.__id);if(n){if((a.type==="next_room"||a.type==="exit")&&console.log("ðŸŽ¯ çŽ©å®¶åœ¨ä¼ é€ç‚¹åŒºåŸŸ:",{type:a.type,playerPos:s.position,interactionPos:a.position,overlapping:n}),a.autoTrigger&&!o){this._triggeredInteractionIds.add(a.__id),f.emit(u.interaction.trigger,{type:a.type,event:a.event,data:a});continue}a.autoTrigger||w.isKeyDown("E")&&(console.log("ðŸ”‘ Eé”®æŒ‰ä¸‹ï¼Œè§¦å‘äº¤äº’:",a.type,a.event),f.emit(u.interaction.trigger,{type:a.type,event:a.event,data:a}))}}}catch(s){console.error("MapManager.update error:",s)}}draw(t){for(const e of this.backgrounds)this.drawItem(t,e,"background");for(const e of this.blocks)this.drawItem(t,e,"block");for(const e of this.textures)this.drawItem(t,e,"texture");for(const e of this.interactions)this.drawInteraction(t,e)}drawItem(t,e,s){t.save();let i=null,a=s+"s";i=D.getTexture(a,e.type),i?t.drawImage(i,e.position.x,e.position.y,e.size.x,e.size.y):(s==="background"?t.fillStyle="#e0e0e0":s==="block"?t.fillStyle="#654321":s==="texture"?t.fillStyle="#8888ff":t.fillStyle="#cccccc",t.fillRect(e.position.x,e.position.y,e.size.x,e.size.y)),t.restore()}drawInteraction(t,e){if(e.type!=="next_room"&&e.type!=="exit")return;t.save(),t.lineWidth=2;const s=this.enemySpawns&&this.enemySpawns.length>0,i=e.can_be_used_when==="battle_end"||s;i?t.strokeStyle="#ffaa00":t.strokeStyle="#00ff00",t.strokeRect(e.position.x,e.position.y,e.size.x,e.size.y),t.fillStyle="rgba(0, 0, 0, 0.7)",t.fillRect(e.position.x,e.position.y-25,e.size.x,20);let a="",n="#ffffff";i?(a="ä¼ é€ç‚¹ (éœ€å‡»è´¥æ‰€æœ‰æ•Œäºº)",n="#ffaa00"):(a="ä¼ é€ç‚¹ (æŒ‰Eé”®ä¼ é€)",n="#00ff00"),t.fillStyle=n,t.font="12px Arial",t.textAlign="center",t.fillText(a,e.position.x+e.size.x/2,e.position.y-10),t.restore()}getMapState(){return{triggeredInteractions:Array.from(this._triggeredInteractionIds),completedEvents:Array.from(this._completedEvents),currentLayer:this.currentLayer,currentRoom:this.currentRoom}}restoreMapState(t){t.triggeredInteractions&&(this._triggeredInteractionIds=new Set(t.triggeredInteractions)),t.completedEvents&&(this._completedEvents=new Set(t.completedEvents))}completeEvent(t){this._completedEvents.add(t)}isEventCompleted(t){return this._completedEvents.has(t)}}const g=new H;class Y{constructor(t=0){this.t=0,this.cd=t}start(){this.t=this.cd}tick(t){this.t=Math.max(0,this.t-t)}ready(){return this.t===0}reset(){this.t=0}set(t=0){this.cd=t}}class ut{constructor(t,e,s,i,a){this.baseJump=t,this.maxJump=e,this.gravity=s,this.coyoteTime=i,this.jumpBuffer=new Y(a),this.jumpBufferTime=a,this.isJumping=!1,this.isFalling=!1,this.jumpVelocity=0,this.chargeTime=0,this.coyoteTimer=0,this.times=1}startJump(){this.isJumping=!0,this.isFalling=!1,this.chargeTime=0,this.jumpBuffer.reset(),this.coyoteTimer=0,K.playSound(this.type,"jump")}updateJump(t,e,s){this.jumpBuffer.tick(e),s?(this.coyoteTimer=this.coyoteTime,this.isJumping=!1,this.isFalling=!1,!s&2&&(this.jumpVelocity=0),s&2?this.times=1.5:this.times=1,this.jumpBuffer.ready()||this.startJump()):(this.isJumping||(this.isFalling=!0),this.coyoteTimer=Math.max(this.coyoteTimer-e,0),!this.isJumping&&!this.jumpBuffer.ready()&&this.coyoteTimer>0&&this.startJump()),this.isJumping?!this.isFalling&&t&&this.chargeTime<this.maxJump*this.times?(this.chargeTime+=e,this.jumpVelocity=Math.min(this.baseJump+this.chargeTime/this.maxJump*this.times*(this.maxJump*this.times-this.baseJump),this.maxJump*this.times)):(this.isFalling=!0,this.updateFalling(e)):this.isFalling&&this.updateFalling(e)}updateFalling(t){this.jumpVelocity-=this.gravity*t,this.jumpVelocity=Math.max(-6*this.baseJump,this.jumpVelocity)}}class W{constructor(t,e,s=new m){this.type="",this.velocity=s,this.hitbox=new b(t,e),this.jumping=new ut(4,9,.5,8,15),this.MaxSpeed=6,this.attackBox=null,this.hurtBox=null}getCenter(){return this.hitbox.getCenter()}isOnGround(){if(this.velocity.y<0)return!1;this.hitbox.position.y+=1;let t=!1;const e=g.getBlockHitboxes();return t=!!this.hitbox.checkHits(e,()=>{}),this.hitbox.position.y-=1,t&&(this.isflying=0),t}rigidMove(t){let e=this.velocity.scale(t).round(),s=0,i=g.getBlockHitboxes();for(let a=0;a<Math.abs(e.x);++a)if(this.hitbox.position.x+=Math.sign(e.x),this.hitbox.checkHits(i,()=>{this.hitbox.position.x-=Math.sign(e.x)})){s|=1;break}for(let a=0;a<Math.abs(e.y);++a)if(this.hitbox.position.y+=Math.sign(e.y),this.hitbox.checkHits(i,()=>{this.hitbox.position.y-=Math.sign(e.y)})){s|=2;break}return s}updateY(t,e){this.jumping.updateJump(e,t,this.isOnGround())}updateX(t,e){const s=this.isOnGround();let i=this.velocity.x;if(s){if(e===0)i*=Math.exp(-.5*t);else{const a=10*t;i=e*Math.min(Math.sqrt(this.velocity.x*this.velocity.x+a),this.MaxSpeed)}e&&K.playSound(this.type,"walk")}else{const a=.3*t;e!==0?(i+=a*(e*this.MaxSpeed-this.velocity.x),Math.abs(i)>this.MaxSpeed&&(i=this.MaxSpeed*Math.sign(i))):i*=Math.exp(-.05*t)}return i}updateXY(t,e,s){this.updateY(t,s()),this.velocity.y=-this.jumping.jumpVelocity,this.velocity.x=this.updateX(t,e());let i=this.rigidMove(t);i&1&&(this.velocity.x=0),i&2&&(this.velocity.y=this.jumping.jumpVelocity=0)}update(t){deltaFrame=60*t/1e3,this.updateXY(deltaFrame,()=>0,()=>0)}draw(t){t.fillStyle="rgba(221, 100, 0, 1)",t.fillRect(this.hitbox.position.x,this.hitbox.position.y,this.hitbox.size.x,this.hitbox.size.y)}}class mt extends W{constructor(t,e,s,i,a=new m(10,10)){super(t,a,e),this.type="projectile",this.damage=s,this.alive=!0,this.hurtBox=this.hitbox,this.from=i,q.add(this)}update(t){if(!this.alive)return;const e=60*t/1e3;if(this.rigidMove(e)){this.alive=!1;return}this.from.targetSelector().forEach(i=>{this.hurtBox.checkHit(i.hurtBox)&&(this.from.applyDamage(i,this.damage),this.alive=!1)})}draw(t){this.alive&&(t.fillStyle="yellow",t.fillRect(this.hitbox.position.x,this.hitbox.position.y,this.hitbox.size.x,this.hitbox.size.y))}}class B{constructor(){if(B.instance)return B.instance;B.instance=this,this.projectiles=[]}add(t){this.projectiles.push(t)}update(t){this.projectiles.forEach(e=>e.update(t)),this.projectiles=this.projectiles.filter(e=>e.alive)}draw(t){this.projectiles.forEach(e=>e.draw(t))}clear(){this.projectiles.length=0}}const q=new B;class dt{constructor(t=0){this.duration=t,this.remainingTime=0}start(t=null){t!==null&&(this.duration=t),this.remainingTime=this.duration}tick(t){this.remainingTime=Math.max(0,this.remainingTime-t)}expired(){return this.remainingTime<=0}reset(){this.remainingTime=0}remaining(){return this.remainingTime}set(t){this.duration=t}}const c={player:{ATK:"PLAYER_ATK",HP:"PLAYER_HP",SPD:"PLAYER_SPD",HEAL:"PLAYER_HEAL",DMG:"PLAYER_DMG",LOS:"PLAYER_LOS",TAKE_DMG:"PLAYER_TAKE_DAMAGE",DASH_CHARGE:"PLAYER_DASH_CHARGE",AttackStartupTime:"PLAYER_AttackStartupTime",AttackRecoveryTime:"PLAYER_AttackRecoveryTime",MeteeStartupTime:"PLAYER_MeteeStartupTime",MeteeRecoveryTime:"PLAYER_MeteeRecoveryTime",RangedStartupTime:"PLAYER_RangedStartupTime",RangedRecoveryTime:"PLAYER_RangedRecoveryTime"},enemy:{ATK:"ENEMY_ATK",HP:"ENEMY_HP",DMG:"ENEMY_DMG",DMG_DEC:"ENEMY_DMG_DEC",AttackStartupTime:"ENEMY_AttackStartupTime",AttackRecoveryTime:"ENEMY_AttackRecoveryTime",MeteeStartupTime:"ENEMY_MeteeStartupTime",MeteeRecoveryTime:"ENEMY_MeteeRecoveryTime",RangedStartupTime:"ENEMY_RangedStartupTime",RangedRecoveryTime:"ENEMY_RangedRecoveryTime"},boss:{ATK:"BOSS_ATK",HP:"BOSS_HP",AttackStartupTime:"BOSS_AttackStartupTime",AttackRecoveryTime:"BOSS_AttackRecoveryTime",MeteeStartupTime:"BOSS_MeteeStartupTime",MeteeRecoveryTime:"BOSS_MeteeRecoveryTime",RangedStartupTime:"BOSS_RangedStartupTime",RangedRecoveryTime:"BOSS_RangedRecoveryTime"}};class G{constructor(){if(G.instance)return G.instance;G.instance=this,this.attributes={},this.validAttributes=new Set,this._initValidAttributes(c)}_initValidAttributes(t){for(const e in t)typeof t[e]=="object"?this._initValidAttributes(t[e]):this.validAttributes.add(t[e])}_checkAttr(t){const e=this.validAttributes.has(t);return e||console.warn(`[AttributeManager] å±žæ€§ "${t}" ä¸å­˜åœ¨`),e}addAttr(t,e,s,i=null,a=null){if(!this._checkAttr(t))return;this.attributes[t]||(this.attributes[t]={}),this.attributes[t][s]||(this.attributes[t][s]=[]);const n=this.attributes[t][s];for(;a&&n.length>=a;)n.shift();const o=i!==null?new dt(i):null;o&&o.start(i),n.push({value:e,timer:o})}removeAttrBySource(t,e){this.attributes[t]&&delete this.attributes[t][e]}removeOneAttrLayer(t,e){if(!this._checkAttr(t)||!this.attributes[t]||!this.attributes[t][e])return!1;const s=this.attributes[t][e];return s.length===0?!1:(s.shift(),s.length===0&&delete this.attributes[t][e],!0)}removeAllAttrBySource(t){for(const e of Object.keys(this.attributes))this.attributes[e][t]&&delete this.attributes[e][t]}refreshAttrDuration(t,e,s){if(this._checkAttr(t)&&!(!this.attributes[t]||!this.attributes[t][e]))for(const i of this.attributes[t][e])i.timer&&i.timer.start(s)}getAttrSum(t){if(!this._checkAttr(t)||!this.attributes[t])return 0;let e=0;for(const s of Object.keys(this.attributes[t])){const i=this.attributes[t][s];e+=i.reduce((a,n)=>a+n.value,0)}return e}getAttrStackCount(t,e){return!this._checkAttr(t)||!this.attributes[t]||!this.attributes[t][e]?0:this.attributes[t][e].length}getAllAttrByType(t){const e={};for(const s of Object.keys(t)){const i=t[s];e[i]=this.getAttrSum(i)}return e}getAllAttr(){const t={};for(const e of Object.keys(this.attributes))t[e]=this.getAttrSum(e);return t}update(t){for(const e of Object.keys(this.attributes))for(const s of Object.keys(this.attributes[e])){const i=this.attributes[e][s];for(const a of i)a.timer&&a.timer.tick(t);this.attributes[e][s]=i.filter(a=>!a.timer||!a.timer.expired()),this.attributes[e][s].length===0&&delete this.attributes[e][s]}}}const y=new G;class st{constructor(t,e){this.owner=t,this.type=e,this.state="idle",this.timer=0}get damage(){return this.owner.state.attack.damage[this.type]}get startupTime(){return this.owner.state.attack.startupTime[this.type]}get recoveryTime(){return this.owner.state.attack.recoveryTime[this.type]}get targetSelector(){return this.owner.attack.targetSelector}trigger(){return this.state==="idle"?(this.state="startup",this.timer=this.startupTime,!0):!1}update(t){if(this.state!=="idle"&&(this.timer-=t,!(this.timer>0)))switch(this.state){case"startup":this.enterActive();break;case"active":this.enterRecovery();break;case"recovery":this.state="idle";break}}enterActive(){this.state="active",K.playSound(this.owner.type,this.type+"Attack"),this.onHit(this.owner,this.damage)}enterRecovery(){this.state="recovery",this.timer=this.recoveryTime}applyDamage(t,e){if(t.beforeTakeDamage&&!t.beforeTakeDamage())return;let s=e;this.owner.dealDamageEvent&&(s=f.emitReduce(this.owner.dealDamageEvent,{baseDamage:s},(i,a)=>a).baseDamage),t.takeDamage(s,this.type)}onHit(t,e){}}class it extends st{constructor(t){super(t,"melee")}onHit(t,e){const i=t.facing>0?t.hitbox.size.x/2:-t.hitbox.size.x/2,a=t.hitbox.position.addVector(new m(i,t.hitbox.size.y*.25)),n=new m(t.hitbox.size.x*.8,t.hitbox.size.y*.5),o=new b(a,n);this.targetSelector().forEach(d=>{o.checkHit(d.hurtBox)&&this.applyDamage(d,e)})}}class pt extends st{constructor(t){super(t,"ranged")}onHit(t,e){const i=t.facing,a=t.hitbox.getCenter();new mt(a,new m(12*i,0),e,this)}}class ft{static Framerate={run:6,jump:30,fall:30,stand:8};static Frames={run:6,jump:4,fall:2,stand:7};constructor(){this.status="run",this.facing=1,this.frame=1,this.frameRun=0}setStatus(t,e){(t!=this.status||e!=this.facing)&&(this.frame=1,this.frameRun=0,this.status=t,this.facing=e)}update(t){}getFrame(){return D.getTexture("player",0)}}class z extends W{static getSaveData(){return{position:this.instance.hitbox.position,state:this.instance.state,inventory:[],timestamp:new Date().toISOString()}}static loadSaveData(t){this.instance&&(this.instance.hitbox.position=t.position,this.instance.state=t.state)}constructor(t=new m(50,50)){if(z.instance)return z.instance;super(new m,t,new m),z.instance=this,this.size=t,this.type="player",this.jumping.type="player",this.baseState={hp_max:100,attack:{atk:10,MeleeStartupTime:50,MeleeRecoveryTime:900,RangedStartupTime:150,RangedRecoveryTime:700},dash_cooldownTime:600,dash_maxCount:1},this.state={hp:this.baseState.hp_max,hp_max:this.baseState.hp_max,attack:{atk:this.baseState.attack.atk,damage:{melee:this.baseState.attack.atk,ranged:this.baseState.attack.atk},startupTime:{melee:this.baseState.attack.MeleeStartupTime,ranged:this.baseState.attack.RangedStartupTime},recoveryTime:{melee:this.baseState.attack.MeleeRecoveryTime,ranged:this.baseState.attack.RangedRecoveryTime}}},this.attack={targetSelector:()=>E.enemies,melee:new it(this),ranged:new pt(this)},this.facing=1,this.animation=new ft,this.initDash(),this.hurtBox=this.hitbox,this.controllerX=()=>{if(this.blockMove)return 0;let e=w.isKeysDown(["A","Left"]),s=w.isKeysDown(["D","Right"]),i=0;return e&&s?i=0:e?this.facing=i=-1:s&&(this.facing=i=1),i},this.controllerY=()=>this.blockMove?0:(w.isFirstDown("Space")&&this.jumping.jumpBuffer.start(),w.isHeld("Space")),this.dealDamageEvent=u.player.dealDamage}update(t){this.updateState(),f.emit(u.player.hpPercent,this.state.hp/this.state.hp_max),w.isKeyDown("J")&&this.attack.melee.trigger(),w.isKeyDown("L")&&this.attack.ranged.trigger(),this.attack.melee.update(t),this.attack.ranged.update(t),this.dash.update(t);const e=60*t/1e3;this.updateXY(e,this.controllerX(),this.controllerY()),this.jumping.jumpVelocity>0?this.animation.setStatus("jump",this.facing):this.isOnGround()?this.animation.setStatus("stand",this.facing):this.jumping.jumpVelocity<0&&this.animation.setStatus("fall",this.facing),this.animation.update(e)}updateXY(t,e,s){this.dash.isDashing||(this.updateY(t,s),this.velocity.y=-this.jumping.jumpVelocity,this.velocity.x=this.updateX(t,e));let i=this.rigidMove(t);i&1&&(this.velocity.x=0,this.dash.isDashing=0),i&2&&(this.velocity.y=this.jumping.jumpVelocity=0)}updateState(){const t=y.getAttrSum(c.player.HP),e=y.getAttrSum(c.player.ATK),s=y.getAttrSum(c.player.DMG),i=y.getAttrSum(c.player.MeteeStartupTime),a=y.getAttrSum(c.player.MeteeRecoveryTime),n=y.getAttrSum(c.player.RangedStartupTime),o=y.getAttrSum(c.player.RangedRecoveryTime),d=y.getAttrSum(c.player.DASH_CHARGE);this.state.hp_max=this.baseState.hp_max*(1+t),this.state.hp=Math.min(this.state.hp,this.state.hp_max),this.state.attack.atk=this.baseState.attack.atk*(1+e),this.state.attack.damage.melee=this.state.attack.atk*(1+s),this.state.attack.damage.ranged=this.state.attack.atk*(1+s),this.state.attack.startupTime.melee=this.baseState.attack.MeleeStartupTime+i,this.state.attack.startupTime.ranged=this.baseState.attack.RangedStartupTime+n,this.state.attack.recoveryTime.melee=this.baseState.attack.MeleeRecoveryTime+a,this.state.attack.recoveryTime.ranged=this.baseState.attack.RangedRecoveryTime+o,this.dash.dashCooldownTime=this.baseState.dash_cooldownTime*(1-d),this.dash.dashCooldown.set(this.dash.dashCooldownTime)}initDash(){this.dash={isDashing:!1,dashDuration:200,dashCooldownTime:this.baseState.dash_cooldownTime,dashSpeed:15,dashDir:{x:1,y:0},dashDurationCooldown:null,dashCooldown:null,dashMaxCount:this.baseState.dash_maxCount,dashCount:0,update:null},this.dash.dashDurationCooldown=new Y(this.dash.dashDuration),this.dash.dashCooldown=new Y(this.dash.dashCooldownTime),this.dash.update=t=>{this.isOnGround()&&(this.dash.dashCooldown.tick(t),this.dash.dashCooldown.ready()&&this.dash.dashCount<this.dash.dashMaxCount&&(this.dash.dashCount++,this.dash.dashCooldown.start()));let e=0,s=0;if(w.isKeysDown(["A","Left"])&&(e-=1),w.isKeysDown(["D","Right"])&&(e+=1),w.isKeysDown(["W","Up"])&&(s-=1),w.isKeysDown(["S","Down"])&&(s+=1),!this.dash.isDashing&&this.dash.dashCount>0&&w.isKeyDown("K")){e===0&&s===0&&(e=this.facing);let i=Math.sqrt(e*e+s*s);i===0&&(i=1),this.dash.dashDir={x:e/i,y:s/i},this.dash.isDashing=!0,this.dash.dashDurationCooldown.start(),this.dash.dashCount--,K.playSound("player","dash")}this.dash.isDashing&&(this.dash.dashDurationCooldown.tick(t),this.velocity.x=this.dash.dashSpeed*this.dash.dashDir.x,this.velocity.y=this.dash.dashSpeed*this.dash.dashDir.y,this.dash.dashDurationCooldown.ready()&&(this.dash.isDashing=!1,this.jumping.jumpVelocity=-this.velocity.y))}}beforeTakeDamage(t){return this.dash.isDashing!==!0}takeDamage(t,e){let s=f.emitReduce(u.player.takeDamage,{baseDamage:t},(i,a)=>a).baseDamage;this.state.hp-=s,this.state.hp<=0&&(f.emit(u.player.die),alert("ä½ æ­»äº†"))}takeHeal(t,e=null){let s=t*(1+y.getAttrSum(c.player.HEAL));s=f.emitReduce(u.player.heal,{baseHeal:s},(a,n)=>n).baseHeal;const i=Math.max(0,s);this.state.hp=Math.min(this.state.hp_max,this.state.hp+i)}setPosition(t){this.hitbox.position=t}draw(t){t.drawImage(this.animation.getFrame(),this.hitbox.position.x,this.hitbox.position.y,this.size.x,this.size.y),this.drawDashUI(t)}drawBoxs(t){t.strokeStyle=this.isInvulnerable?"#cccccc":"#00aaff",t.strokeRect(this.hitbox.position.x,this.hitbox.position.y,this.hitbox.size.x,this.hitbox.size.y),t.strokeStyle="#ff0000";const e=.5*(this.facing>=0?this.hitbox.size.x:-this.hitbox.size.x),s=this.hitbox.position.addVector(new m(e,this.hitbox.size.y*.2)),i=new m(this.hitbox.size.x*.8,this.hitbox.size.y*.5);t.strokeRect(s.x,s.y,i.x,i.y),t.restore()}drawDashUI(t){const e=this.dash.dashMaxCount,s=this.dash.dashCount,i=8,a=4,n=this.hitbox.position.x+this.size.x/2-(e*(i+a)-a)/2,o=this.hitbox.position.y-12;for(let d=0;d<e;d++)t.fillStyle=d<s?"cyan":"gray",t.fillRect(n+d*(i+a),o,i,i),t.strokeStyle="black",t.strokeRect(n+d*(i+a),o,i,i)}}const p=new z;class gt{static Framerate={run:6,jump:30,fall:30,stand:8};static Frames={run:6,jump:4,fall:2,stand:7};constructor(){this.status="run",this.facing=1,this.frame=1,this.frameRun=0}setStatus(t,e){(t!=this.status||e!=this.facing)&&(this.frame=1,this.frameRun=0,this.status=t,this.facing=e)}update(t){}getFrame(){return D.getTexture("enemy",0)}}class j extends W{constructor(t,e,s=new m(50,50),i=new m){super(e,s,i),this.Size=s,this.type="enemy"+t,this.enemytype=t,this.baseState={hp_max:100,attack:{atk:10,MeleeStartupTime:50,MeleeRecoveryTime:900,RangedStartupTime:150,RangedRecoveryTime:700}},this.state={hp:this.baseState.hp_max,hp_max:this.baseState.hp_max,attack:{damage:{melee:this.baseState.attack_baseDamage,ranged:this.baseState.attack_baseDamage},startupTime:{melee:this.baseState.attack_baseMeleeStartupTime,ranged:this.baseState.attack_baseRangedStartupTime},recoveryTime:{melee:this.baseState.attack_baseMeleeRecoveryTime,ranged:this.baseState.attack_baseRangedStartupTime}}},this.facing=1,this.animation=new gt,this.attack={melee:new it(this),targetSelector:()=>[p]},this.hurtBox=this.hitbox,this._unbind_list=[]}update(t){this.updateState();const e=Math.abs(this.hitbox.getCenter().x-p.hitbox.getCenter().x),s=this.hitbox.getCenter().y-p.hitbox.getCenter().y;let i=!1,a="patrol";s>50?e<400&&Math.abs(s)<100&&(a="seek_path",this.hasDirectPathToPlayer()&&(i=Math.random()<.2)):s<-50?e<300&&Math.abs(s)<80&&(a="wait",this.hasSafeDropPath()&&(i=Math.random()<.3)):e<400&&Math.abs(s)<60&&(a="attack",i=Math.random()<.4),i&&this.attack.melee.trigger(),this.attack.melee.update(t),this.updateMovementByMode(a,e,s);const n=60*t/1e3;let o=0;this.updateXY(n,()=>{if(this.blockMove)return 0;if(o=0,a==="attack"||a==="seek_path")this.hitbox.position.x<p.hitbox.position.x?this.facing=o=1:this.facing=o=-1,o*=.3;else if(a==="wait")o=0;else{Math.random()<.002&&(this.facing=Math.random()<.5?1:-1);const d=this.hitbox.position.x+this.facing*2,x=new b(new m(d,this.hitbox.position.y),this.hitbox.size),A=g.getBlockHitboxes();let Z=!1;for(const rt of A)if(x.checkHit(rt)){Z=!0;break}(Z||d<0||d>1280)&&(this.facing=-this.facing),o=this.facing*.2}return o},()=>{if(this.blockMove||!(a==="attack"||a==="seek_path"))return 0},!0),this.jumping.jumpVelocity>0?this.animation.setStatus("jump",this.facing):this.isOnGround()?o?this.animation.setStatus("run",this.facing):this.animation.setStatus("stand",this.facing):this.jumping.jumpVelocity<0&&this.animation.setStatus("fall",this.facing),this.animation.update(n)}hasDirectPathToPlayer(){const t=p.hitbox.position,e=this.hitbox.position,s=g.getBlockHitboxes(),i=new b(new m(Math.min(e.x,t.x),Math.min(e.y,t.y)),new m(Math.abs(t.x-e.x),Math.abs(t.y-e.y)));for(const a of s)if(i.checkHit(a))return!1;return!0}hasSafeDropPath(){p.hitbox.position;const t=this.hitbox.position,e=g.getBlockHitboxes(),s=t.y+100,i=new b(new m(t.x,t.y),new m(this.hitbox.size.x,s-t.y));for(const a of e)if(i.checkHit(a))return!0;return!1}updateMovementByMode(t,e,s){switch(t){case"seek_path":this.seekVerticalPath();break;case"wait":this.waitForPlayer();break;case"attack":this.normalMovement();break;case"patrol":default:this.patrolMovement();break}}seekVerticalPath(){const t=p.hitbox.position,e=this.hitbox.position,s=g.getBlockHitboxes();let i=null,a=1/0;for(const n of s)if(n.position.y<e.y&&n.position.y>t.y-50){const o=Math.abs(n.position.x-e.x);o<a&&(a=o,i=n)}i?this.moveToTarget(i):this.wait()}waitForPlayer(){this.hasSafeDropPath()?this.seekDropPoint():this.patrolMovement()}normalMovement(){}patrolMovement(){Math.random()<.02&&(this.facing=Math.random()<.5?1:-1);const t=this.hitbox.position.x+this.facing*2,e=new b(new m(t,this.hitbox.position.y),this.hitbox.size),s=g.getBlockHitboxes();let i=!1;for(const a of s)if(e.checkHit(a)){i=!0;break}(i||t<0||t>1280)&&(this.facing=-this.facing)}moveToTarget(t){const e=t.position,s=this.hitbox.position;e.x>s.x?this.facing=1:e.x<s.x&&(this.facing=-1),e.y<s.y&&this.isOnGround()&&this.jumping.jumpBuffer.start()}seekDropPoint(){const t=p.hitbox.position,e=this.hitbox.position,s=g.getBlockHitboxes();let i=null,a=1/0;for(const n of s)if(n.position.y>e.y&&n.position.y<t.y+50){const o=Math.abs(n.position.x-e.x);o<a&&(a=o,i=n)}i&&this.moveToTarget(i)}wait(){}updateState(){const t=y.getAttrSum(c.enemy.HP),e=y.getAttrSum(c.enemy.ATK),s=y.getAttrSum(c.enemy.DMG),i=y.getAttrSum(c.enemy.DMG_DEC),a=y.getAttrSum(c.enemy.MeteeStartupTime),n=y.getAttrSum(c.enemy.MeteeRecoveryTime),o=y.getAttrSum(c.enemy.RangedStartupTime),d=y.getAttrSum(c.enemy.RangedRecoveryTime);this.state.hp_max=this.baseState.hp_max*(1+t),this.state.hp=Math.min(this.state.hp,this.state.hp_max),this.state.attack.atk=this.baseState.attack.atk*(1+e),this.state.attack.startupTime.melee=this.baseState.attack.MeleeStartupTime+a,this.state.attack.startupTime.ranged=this.baseState.attack.RangedStartupTime+o,this.state.attack.recoveryTime.melee=this.baseState.attack.MeleeRecoveryTime+n,this.state.attack.recoveryTime.ranged=this.baseState.attack.RangedRecoveryTime+d;let x=this.state.attack.atk*(1+s);x=Math.max(x-i,.1*x),this.state.attack.damage.melee=x,this.state.attack.damage.ranged=x}takeDamage(t,e){if(this.state.hp-=t,this.state.hp<=0){f.emit(u.enemy.die,{attackType:e}),this._unbind_list.forEach(i=>i()),this._unbind_list=[];const s=E.enemies.indexOf(this);s!==-1&&E.enemies.splice(s,1)}}draw(t){t.drawImage(D.getTexture("enemy",this.enemytype),this.hitbox.position.x,this.hitbox.position.y,this.Size.x,this.Size.y);const e=this.Size.x,s=6,i=this.hitbox.position.x,a=this.hitbox.position.y-12;t.save(),t.fillStyle="red",t.fillRect(i,a,e,s),t.fillStyle="green";const n=Math.max(this.state.hp,0)/this.state.hp_max,o=e*n;t.fillRect(i,a,o,s),t.strokeStyle="black",t.strokeRect(i,a,e,s),t.restore()}drawBoxs(t){t.strokeStyle=this.isInvulnerable?"#cccccc":"#00aaff",t.strokeRect(this.hitbox.position.x,this.hitbox.position.y,this.hitbox.size.x,this.hitbox.size.y),t.strokeStyle="#ff0000";const e=.5*(this.facing>=0?this.hitbox.size.x:-this.hitbox.size.x),s=this.hitbox.position.addVector(new m(e,this.hitbox.size.y*.25)),i=new m(this.hitbox.size.x*.8,this.hitbox.size.y*.5);t.strokeRect(s.x,s.y,i.x,i.y),t.restore()}}const h={NO_EXCHANGE:"noExcgange",NO_DROP:"noDrop",NO_RANDOM:"noRandom",SPECIAL_EXCHANGE:"specialExchange",ADD_SLOTS:"addSlots",UNIQUE_GLOBAL:"uniqueGlobal",UNIQUE_SINGLE:"uniqueSingle",MULTIPLE:"multiple"},S={ENDING:"end",NORMAL:"normal"},_={yyå‹è°Š:{name:"å‹è°Š",level:1,type:S.NORMAL,tags:[h.UNIQUE_GLOBAL,h.NO_EXCHANGE,h.NO_DROP,h.NO_RANDOM],effects:{[c.player.HP]:.25,[c.player.DMG]:.25,[c.boss.ATK]:.25,[c.boss.HP]:.3},hooks:r=>[{event:u.game.tick,handler:({deltaTime:t})=>r.state.healTimer.tick(t),priority:1},{event:u.player.hpPercent,handler:t=>{t<.25&&r.state.healTimer.ready()&&(r.state.healTimer.start(),p.takeHeal(p.state.hp_max*.01,r.id))}},{event:u.player.fatelDmg,handler:()=>(p.state.hp=p.state.hp_max,f.on({event:u.game.battle.end,handler:()=>{l.remove(r),l.tryAcquire(_.bcæ‚²æ€†)},maxCalls:1}),!0),maxCalls:1},{event:u.game.finish,handler:t=>{t.unlockEnding?.("hidden_path_friendship",{desc:"ä½¿æŽ¢ç´¢å¼€å¯ä¸åŒçš„æ–¹å‘"})},maxCalls:1}],onAcquire(r){},state:{healTimer:new Y(1e3)}},bcæ‚²æ€†:{name:"æ‚²æ€†",level:1,type:S.NORMAL,tags:[h.UNIQUE_GLOBAL,h.NO_EXCHANGE,h.NO_DROP,h.NO_RANDOM],effects:{[c.player.HP]:-.6},hooks:r=>[{event:u.enemy.die,handler:()=>{y.addAttr(c.player.HP,.08,r.id),y.getAttrStackCount(c.player.HP,r.id)==10&&f.on({event:u.game.battle.end,handler:()=>{l.remove(r),l.tryAcquire(_.snæ€å¿µ)},maxCalls:1})}},{event:u.game.finish,handler:t=>{},maxCalls:1}],onAcquire(r){}},snæ€å¿µ:{name:"æ€å¿µ",level:1,type:S.NORMAL,tags:[h.UNIQUE_GLOBAL,h.NO_RANDOM],effects:{[c.player.HP]:.2},hooks:r=>[{event:u.player.dealDamage,handler:t=>{switch(Math.floor(Math.random()*3)){case 0:return{...t,baseDamage:t.baseDamage*1.15};case 1:f.on({event:u.player.takeDamage,handler:e=>({...e,baseDamage:e*.7}),maxCalls:1,source:r.id});break;case 2:p.takeHeal(p.state.hp_max*.01);break}}}],onAcquire(r){}},dsèƒ†è¯†:{name:"èƒ†è¯†",level:0,type:S.ENDING,tags:[h.UNIQUE_GLOBAL,h.NO_DROP,h.NO_RANDOM,h.SPECIAL_EXCHANGE],effects:{[c.enemy.DMG_DEC]:-15,[c.boss.HP]:.45},hooks:r=>[{event:u.game.finish,handler:t=>{},maxCalls:1}]},jså†³å¿ƒ:{name:"å†³å¿ƒ",level:0,type:S.ENDING,tags:[h.UNIQUE_GLOBAL,h.NO_DROP,h.NO_EXCHANGE,h.NO_RANDOM],effects:{[c.enemy.DMG_DEC]:-10,[c.player.ATK]:.35,[c.player.HP]:-.2},hooks:r=>[{event:u.game.finish,handler:t=>{},maxCalls:1}],onAcquire(r){p.state.hp=p.state.hp_max}},yyçŠ¹ç–‘:{name:"çŠ¹ç–‘",level:0,type:S.ENDING,tags:[h.UNIQUE_GLOBAL,h.NO_DROP,h.NO_RANDOM,h.SPECIAL_EXCHANGE],effects:{[c.player.SPD]:-.4,[c.player.ATK]:-.2}},gwè§‚æœ›:{name:"è§‚æœ›",level:0,type:S.ENDING,tags:[h.UNIQUE_GLOBAL,h.NO_DROP,h.NO_EXCHANGE,h.NO_RANDOM],effects:{[c.player.DASH_CHARGE]:.15}},hqå¥½å¥‡:{name:"å¥½å¥‡",level:1,type:S.NORMAL,tags:[h.UNIQUE_GLOBAL,h.NO_DROP,h.NO_EXCHANGE,h.SPECIAL_EXCHANGE],effects:{[c.player.TAKE_DMG]:.3},hooks:r=>[{event:u.game.enter.shop,handler:()=>{r.removeTag(h.NO_DROP),r.removeTag(h.NO_EXCHANGE)}}],onAcquire(r){}},zxçæƒœ:{name:"çæƒœ",level:1,type:S.NORMAL,tags:[h.UNIQUE_GLOBAL,h.NO_EXCHANGE,h.SPECIAL_EXCHANGE,h.NO_RANDOM],effects:{},hooks:r=>[{event:u.game.enter.shop,handler:()=>{r.removeTag(h.NO_EXCHANGE)}}],onAcquire(r){},onExchange(r){}},lsæœ—è¯µ:{name:"æœ—è¯µ",level:1,type:S.NORMAL,tags:[h.UNIQUE_GLOBAL,h.NO_RANDOM,h.ADD_SLOTS],onAcquire(r){l.addSlots(2,{maxLevel:3,type:S.NORMAL},r.id)},canRemove:r=>l.slots.filter(e=>e._source===r.id).every(e=>e.item==null||e.item===r)},xqä¼‘æ†©:{name:"ä¼‘æ†©",level:1,type:S.NORMAL,tags:[h.MULTIPLE],hooks:r=>[{event:u.item.use,handler:({usedItem:t})=>{t===r&&(p.takeHeal(p.state.hp_max*.4,r.id),l.remove(r))}}]},jyæƒŠè®¶:{name:"æƒŠè®¶",level:1,type:S.NORMAL,tags:[h.UNIQUE_SINGLE]},dgç¥·å‘Š:{name:"ç¥·å‘Š",level:1,type:S.NORMAL,tags:[h.UNIQUE_SINGLE,h.SPECIAL_EXCHANGE],effects:{[c.player.LOS]:-.3}}};let yt=0;const $=new Set;class xt{constructor(t){this.config=t,this.state=t.state?{...t.state}:{},this.id=`${t.name}_${yt++}`,this.name=t.name,this.tags=[...t.tags||[]],this.type=t.type,this.level=t.level,$.add(t.name),this._slot=null,this._init=!1,this._active=!1}activate(){if(!this._active){if(this._active=!0,this.config.effects)for(const t in this.config.effects)y.addAttr(t,this.config.effects[t],this.id);if(this.config.hooks)for(const t of this.config.hooks(this)){const e={...t,handler:t.handler.bind(this),source:this.id};f.on(e)}typeof this.config.onActivate=="function"&&this.config.onActivate(this),typeof this.config.onAcquire=="function"&&!this._init&&(this.config.onAcquire(this),this._init=!0)}}deactivate(){this._active&&(this._active=!1,y.removeAllAttrBySource(this.id),f.offBySource(this.id),this.hasTag(h.ADD_SLOTS)&&l.removeSlotsBySource(this.id))}addTag(t){this.tags.includes(t)||this.tags.push(t)}removeTag(t){this.tags=this.tags.filter(e=>e!==t)}hasTag(t){return this.tags.includes(t)}canRemove(){return this.hasTag(h.NO_DROP)?!1:typeof this.config.canRemove=="function"?this.config.canRemove(this):!0}dispose(){this.deactivate(),typeof this.config.onRemove=="function"&&this.config.onRemove(this)}}const k={INVENTORY:"INVENTORY",PICKUP:"PICKUP",TRUSH:"TRUSH"};class v{constructor({type:t=k.INVENTORY,itemType:e=null,maxLevel:s=1/0,_source:i=null}={}){this.type=t,this.itemType=e,this.maxLevel=s,this.item=null,this._source=i}canAccept(t){return t?!(this.type===k.PICKUP||this.type===k.TRUSH&&!t.canRemove()||this.itemType&&this.itemType!==t.type||this.maxLevel<t.level):!0}setItem(t){if(this.type===k.TRUSH){t.dispose();return}this.item=t,t&&(t._slot=this)}removeItem(){this.item&&(this.item._slot=null),this.item=null}isEmpty(){return this.item===null}}class U{constructor(){if(U.instance)return U.instance;U.instance=this,this.slots=[new v({itemType:S.ENDING,maxLevel:1/0}),new v({maxLevel:3}),new v({maxLevel:2}),new v({maxLevel:2}),new v({maxLevel:2}),new v({maxLevel:1}),new v({maxLevel:1}),new v({maxLevel:1})],this.trashSlot=new v({type:k.TRUSH}),this.selectedIndex=0,this.dragging=!1,this.draggingFrom=null,this.draggingItem=null}swapSlots(t,e){if(!t||!e)return!1;const s=t.item,i=e.item;return!e.canAccept(s)||!t.canAccept(i)||t.type!=k.INVENTORY&&i&&!i.canRemove()||e.type!=k.INVENTORY&&s&&!s.canRemove()?!1:(t.type!=k.INVENTORY&&i&&i.deactivate(),e.type!=k.INVENTORY&&s&&s.deactivate(),t.removeItem(),e.removeItem(),t.setItem(i),e.setItem(s),!0)}tryAcquire(t){if(t.tags?.includes(h.UNIQUE_GLOBAL)&&$.has(t.name)||t.tags?.includes(h.UNIQUE_SINGLE)&&this.slots.some(a=>a.item?.config.name===t.name))return null;const e=this.slots.findIndex(i=>!i.item&&i.canAccept(t));if(e===-1)return null;const s=new xt(t);return s.activate(),this.slots[e].setItem(s),s._slot=this.slots[e],s}remove(t){t.dispose(),t._slot.removeItem()}getAt(t){return this.slots[t]?.item||null}getAll(){return this.slots.map(t=>t.item)}selectNext(){this.selectedIndex=(this.selectedIndex+1)%this.slots.length}selectPrev(){this.selectedIndex=(this.selectedIndex-1+this.slots.length)%this.slots.length}getSelectedSlot(){return this.slots[this.selectedIndex]||null}getSelectedItem(){return this.slots[this.selectedIndex]?.item||null}addSlots(t,e={},s=null){const{maxLevel:i=1,type:a=S.NORMAL}=e;for(let n=0;n<t;n++){const o=new v({itemType:a,maxLevel:i,_source:s});this.slots.push(o)}}removeSlotsBySource(t,e=!0){t&&(this.slots=this.slots.filter(s=>s._source===t?(e&&s.item&&(s.item.dispose(),s.removeItem()),!1):!0))}getRandomConfig(t,e={}){const{exclude:s=[],type:i=S.NORMAL}=e,a=Object.values(_).filter(o=>!(o.level!==t||i&&o.type!==i||s.includes(o.name)||o.tags?.includes(h.NO_RANDOM)||o.tags?.includes(h.UNIQUE_GLOBAL)&&$.has(o.name)||o.tags?.includes(h.UNIQUE_SINGLE)&&this.slots.some(x=>x.item?.config.name===o.name)));return a.length===0?null:a[Math.floor(Math.random()*a.length)]}update(t){w.isFirstDown("N")&&l.selectNext(),w.isFirstDown("M")&&l.selectPrev(),w.isFirstDown("I")&&f.emit(u.item.use,{usedItem:this.getSelectedItem()})}}const l=new U;class at{constructor(t){this.name=t,this.elements=[],this.visible=!1}addElement(t){this.elements.push(t)}show(){this.visible=!0}hide(){this.visible=!1}draw(t){if(this.visible)for(let e of this.elements)e.draw(t)}handleEvent(t){if(!this.visible)return!1;for(let e=this.elements.length-1;e>=0;e--)if(this.elements[e].handleEvent(t))return!0;return!1}}class nt{constructor(t,e,s,i){this.x=t,this.y=e,this.width=s,this.height=i,this.visible=!0,this.draggable=!1,this.dragging=!1}draw(t){}update(t){}contains(t,e){return t>=this.x&&t<=this.x+this.width&&e>=this.y&&e<=this.y+this.height}handleEvent(t){return!1}}class et extends nt{constructor(t,e,s,i){super(e,s,i,i),this.slot=t,this.size=i,this.padding=5,this.hovering=!1}draw(t){if(!this.visible)return;t.fillStyle="rgba(50,50,50,0.7)",t.fillRect(this.x,this.y,this.width,this.height),this.hovering&&l.draggingFrom?(t.strokeStyle=this.slot.canAccept(l.draggingItem)?"lime":"red",t.lineWidth=3):(t.strokeStyle=l.getSelectedSlot()===this.slot?"yellow":"white",t.lineWidth=l.getSelectedSlot()===this.slot?2:1),t.strokeRect(this.x,this.y,this.width,this.height);let e="ç©º";this.slot.item&&this.slot!==l.draggingFrom?e=this.slot.item.name:this.slot.type===k.TRUSH&&(e="åžƒåœ¾æ¡¶"),t.fillStyle="white",t.font=`${Math.min(this.width/3,14)}px sans-serif`,t.textAlign="center",t.textBaseline="middle",t.fillText(e,this.x+this.width/2,this.y+this.height/2)}handleEvent(t){const{type:e,offsetX:s,offsetY:i}=t;if(this.hovering=this.contains(s,i),!this.contains(s,i))return!1;switch(e){case"mousedown":if(this.slot.item)return l.dragging=!0,l.draggingFrom=this.slot,l.draggingItem=this.slot.item,!0;break;case"mouseup":if(l.dragging)return l.swapSlots(l.draggingFrom,this.slot)||console.warn("äº¤æ¢å¤±è´¥"),l.dragging=!1,l.draggingFrom=null,l.draggingItem=null,!0;break}return!1}}const St=document.getElementById("game-canvas"),wt=document.getElementById("ui-canvas");St.getContext("2d");wt.getContext("2d");const V={width:1440,height:720};class bt extends at{constructor(t="itemBar",e=80,s=60,i=5){super(t),this.name=t,this.width=e,this.slotSize=s,this.padding=i,this.visible=!0,this.elements=[];const a=V.width-this.width+this.padding,n=V.height-this.slotSize-this.padding;this.trashSlot=new et(l.trashSlot,a,n,this.slotSize)}draw(t){if(this.elements.length!=l.slots.length+1){const e=V.width-this.width+this.padding,s=this.padding;this.elements=l.slots.map((i,a)=>new et(i,e,s+a*(this.slotSize+this.padding),this.slotSize)),this.elements.push(this.trashSlot)}super.draw(t),l.dragging&&(t.save(),t.globalAlpha=.8,t.fillStyle="white",t.font="16px bold sans-serif",t.textAlign="center",t.textBaseline="middle",t.fillText(l.draggingItem.name,J.position.x,J.position.y),t.restore())}}const vt=new bt;class X extends nt{constructor(t,e,s,i,a,n){super(t,e,s,i),this.text=a,this.onClick=n,this.hover=!1}draw(t){if(!this.visible)return;t.fillStyle=this.hover?"rgba(3,102,241,0.8)":"rgba(30,41,59,0.9)",t.strokeStyle="rgba(3,102,241,0.5)",t.lineWidth=2,t.beginPath();const e=8;t.moveTo(this.x+e,this.y),t.arcTo(this.x+this.width,this.y,this.x+this.width,this.y+this.height,e),t.arcTo(this.x+this.width,this.y+this.height,this.x,this.y+this.height,e),t.arcTo(this.x,this.y+this.height,this.x,this.y,e),t.arcTo(this.x,this.y,this.x+this.width,this.y,e),t.closePath(),t.fill(),t.stroke(),t.fillStyle="#f8fafc",t.font="16px Inter",t.textAlign="center",t.textBaseline="middle",t.fillText(this.text,this.x+this.width/2,this.y+this.height/2)}handleEvent(t){return this.visible?t.type==="mousemove"?(this.hover=this.contains(t.offsetX,t.offsetY),this.hover):t.type==="mouseup"&&this.contains(t.offsetX,t.offsetY)?(this.onClick?.(),!0):!1:!1}}class kt extends at{constructor(){super("pauseMenu"),this.menuWidth=300,this.menuHeight=300;const t=1440/2,e=720/2,s=200,i=50,a=20,n=e-60;this.addElement(new X(t-s/2,n,s,i,"ç»§ç»­æ¸¸æˆ",()=>E.resume())),this.addElement(new X(t-s/2,n+(i+a),s,i,"å­˜æ¡£",()=>{E.save()})),this.addElement(new X(t-s/2,n+2*(i+a),s,i,"è¿”å›žä¸»èœå•",()=>{window.location.href="menu.html"}))}draw(t){this.visible&&(t.fillStyle="rgba(30,41,59,0.8)",t.fillRect(80,0,1280,t.canvas.height),t.fillStyle="#f8fafc",t.font="20px Inter",t.textAlign="center",t.fillText("æš‚åœèœå•",t.canvas.width/2,t.canvas.height/2-100),super.draw(t))}}const Et=new kt;class F{static instance;constructor(){if(F.instance)return F.instance;F.instance=this,this.screens={},this.currentScreen=null,this.persistentScreens=new Set}addScreen(t,e=!1){this.screens[t.name]=t,e&&this.persistentScreens.add(t.name)}switchScreen(t){this.currentScreen&&!this.persistentScreens.has(this.currentScreen.name)&&this.currentScreen.hide(),this.currentScreen=this.screens[t],this.currentScreen?.show()}draw(t){for(let e of this.persistentScreens){const s=this.screens[e];s.visible&&s.draw(t)}this.currentScreen&&!this.persistentScreens.has(this.currentScreen.name)&&this.currentScreen.visible&&this.currentScreen.draw(t)}handleEvent(t){for(let e of this.persistentScreens){const s=this.screens[e];if(s.visible&&typeof s.handleEvent=="function"&&s.handleEvent(t))return}if(!(this.currentScreen&&typeof this.currentScreen.handleEvent=="function"&&this.currentScreen.handleEvent(t))&&t.type==="mouseup")return l.dragging=!1,l.draggingFrom=null,l.draggingItem=null,!0}}const M=new F,At=document.getElementById("ui-canvas");["mousemove","mousedown","mouseup"].forEach(r=>{At.addEventListener(r,t=>M.handleEvent(t))});M.addScreen(vt,!0);M.addScreen(Et);class R{constructor(){if(R.instance)return R.instance;R.instance=this,this.canvas_game=document.getElementById("game-canvas"),this.canvas_ui=document.getElementById("ui-canvas"),this.canvas_ui.addEventListener("contextmenu",e=>e.preventDefault()),this.canvas_ui.addEventListener("dragstart",e=>e.preventDefault()),this.ctx_game=this.canvas_game.getContext("2d"),this.ctx_ui=this.canvas_ui.getContext("2d"),this.currentHpPercent=1,this.isStop=!1,this.isPaused=!1,this.lastTime=0;const t=60;this.targetFrameTime=1e3/t,this.loop=this.loop.bind(this),this.statistics={portal:0,bullet:0,restart:0,jump:0,jumpTime:0}}async init(){await D.load(),await K.load();const t=localStorage.getItem("selected_slot"),e=Math.max(1,parseInt(t||"1",10)||1);this.currentSlotId=e;let s=!1;try{s=await R.loadGame(e)}catch{s=!1}if(s||(await g.loadRoom(0,3),console.log("ðŸŽ® æ¸¸æˆåˆå§‹åŒ–å®Œæˆï¼Œå½“å‰æˆ¿é—´: layer0/room3")),!s){const a=g.getPlayerSpawn();p.setPosition(new m(a.x,a.y))}f.on({event:u.player.hpPercent,handler:a=>{this.currentHpPercent=Math.max(0,Math.min(1,a))},priority:0}),f.on({event:u.game.tick,handler:({deltaTime:a})=>g.update(a,p),priority:.8}),f.on({event:u.game.tick,handler:({deltaTime:a})=>l.update(a),priority:1}),f.on({event:u.game.tick,handler:({deltaTime:a})=>y.update(a),priority:.7}),f.on({event:u.game.tick,handler:({deltaTime:a})=>p.update(a),priority:.5}),f.on({event:u.game.tick,handler:({deltaTime:a})=>this.enemies.forEach(n=>n.update(a)),priority:.3}),f.on({event:u.game.tick,handler:({deltaTime:a})=>q.update(a),priority:.1}),f.on({event:u.player.die,handler:()=>{this.stop(),window.location.href="menu.html"}}),f.on({event:u.interaction.trigger,handler:a=>this.handleInteraction(a),priority:0});const i=g.getEnemySpawns();if(this.enemies=[],Array.isArray(i))for(const a of i)this.enemies.push(new j(a.type,new m(a.x,a.y)));console.log("ðŸ‘¹ æ•Œäººåˆå§‹åŒ–å®Œæˆ:",{enemySpawnsCount:i?i.length:0,enemiesCount:this.enemies.length,enemyTypes:this.enemies.map(a=>a.type)}),l.tryAcquire(_.xqä¼‘æ†©),l.tryAcquire(_.yyå‹è°Š),l.tryAcquire(_.lsæœ—è¯µ),window.itemManager=l}draw(){const t=this.ctx_game;t.clearRect(0,0,this.canvas_game.width,this.canvas_game.height);const e=this.ctx_ui;e.clearRect(0,0,this.canvas_ui.width,this.canvas_ui.height),g.draw(t),q.draw(t),this.enemies.forEach(s=>s.draw(t)),p.draw(t),M.draw(e),this.drawVerticalHpBar(e)}drawVerticalHpBar(t){const e={x:35,y:200,width:30,totalHeight:500,bgColor:"#ff3333",fgColor:"#33ff33",borderColor:"#000000",textColor:"#ffffff",fontSize:"14px Arial",textRightAlign:50},s=Math.round(p.state.hp),i=Math.round(p.state.hp_max),a=Math.round(p.state.attack.atk);t.font=e.fontSize,t.fillStyle=e.textColor,t.textAlign="center",t.fillText("è¡€é‡ï¼š",e.textRightAlign,60),t.fillText(`${s}/${i}`,e.textRightAlign,80),t.fillText("æ”»å‡»åŠ›ï¼š",e.textRightAlign,110),t.fillText(`${a}`,e.textRightAlign,130),t.fillStyle=e.bgColor,t.fillRect(e.x,e.y,e.width,e.totalHeight),t.strokeStyle=e.borderColor,t.lineWidth=1,t.strokeRect(e.x,e.y,e.width,e.totalHeight);const n=e.totalHeight*this.currentHpPercent,o=e.y+(e.totalHeight-n);t.fillStyle=e.fgColor,t.fillRect(e.x,o,e.width,n)}start(t=0){this.loop(0)}loop(t){const e=t-this.lastTime;e>=this.targetFrameTime&&(w.update(),w.isFirstDown("Esc")&&this.switchPause(),E.enemies.length==0&&f.emit(u.game.battle.end),!this.isPaused&&!this.isStop&&f.emit(u.game.tick,{deltaTime:e}),this.draw()),this.lastTime=t-e%this.targetFrameTime,requestAnimationFrame(this.loop)}pause(){this.isPaused=!0,M.switchScreen("pauseMenu")}resume(){this.isPaused=!1,M.switchScreen()}switchPause(){this.isPaused?this.resume():this.pause()}stop(){this.isStop=!0}save(){const t=this.currentSlotId&&this.currentSlotId>0?this.currentSlotId:1;this.saveCurrentGame(t)}saveCurrentGame(t=1){const e={player:p.constructor.getSaveData(),enemies:this.enemies.map(i=>({type:i.type,position:i.hitbox.position,state:i.state,defeated:i.state.hp<=0})),layer:g.currentLayer,room:g.currentRoom,mapState:g.getMapState(),completedEvents:f.getCompletedEvents(),timestamp:new Date().toISOString()};try{JSON.stringify(e)}catch(i){return console.error("å­˜æ¡£æ•°æ®åºåˆ—åŒ–å¤±è´¥:",i),null}let s=null;try{s=JSON.parse(localStorage.getItem("present_data"))}catch{s=null,console.error("è¯»å–å­˜æ¡£æ•°æ®å¤±è´¥")}(!s||typeof s!="object")&&(s={saveSlots:[]}),s.saveSlots=s.saveSlots||[],s.saveSlots[t-1]=e;try{return localStorage.setItem("present_data",JSON.stringify(s)),console.log("å­˜æ¡£æˆåŠŸ:",e),e}catch(i){return console.error("å­˜æ¡£å†™å…¥å¤±è´¥:",i),null}}async loadGame(t=1){console.log("å¼€å§‹åŠ è½½å­˜æ¡£ï¼Œæ§½ä½:",t);let e=null;try{const i=localStorage.getItem("present_data");console.log("åŽŸå§‹å­˜æ¡£æ•°æ®:",i),e=JSON.parse(i)}catch(i){console.error("è§£æžå­˜æ¡£æ•°æ®å¤±è´¥:",i),e=null}if(!e?.saveSlots?.[t-1])return console.log("å­˜æ¡£æ§½ä½ä¸å­˜åœ¨:",t),!1;const s=e.saveSlots[t-1];console.log("å­˜æ¡£æ•°æ®å†…å®¹:",s),console.log(`åŠ è½½åœ°å›¾: layer${s.layer}/room${s.room}`),await g.loadRoom(s.layer,s.room);try{if(s.player?.position){const i=s.player.position;console.log("æ¢å¤çŽ©å®¶ä½ç½®:",i),p.setPosition(new m(i.x,i.y))}s.player?.state&&(console.log("æ¢å¤çŽ©å®¶çŠ¶æ€:",s.player.state),p.state=s.player.state),Array.isArray(s.enemies)&&(console.log("æ¢å¤æ•ŒäººçŠ¶æ€ï¼Œæ•°é‡:",s.enemies.length),this.enemies=s.enemies.map(i=>{const a=new j(i.type,new m(i.position.x,i.position.y));return i.state&&(a.state={...a.state,...i.state,attack:{...a.state.attack,...i.state.attack||{}}},a.state.hp=Math.min(a.state.hp,a.state.hp_max)),i.defeated&&(console.log(`æ•Œäºº ${i.type} å·²è¢«å‡»è´¥`),a.state.hp=0,a.state.isDefeated=!0),a})),s.mapState&&(console.log("æ¢å¤åœ°å›¾çŠ¶æ€:",s.mapState),g.restoreMapState(s.mapState)),Array.isArray(s.completedEvents)&&(console.log("æ¢å¤å·²å®Œæˆäº‹ä»¶:",s.completedEvents),f.restoreCompletedEvents(s.completedEvents))}catch(i){console.error("åŠ è½½å­˜æ¡£æ—¶å‡ºé”™:",i)}return console.log("å­˜æ¡£åŠ è½½å®Œæˆ"),!0}async handleInteraction(t){const{type:e,event:s,data:i}=t;console.log("ðŸŽ® äº¤äº’ç‚¹è§¦å‘:",{type:e,event:s,data:i});try{switch(e){case"next_room":case"exit":await this.handleRoomTransition(s,i);break;case"plot":case"teach":case"fire":case"sword":this.handlePlotEvent(s,i);break;case"npc":case"angel":this.handleNPCEvent(s,i);break;case"chest":this.handleChestEvent(s,i);break;case"hidden":this.handleHiddenRoomEvent(s,i);break;default:console.log("æœªå¤„ç†çš„äº¤äº’ç±»åž‹:",e,s)}}catch(a){console.error("å¤„ç†äº¤äº’äº‹ä»¶æ—¶å‡ºé”™:",a)}}async handleRoomTransition(t,e){console.log("ðŸšª æˆ¿é—´åˆ‡æ¢è§¦å‘:",t,e);const s=this.enemies.length>0,i=e.can_be_used_when==="battle_end"||s;if(console.log("ðŸ” åˆå§‹æ£€æŸ¥:",{hasEnemies:s,enemiesCount:this.enemies.length,requiresBattleEnd:i,explicitCondition:e.can_be_used_when==="battle_end"}),i){const x=this.enemies.filter(A=>A.state&&A.state.hp>0);if(console.log("ðŸ” æ£€æŸ¥æ•ŒäººçŠ¶æ€:",{totalEnemies:this.enemies.length,aliveEnemies:x.length,enemyHPs:this.enemies.map(A=>A.state?A.state.hp:"no state"),requiresBattleEnd:i,hasEnemies:s,explicitCondition:e.can_be_used_when==="battle_end"}),x.length>0){console.log("âš ï¸ è¿˜æœ‰æ•Œäººå­˜æ´»ï¼Œæ— æ³•åˆ‡æ¢æˆ¿é—´");return}}const a=g.currentLayer,n=g.currentRoom;let o=a,d=n+1;a===0?n>=4&&(o=1,d=1):a===1&&n>=1&&(o=0,d=1),console.log(`ðŸ”„ ä»Ž layer${a}/room${n} åˆ‡æ¢åˆ° layer${o}/room${d}`),await this.switchRoom(o,d)}async switchRoom(t,e){try{this.saveCurrentGame(this.currentSlotId),await g.loadRoom(t,e);const s=g.getPlayerSpawn();s&&p.setPosition(new m(s.x,s.y));const i=g.getEnemySpawns();if(this.enemies=[],Array.isArray(i))for(const a of i)this.enemies.push(new j(a.type,new m(a.x,a.y)));console.log("ðŸ‘¹ æ–°æˆ¿é—´æ•Œäººåˆå§‹åŒ–:",{layer:t,room:e,enemySpawnsCount:i?i.length:0,enemiesCount:this.enemies.length,enemyTypes:this.enemies.map(a=>a.type)}),console.log(`âœ… æˆåŠŸåˆ‡æ¢åˆ° layer${t}/room${e}`)}catch(s){console.error("æˆ¿é—´åˆ‡æ¢å¤±è´¥:",s)}}handlePlotEvent(t,e){console.log("å‰§æƒ…äº‹ä»¶è§¦å‘:",t,e)}handleNPCEvent(t,e){console.log("NPCäº‹ä»¶è§¦å‘:",t,e)}handleChestEvent(t,e){console.log("å®ç®±äº‹ä»¶è§¦å‘:",t,e)}handleHiddenRoomEvent(t,e){console.log("éšè—æˆ¿é—´äº‹ä»¶è§¦å‘:",t,e)}}const E=new R;window.onload=()=>{E.init().then(()=>{E.start()})};
