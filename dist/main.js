class L{constructor(){if(L.instance)return L.instance;L.instance=this}async loadJSON(t){const e=await fetch(t);if(!e.ok)throw new Error(`Failed to load JSON: ${t}`);return await e.json()}async loadImg(t){return new Promise((e,i)=>{const s=new Image;s.src=t,s.onload=()=>e(s),s.onerror=a=>i(new Error(`Failed to load image: ${t}`))})}}const it=new L;class P{constructor(){if(P.instance)return P.instance;P.instance=this}async load(){this.tempCanvas=document.querySelector("canvas#buffer"),this.texturesURL=await it.loadJSON("assets/imgs/Textures.json"),this.textures={};const t=new Map,e=[];for(const s of Object.keys(this.texturesURL))for(const a of Object.keys(this.texturesURL[s]))e.push(this.texturesURL[s][a]);const i=e.map(async s=>{const a=await fetch(s);if(!a.ok)throw new Error(`Failed to load image: ${s}`);const n=await a.blob(),o=await createImageBitmap(n);t.set(s,o)});await Promise.all(i);for(const s of Object.keys(this.texturesURL)){this.textures[s]={};for(const a of Object.keys(this.texturesURL[s]))this.textures[s][a]=t.get(this.texturesURL[s][a])}}getTexture(t,e="0"){return this.textures[t]&&this.textures[t][e]?this.textures[t][e]:null}}const C=new P;let d=class _{constructor(t=0,e=0){this.x=t,this.y=e}copy(){return new _(this.x,this.y)}getAxis(t){return t===0?this.x:this.y}add(t,e){return new _(this.x+t,this.y+e)}addVector(t){return this.add(t.x,t.y)}sub(t,e){return this.add(-t,-e)}subVector(t){return this.sub(t.x,t.y)}addEqual(t){return this.x+=t.x,this.y+=t.y,this}subEqual(t){return this.x-=t.x,this.y-=t.y,this}scale(t){return new _(this.x*t,this.y*t)}magnitude(){return Math.sqrt(this.x**2+this.y**2)}normalize(){const t=this.magnitude();return t===0?new _(0,0):new _(this.x/t,this.y/t)}dot(t){return this.x*t.x+this.y*t.y}rotate(t){const e=Math.cos(t),i=Math.sin(t),s=this.x*e-this.y*i,a=this.x*i+this.y*e;return new _(s,a)}angle(){return Math.atan2(this.y,this.x)}round(){return new _(Math.round(this.x),Math.round(this.y))}};class O{static instance;constructor(t){if(O.instance)return O.instance;O.instance=this,this.canvas=t,this.ctx=t.getContext("2d"),this.x=0,this.y=0,this.left=!1,this.right=!1,t.addEventListener("mousemove",e=>this.move(e)),t.addEventListener("mousedown",e=>this.down(e)),t.addEventListener("mouseup",e=>this.up(e)),window.addEventListener("blur",()=>this.onBlur()),window.addEventListener("focus",()=>this.onFocus())}move(t){const e=this.canvas.getBoundingClientRect();this.x=(t.clientX-e.left)*(this.canvas.width/e.width),this.y=(t.clientY-e.top)*(this.canvas.height/e.height),this.x=Math.max(0,Math.min(this.x,this.canvas.width)),this.y=Math.max(0,Math.min(this.y,this.canvas.height))}down(t){t.button===0&&(this.left=!0),t.button===2&&(this.right=!0)}up(t){t.button===0&&(this.left=!1),t.button===2&&(this.right=!1)}draw(t){t.drawImage(C.getTexture("cursor"),12,9,16,22,this.x-4,this.y-5,16,22)}get position(){return new d(this.x,this.y)}onBlur(){E.isPaused||(E.pause(),console.log("游戏已自动暂停（窗口失去焦点）")),this.left=!1,this.right=!1}onFocus(){console.log("窗口获得焦点")}}const tt=new O(document.getElementById("ui-canvas"));class H{status;KEYMAP=new Map([["ShiftLeft","LShift"],["ShiftRight","RShift"],["ControlLeft","LCtrl"],["ControlRight","RCtrl"],["AltLeft","LAlt"],["AltRight","RAlt"],["MetaLeft","LWin"],["MetaRight","RWin"],["Escape","Esc"],["F1","F1"],["F2","F2"],["F3","F3"],["F4","F4"],["F5","F5"],["F6","F6"],["F7","F7"],["F8","F8"],["F9","F9"],["F10","F10"],["F11","F11"],["F12","F12"],["Digit0","0"],["Digit1","1"],["Digit2","2"],["Digit3","3"],["Digit4","4"],["Digit5","5"],["Digit6","6"],["Digit7","7"],["Digit8","8"],["Digit9","9"],["KeyA","A"],["KeyB","B"],["KeyC","C"],["KeyD","D"],["KeyE","E"],["KeyF","F"],["KeyG","G"],["KeyH","H"],["KeyI","I"],["KeyJ","J"],["KeyK","K"],["KeyL","L"],["KeyM","M"],["KeyN","N"],["KeyO","O"],["KeyP","P"],["KeyQ","Q"],["KeyR","R"],["KeyS","S"],["KeyT","T"],["KeyU","U"],["KeyV","V"],["KeyW","W"],["KeyX","X"],["KeyY","Y"],["KeyZ","Z"],["ArrowUp","Up"],["ArrowDown","Down"],["ArrowLeft","Left"],["ArrowRight","Right"],["Home","Home"],["End","End"],["PageUp","Page Up"],["PageDown","Page Down"],["Enter","Enter"],["Space","Space"],["Backspace","Backspace"],["Tab","Tab"],["Delete","Delete"],["Insert","Insert"],["CapsLock","Caps Lock"],["NumLock","Num Lock"],["ScrollLock","Scroll Lock"],["Pause","Pause"],["PrintScreen","Print Screen"],["Numpad0","NUMPAD0"],["Numpad1","NUMPAD1"],["Numpad2","NUMPAD2"],["Numpad3","NUMPAD3"],["Numpad4","NUMPAD4"],["Numpad5","NUMPAD5"],["Numpad6","NUMPAD6"],["Numpad7","NUMPAD7"],["Numpad8","NUMPAD8"],["Numpad9","NUMPAD9"],["NumpadMultiply","Mul"],["NumpadAdd","Add"],["NumpadSubtract","Sub"],["NumpadDecimal","Dec"],["NumpadDivide","Div"],["ContextMenu","Apps"],["Help","Help"]]);constructor(){if(H.instance)return H.instance;H.instance=this,this.status=new Map,this.KEYMAP.forEach((t,e)=>{this.status.set(t,!1)}),document.addEventListener("keydown",t=>{const e=this.KEYMAP.get(t.code);this.status.has(e)&&this.status.set(e,!0)}),document.addEventListener("keyup",t=>{const e=this.KEYMAP.get(t.code);this.status.has(e)&&this.status.set(e,!1)}),addEventListener("keydown",t=>{t.preventDefault()})}isKeyDown(t){return this.status.get(t)||!1}isKeysDown(t){let e=!1;return t.forEach(i=>{e=e||this.isKeyDown(i)}),e}}const ut=new H;class dt{constructor(){this.mouse=tt,this.keyboard=ut,this.keyPrevState=new Map,this.keyCurrState=new Map}update(){[...this.keyboard.KEYMAP.values(),"ClickLeft","ClickRight"].forEach(e=>{this.keyPrevState.set(e,this.keyCurrState.get(e)||!1),this.keyCurrState.set(e,this.isKeyDown(e))})}isKeyDown(t){return t==="ClickLeft"?this.mouse.left:t==="ClickRight"?this.mouse.right:this.keyboard.isKeyDown(t)}isKeysDown(t){return t.some(e=>this.isKeyDown(e))}isAllKeysDown(t){return t.every(e=>this.isKeyDown(e))}isFirstDown(t){return this.keyCurrState.get(t)&&!this.keyPrevState.get(t)}isHeld(t){return this.keyCurrState.get(t)}isReleased(t){return!this.keyCurrState.get(t)&&this.keyPrevState.get(t)}}const p=new dt;class B{constructor(){if(B.instance)return B.instance;B.instance=this,this.backgroundMusic=null,this.audioPool=new Map,this.volume=1,this.masterVolume=1,this.sfxVolume=1,this.musicVolume=1,this.maxInstances=10,this.init()}handleClick=()=>{const t=new Audio;t.muted=!0,t.play().catch(()=>{}),document.removeEventListener("click",this.handleClick)};init(){document.addEventListener("click",this.handleClick),this.loadVolumeSettings()}setMasterVolume(t){this.masterVolume=Math.max(0,Math.min(1,t)),this.updateAllVolumes(),this.saveVolumeSettings()}setSfxVolume(t){this.sfxVolume=Math.max(0,Math.min(1,t)),this.updateAllVolumes(),this.saveVolumeSettings()}setMusicVolume(t){this.musicVolume=Math.max(0,Math.min(1,t)),this.updateAllVolumes(),this.saveVolumeSettings()}updateAllVolumes(){for(const[t,e]of this.audioPool.entries())e.forEach(i=>{i.volume=this.getEffectiveVolume(t)});this.backgroundMusic&&(this.backgroundMusic.volume=this.masterVolume*this.musicVolume)}getEffectiveVolume(t){const i=t.includes("music")||t.includes("bgm")?this.musicVolume:this.sfxVolume;return this.masterVolume*i}saveVolumeSettings(){try{const t={masterVolume:this.masterVolume,sfxVolume:this.sfxVolume,musicVolume:this.musicVolume};localStorage.setItem("soundSettings",JSON.stringify(t))}catch(t){console.warn("保存音量设置失败:",t)}}loadVolumeSettings(){try{const t=JSON.parse(localStorage.getItem("soundSettings"));t&&(this.masterVolume=t.masterVolume||1,this.sfxVolume=t.sfxVolume||1,this.musicVolume=t.musicVolume||1)}catch(t){console.warn("加载音量设置失败:",t)}}async load(){this.sounds={},this.soundsURL=await it.loadJSON("assets/audios/Sounds.json");for(const t of Object.keys(this.soundsURL)){this.sounds[t]={};for(const e of Object.keys(this.soundsURL[t])){const i=new Audio(this.soundsURL[t][e]);i.loop=!1,this.sounds[t][e]=i}}}async playSound(t,e=0,i={}){const s=`${t}_${e}`,a=this.sounds[t]&&this.sounds[t][e];if(!a)return;this.audioPool.has(s)||this.audioPool.set(s,[]);const n=this.audioPool.get(s);let o=n.find(l=>l.paused);if(!o&&n.length<this.maxInstances&&(o=a.cloneNode(),o.volume=i.volume||this.getEffectiveVolume(s),o.loop=i.loop||!1,n.push(o)),!o&&!i.force)return void 0;if(o||(o=n[0]),o){o.currentTime=0,o.volume=i.volume||this.getEffectiveVolume(s),o.loop=i.loop||!1;try{await o.play()}catch(l){console.error(`播放音效失败: ${s}`,l)}}}stopSound(t,e=0){const i=`${t}_${e}`,s=this.audioPool.get(i);s&&s.forEach(a=>{a.pause(),a.currentTime=0})}stopAllSounds(){for(const t of this.audioPool.values())t.forEach(e=>{e.pause(),e.currentTime=0})}cleanupAudioPool(){for(const[t,e]of this.audioPool.entries()){e.filter(s=>!s.paused);const i=e.filter(s=>s.paused);i.length>1&&i.slice(1).forEach(a=>{const n=e.indexOf(a);n>-1&&e.splice(n,1)})}}async playBackgroundMusic(t,e=0,i={}){const s=`${t}_${e}`,a=this.sounds[t]&&this.sounds[t][e];if(!a){console.warn(`背景音乐不存在: ${s}`);return}this.backgroundMusic&&await this.stopBackgroundMusic(i.fadeTime||1e3),this.backgroundMusic=a.cloneNode(),this.backgroundMusic.loop=i.loop!==!1,this.backgroundMusic.volume=0;try{await this.backgroundMusic.play(),i.fadeIn!==!1?await this.fadeIn(this.backgroundMusic,i.fadeTime||1e3):this.backgroundMusic.volume=this.masterVolume*this.musicVolume}catch(n){console.error(`播放背景音乐失败: ${s}`,n)}}async stopBackgroundMusic(t=1e3){if(this.backgroundMusic)try{t>0&&await this.fadeOut(this.backgroundMusic,t),this.backgroundMusic.pause(),this.backgroundMusic.currentTime=0,this.backgroundMusic=null}catch(e){console.error("停止背景音乐失败:",e)}}async fadeIn(t,e=1e3){const i=this.masterVolume*this.musicVolume,s=50,a=e/s,n=i/s;for(let o=0;o<s;o++)t.volume=n*(o+1),await new Promise(l=>setTimeout(l,a));t.volume=i}async fadeOut(t,e=1e3){const i=t.volume,s=50,a=e/s,n=i/s;for(let o=0;o<s;o++)t.volume=i-n*(o+1),await new Promise(l=>setTimeout(l,a));t.volume=0}}const v=new B,c={game:{tick:"GAME_TICK",battle:{start:"GAME_BATTLE_START",end:"GAME_BATTLE_END"},enter:{shop:"GAME_ENTER_SHOP"},finish:"GAME_FINISH"},item:{gain:"ITEM_GAIN",use:"ITEM_USE"},player:{die:"PLAYER_DIE",hpPercent:"PLAYER_HP_PERCENT",heal:"PLAYER_HEAL",dealDamage:"PLAYER_DEAL_DAMAGE",takeDamage:"PLAYER_TAKE_DAMAGE",fatelDmg:"PLAYER_FATEL_DAMAGE"},enemy:{die:"ENEMY_DIE"},boss:{},interaction:{trigger:"MAP_INTERACTION_TRIGGER"},dialog:{start:"DIALOG_START",end:"DIALOG_END"}};class V{constructor(){if(V.instance)return V.instance;V.instance=this,this.listeners=new Map,this.validEvents=new Set,this._completedEvents=new Set,this._initValidEvents(c)}_initValidEvents(t){for(const e in t)typeof t[e]=="object"?this._initValidEvents(t[e]):this.validEvents.add(t[e])}_checkEvent(t){this.validEvents.has(t)||console.warn(`[EventBus] 事件 "${t}" 不存在`)}on(t){const{event:e,handler:i,priority:s=0,maxCalls:a=1/0,onDispose:n=null,source:o=null}=t;this._checkEvent(e),this.listeners.has(e)||this.listeners.set(e,[]);const l=this.listeners.get(e),y={handler:i,priority:s,maxCalls:a,callCount:0,onDispose:n,source:o},b=l.findIndex(Y=>s>Y.priority);return b===-1?l.push(y):l.splice(b,0,y),()=>this.off(e,i)}off(t,e){this._checkEvent(t);const i=this.listeners.get(t);i&&this.listeners.set(t,i.filter(s=>s.handler===e?(s.onDispose&&s.onDispose(),!1):!0))}offBySource(t){for(const[e,i]of this.listeners.entries()){const s=i.filter(a=>a.source&&a.source===t?(a.onDispose&&a.onDispose(),!1):!0);s.length>0?this.listeners.set(e,s):this.listeners.delete(e)}}emit(t,e){this._checkEvent(t);const i=this.listeners.get(t);if(i)for(const s of[...i]){try{s.handler(e)}catch(a){console.error(`[EventBus] ${t} handler error`,a)}s.callCount++,s.callCount>=s.maxCalls&&this.off(t,s.handler)}}emitInterruptible(t,e){this._checkEvent(t);const i=this.listeners.get(t);if(!i)return!1;for(const s of[...i]){let a=!1;try{a=s.handler(e)===!0}catch(n){console.error(`[EventBus] ${t} handler error`,n)}if(s.callCount++,s.callCount>=s.maxCalls&&this.off(t,s.handler),a)return!0}return!1}emitReduce(t,e,i){this._checkEvent(t);const s=this.listeners.get(t);if(!s)return e;let a=e;for(const n of[...s]){try{const o=n.handler(a);o!==void 0&&(a=i(a,o))}catch(o){console.error(`[EventBus] ${t} handler error`,o)}n.callCount++,n.callCount>=n.maxCalls&&this.off(t,n.handler)}return a}getCompletedEvents(){return Array.from(this._completedEvents)}restoreCompletedEvents(t){Array.isArray(t)&&(this._completedEvents=new Set(t))}completeEvent(t){this._completedEvents.add(t)}isEventCompleted(t){return this._completedEvents.has(t)}}const m=new V;class M{constructor(t,e){this.position=t,this.size=e}add(t,e=new Vector(0,0)){return new M(t.addVector(this.position),e.addVector(this.size))}getCenter(){return this.position.addVector(this.size.scale(.5))}getTopLeft(){return this.position}getBottomRight(){return this.position.addVector(this.size)}contains(t){const e=this.getTopLeft(),i=this.getBottomRight();return t.x>=e.x&&t.x<=i.x&&t.y>=e.y&&t.y<=i.y}checkHit(t){const e=this.getTopLeft().x,i=this.getBottomRight().x,s=this.getTopLeft().y,a=this.getBottomRight().y,n=t.getTopLeft().x,o=t.getBottomRight().x,l=t.getTopLeft().y,y=t.getBottomRight().y;return!(i<=n||e>=o||s>=y||a<=l)}checkHits(t,e){for(let i of t)if(this.checkHit(i))return e(),i;return null}merge(t){let e=new Vector(Math.min(this.position.x,t.position.x),Math.min(this.position.y,t.position.y)),i=new Vector(Math.max(this.position.x+this.size.x,t.position.x+t.size.x),Math.max(this.position.y+this.size.y,t.position.y+t.size.y));return nt(e,i)}clip(t){let e=new Vector(Math.max(this.position.x,t.position.x),Math.max(this.position.y,t.position.y)),i=new Vector(Math.min(this.position.x+this.size.x,t.position.x+t.size.x),Math.min(this.position.y+this.size.y,t.position.y+t.size.y));return nt(e,i)}}const nt=(r,t)=>r.x>=t.x||r.y>=t.y?null:new M(r,t.subVector(r));class mt extends M{constructor(t,e,i){super(t,e),this.type=i}}class gt extends M{constructor(t,e,i,s,a={}){super(t,e),this.type=i,this.autoTrigger=!!s;for(const n in a)n!=="position"&&n!=="size"&&(this[n]=a[n]);this.__id=Math.random().toString(36).substr(2,9)}}class z{constructor(){if(z.instance)return z.instance;z.instance=this,this.backgrounds=[],this.blocks=[],this.textures=[],this.interactions=[],this.mapHitBox=new M(new d(0,0),new d(1280,720)),this._triggeredInteractionIds=new Set,this._completedEvents=new Set}async loadRoom(t,e){const i=`assets/stages/layer${t}/room${e}.json`;try{const s=await it.loadJSON(i);this.rawMapData=JSON.parse(JSON.stringify(s)),this.currentLayer=typeof t=="string"?parseInt(t,10):t,this.currentRoom=typeof e=="string"?parseInt(e,10):e,this.playerSpawn=s.playerSpawn?{...s.playerSpawn}:null,this.enemySpawns=Array.isArray(s.enemySpawns)?s.enemySpawns.map(n=>({...n})):[],this.backgrounds=(s.backgrounds||[]).map(n=>({...n})),this.blocks=(s.blocks||[]).map(n=>{const o=new d(n.position.x,n.position.y),l=new d(n.size.x,n.size.y);return new mt(o,l,n.type)}),this.textures=(s.textures||[]).map(n=>({...n}));const a=(s.interactions||[]).map(n=>{n.type==="dialog"&&(n.dialogs=n.dialogs||[]);const o=new d(n.position.x,n.position.y),l=new d(n.size.x,n.size.y);return new gt(o,l,n.type,n.autoTrigger,n)});this.interactions=[...a.filter(n=>n.autoTrigger),...a.filter(n=>!n.autoTrigger)],console.log("加载的交互点总数:",this.interactions.length),this.interactions.forEach((n,o)=>{console.log(`交互点${o+1}: type=${n.type}, position类型=${n.position.constructor.name}`)}),this._triggeredInteractionIds.clear(),console.log("🗺️ 加载交互点:",this.interactions.map(n=>({type:n.type,position:n.position,size:n.size,autoTrigger:n.autoTrigger,can_be_used_when:n.can_be_used_when,positionType:typeof n.position,sizeType:typeof n.size,hasAddVector:typeof n.position?.addVector})))}catch(s){console.error("MapManager.loadRoom error:",s)}}checkVectorType(){this.interactions.forEach((t,e)=>{t.position.constructor.name!=="Vector"&&console.error(`交互点${e}的position不是Vector！类型是：`,t.position.constructor.name)})}getPlayerSpawn(){return this.playerSpawn}getEnemySpawns(){return this.enemySpawns||[]}getBlockHitboxes(){return this.blocks||[]}getInteractionHitboxes(){return this.interactions||[]}update(t,e){try{if(!e||!this.interactions||this.interactions.length===0)return;const i=e.hitbox||e.getHitbox?.();if(!i)return;for(let s=0;s<this.interactions.length;s++){const a=this.interactions[s];if(!a)continue;const n=i.checkHit(a),o=this._triggeredInteractionIds.has(a.__id);if(n){if((a.type==="next_room"||a.type==="exit")&&console.log("🎯 玩家在传送点区域:",{type:a.type,playerPos:i.position,interactionPos:a.position,overlapping:n}),a.autoTrigger&&!o){this._triggeredInteractionIds.add(a.__id),m.emit(c.interaction.trigger,{type:a.type,event:a.event,data:a});continue}a.autoTrigger||p.isKeyDown("E")&&(console.log("🔑 E键按下，触发交互:",a.type,a.event),m.emit(c.interaction.trigger,{type:a.type,event:a.event,data:a}))}}}catch(i){console.error("MapManager.update error:",i),console.error("错误堆栈:",i.stack)}}draw(t){for(const e of this.backgrounds)this.drawItem(t,e,"background");for(const e of this.blocks)this.drawItem(t,e,"block");for(const e of this.textures)this.drawItem(t,e,"texture");for(const e of this.interactions)this.drawInteraction(t,e)}drawItem(t,e,i){t.save();let s=null,a=i+"s";s=C.getTexture(a,e.type),s?t.drawImage(s,e.position.x,e.position.y,e.size.x,e.size.y):(i==="background"?t.fillStyle="#e0e0e0":i==="block"?t.fillStyle="#654321":i==="texture"?t.fillStyle="#8888ff":t.fillStyle="#cccccc",t.fillRect(e.position.x,e.position.y,e.size.x,e.size.y)),t.restore()}drawInteraction(t,e){if(e.type!=="next_room"&&e.type!=="exit")return;t.save(),t.lineWidth=2;const i=this.enemySpawns&&this.enemySpawns.length>0,s=e.can_be_used_when==="battle_end"||i;s?t.strokeStyle="#ffaa00":t.strokeStyle="#00ff00",t.strokeRect(e.position.x,e.position.y,e.size.x,e.size.y),t.fillStyle="rgba(0, 0, 0, 0.7)",t.fillRect(e.position.x,e.position.y-25,e.size.x,20);let a="",n="#ffffff";s?(a="传送点 (需击败所有敌人)",n="#ffaa00"):(a="传送点 (按E键传送)",n="#00ff00"),t.fillStyle=n,t.font="12px Arial",t.textAlign="center",t.fillText(a,e.position.x+e.size.x/2,e.position.y-10),t.restore()}getMapState(){return{triggeredInteractions:Array.from(this._triggeredInteractionIds),completedEvents:Array.from(this._completedEvents),currentLayer:this.currentLayer,currentRoom:this.currentRoom}}restoreMapState(t){t.triggeredInteractions&&(this._triggeredInteractionIds=new Set(t.triggeredInteractions)),t.completedEvents&&(this._completedEvents=new Set(t.completedEvents))}completeEvent(t){this._completedEvents.add(t)}isEventCompleted(t){return this._completedEvents.has(t)}}const k=new z;class A{constructor(t=0){this.t=0,this.cd=t}start(){this.t=this.cd}tick(t){this.t=Math.max(0,this.t-t)}ready(){return this.t===0}reset(){this.t=0}set(t=0){this.cd=t}}class ft{constructor(t,e,i,s,a){this.baseJump=t,this.maxJump=e,this.gravity=i,this.coyoteTime=s,this.jumpBuffer=new A(a),this.jumpBufferTime=a,this.isJumping=!1,this.isFalling=!1,this.jumpVelocity=0,this.chargeTime=0,this.coyoteTimer=0,this.times=1}startJump(){this.isJumping=!0,this.isFalling=!1,this.chargeTime=0,this.jumpBuffer.reset(),this.coyoteTimer=0,v.playSound(this.type,"jump")}updateJump(t,e,i){this.jumpBuffer.tick(e),i?(this.coyoteTimer=this.coyoteTime,this.isJumping=!1,this.isFalling=!1,!i&2&&(this.jumpVelocity=0),i&2?this.times=1.5:this.times=1,this.jumpBuffer.ready()||this.startJump()):(this.isJumping||(this.isFalling=!0),this.coyoteTimer=Math.max(this.coyoteTimer-e,0),!this.isJumping&&!this.jumpBuffer.ready()&&this.coyoteTimer>0&&this.startJump()),this.isJumping?!this.isFalling&&t&&this.chargeTime<this.maxJump*this.times?(this.chargeTime+=e,this.jumpVelocity=Math.min(this.baseJump+this.chargeTime/this.maxJump*this.times*(this.maxJump*this.times-this.baseJump),this.maxJump*this.times)):(this.isFalling=!0,this.updateFalling(e)):this.isFalling&&this.updateFalling(e)}updateFalling(t){this.jumpVelocity-=this.gravity*t,this.jumpVelocity=Math.max(-6*this.baseJump,this.jumpVelocity)}}class W{constructor(t,e,i=new d){this.type="",this.velocity=i,this.hitbox=new M(t,e),this.jumping=new ft(4,9,.5,8,15),this.MaxSpeed=6,this.attackBox=null,this.hurtBox=null}getCenter(){return this.hitbox.getCenter()}isOnGround(){if(this.velocity.y<0)return!1;this.hitbox.position.y+=1;let t=!1;const e=k.getBlockHitboxes();return t=!!this.hitbox.checkHits(e,()=>{}),this.hitbox.position.y-=1,t&&(this.isflying=0),t}rigidMove(t){let e=this.velocity.scale(t).round(),i=0,s=k.getBlockHitboxes();for(let a=0;a<Math.abs(e.x);++a)if(this.hitbox.position.x+=Math.sign(e.x),this.hitbox.checkHits(s,()=>{this.hitbox.position.x-=Math.sign(e.x)})){i|=1;break}for(let a=0;a<Math.abs(e.y);++a)if(this.hitbox.position.y+=Math.sign(e.y),this.hitbox.checkHits(s,()=>{this.hitbox.position.y-=Math.sign(e.y)})){i|=2;break}return i}updateY(t,e){this.jumping.updateJump(e,t,this.isOnGround())}updateX(t,e){const i=this.isOnGround();let s=this.velocity.x;if(i){if(e===0)s*=Math.exp(-.5*t);else{const a=10*t;s=e*Math.min(Math.sqrt(this.velocity.x*this.velocity.x+a),this.MaxSpeed)}e&&v.playSound(this.type,"walk")}else{const a=.3*t;e!==0?(s+=a*(e*this.MaxSpeed-this.velocity.x),Math.abs(s)>this.MaxSpeed&&(s=this.MaxSpeed*Math.sign(s))):s*=Math.exp(-.05*t)}return s}updateXY(t,e,i){this.updateY(t,i()),this.velocity.y=-this.jumping.jumpVelocity,this.velocity.x=this.updateX(t,e());let s=this.rigidMove(t);s&1&&(this.velocity.x=0),s&2&&(this.velocity.y=this.jumping.jumpVelocity=0)}update(t){deltaFrame=60*t/1e3,this.updateXY(deltaFrame,()=>0,()=>0)}draw(t){t.fillStyle="rgba(221, 100, 0, 1)",t.fillRect(this.hitbox.position.x,this.hitbox.position.y,this.hitbox.size.x,this.hitbox.size.y)}}class pt extends W{constructor(t,e,i,s,a=new d(10,10)){super(t,a,e),this.type="projectile",this.damage=i,this.alive=!0,this.hurtBox=this.hitbox,this.from=s,X.add(this)}update(t){if(!this.alive)return;const e=60*t/1e3;if(this.rigidMove(e)){this.alive=!1;return}this.from.targetSelector().forEach(s=>{this.hurtBox.checkHit(s.hurtBox)&&(this.from.applyDamage(s,this.damage),this.alive=!1)})}draw(t){this.alive&&(t.fillStyle="yellow",t.fillRect(this.hitbox.position.x,this.hitbox.position.y,this.hitbox.size.x,this.hitbox.size.y))}}class F{constructor(){if(F.instance)return F.instance;F.instance=this,this.projectiles=[]}add(t){this.projectiles.push(t)}update(t){this.projectiles.forEach(e=>e.update(t)),this.projectiles=this.projectiles.filter(e=>e.alive)}draw(t){this.projectiles.forEach(e=>e.draw(t))}clear(){this.projectiles.length=0}}const X=new F;class yt{constructor(t=0){this.duration=t,this.remainingTime=0}start(t=null){t!==null&&(this.duration=t),this.remainingTime=this.duration}tick(t){this.remainingTime=Math.max(0,this.remainingTime-t)}expired(){return this.remainingTime<=0}reset(){this.remainingTime=0}remaining(){return this.remainingTime}set(t){this.duration=t}}const g={player:{ATK:"PLAYER_ATK",HP:"PLAYER_HP",SPD:"PLAYER_SPD",HEAL:"PLAYER_HEAL",DMG:"PLAYER_DMG",LOS:"PLAYER_LOS",TAKE_DMG:"PLAYER_TAKE_DAMAGE",DASH_CHARGE:"PLAYER_DASH_CHARGE",AttackStartupTime:"PLAYER_AttackStartupTime",AttackRecoveryTime:"PLAYER_AttackRecoveryTime",MeteeStartupTime:"PLAYER_MeteeStartupTime",MeteeRecoveryTime:"PLAYER_MeteeRecoveryTime",RangedStartupTime:"PLAYER_RangedStartupTime",RangedRecoveryTime:"PLAYER_RangedRecoveryTime"},enemy:{ATK:"ENEMY_ATK",HP:"ENEMY_HP",DMG:"ENEMY_DMG",DMG_DEC:"ENEMY_DMG_DEC",AttackStartupTime:"ENEMY_AttackStartupTime",AttackRecoveryTime:"ENEMY_AttackRecoveryTime",MeteeStartupTime:"ENEMY_MeteeStartupTime",MeteeRecoveryTime:"ENEMY_MeteeRecoveryTime",RangedStartupTime:"ENEMY_RangedStartupTime",RangedRecoveryTime:"ENEMY_RangedRecoveryTime"},boss:{ATK:"BOSS_ATK",HP:"BOSS_HP",AttackStartupTime:"BOSS_AttackStartupTime",AttackRecoveryTime:"BOSS_AttackRecoveryTime",MeteeStartupTime:"BOSS_MeteeStartupTime",MeteeRecoveryTime:"BOSS_MeteeRecoveryTime",RangedStartupTime:"BOSS_RangedStartupTime",RangedRecoveryTime:"BOSS_RangedRecoveryTime"}};class K{constructor(){if(K.instance)return K.instance;K.instance=this,this.attributes={},this.validAttributes=new Set,this._initValidAttributes(g)}_initValidAttributes(t){for(const e in t)typeof t[e]=="object"?this._initValidAttributes(t[e]):this.validAttributes.add(t[e])}_checkAttr(t){const e=this.validAttributes.has(t);return e||console.warn(`[AttributeManager] 属性 "${t}" 不存在`),e}addAttr(t,e,i,s=null,a=null){if(!this._checkAttr(t))return;this.attributes[t]||(this.attributes[t]={}),this.attributes[t][i]||(this.attributes[t][i]=[]);const n=this.attributes[t][i];for(;a&&n.length>=a;)n.shift();const o=s!==null?new yt(s):null;o&&o.start(s),n.push({value:e,timer:o})}removeAttrBySource(t,e){this.attributes[t]&&delete this.attributes[t][e]}removeOneAttrLayer(t,e){if(!this._checkAttr(t)||!this.attributes[t]||!this.attributes[t][e])return!1;const i=this.attributes[t][e];return i.length===0?!1:(i.shift(),i.length===0&&delete this.attributes[t][e],!0)}removeAllAttrBySource(t){for(const e of Object.keys(this.attributes))this.attributes[e][t]&&delete this.attributes[e][t]}refreshAttrDuration(t,e,i){if(this._checkAttr(t)&&!(!this.attributes[t]||!this.attributes[t][e]))for(const s of this.attributes[t][e])s.timer&&s.timer.start(i)}getAttrSum(t){if(!this._checkAttr(t)||!this.attributes[t])return 0;let e=0;for(const i of Object.keys(this.attributes[t])){const s=this.attributes[t][i];e+=s.reduce((a,n)=>a+n.value,0)}return e}getAttrStackCount(t,e){return!this._checkAttr(t)||!this.attributes[t]||!this.attributes[t][e]?0:this.attributes[t][e].length}getAllAttrByType(t){const e={};for(const i of Object.keys(t)){const s=t[i];e[s]=this.getAttrSum(s)}return e}getAllAttr(){const t={};for(const e of Object.keys(this.attributes))t[e]=this.getAttrSum(e);return t}update(t){for(const e of Object.keys(this.attributes))for(const i of Object.keys(this.attributes[e])){const s=this.attributes[e][i];for(const a of s)a.timer&&a.timer.tick(t);this.attributes[e][i]=s.filter(a=>!a.timer||!a.timer.expired()),this.attributes[e][i].length===0&&delete this.attributes[e][i]}}}const x=new K;class st{constructor(t,e){this.owner=t,this.type=e,this.state="idle",this.timer=0}get damage(){return this.owner.state.attack.damage[this.type]}get startupTime(){return this.owner.state.attack.startupTime[this.type]}get recoveryTime(){return this.owner.state.attack.recoveryTime[this.type]}get targetSelector(){return this.owner.attack.targetSelector}trigger(){return this.state==="idle"?(this.state="startup",this.timer=this.startupTime,!0):!1}update(t){if(this.state!=="idle"&&(this.timer-=t,!(this.timer>0)))switch(this.state){case"startup":this.enterActive();break;case"active":this.enterRecovery();break;case"recovery":this.state="idle";break}}enterActive(){this.state="active",v.playSound(this.owner.type,this.type+"Attack"),this.onHit(this.owner,this.damage)}enterRecovery(){this.state="recovery",this.timer=this.recoveryTime}applyDamage(t,e){if(t.beforeTakeDamage&&!t.beforeTakeDamage())return;let i=e;this.owner.dealDamageEvent&&(i=m.emitReduce(this.owner.dealDamageEvent,{baseDamage:i},(s,a)=>a).baseDamage),t.takeDamage(i,this.type,this.owner)}onHit(t,e){}}class rt extends st{constructor(t){super(t,"melee")}onHit(t,e){const s=t.facing>0?t.hitbox.size.x/2:-t.hitbox.size.x/2,a=t.hitbox.position.addVector(new d(s,t.hitbox.size.y*.25)),n=new d(t.hitbox.size.x*.8,t.hitbox.size.y*.5),o=new M(a,n);this.targetSelector().forEach(l=>{o.checkHit(l.hurtBox)&&this.applyDamage(l,e)})}}class ht extends st{constructor(t){super(t,"ranged")}onHit(t,e){const s=t.facing,a=t.hitbox.getCenter();new pt(a,new d(12*s,0),e,this)}}class kt{constructor(){this.createDialogDOM(),this.buffer=[],this.printing=!1,this.triggeredEvents=new Set,this.CTRL_KEYS=["LCtrl","RCtrl"],this.isActive=!1,m.on({event:c.interaction.trigger,handler:this.handleInteraction.bind(this),priority:0})}createDialogDOM(){const t=document.createElement("div");t.className="dialogue-container",t.id="dialogue-container",t.style.cssText=`
            display: none;
            position: fixed;
            left: 50%;
            bottom: 50px;
            transform: translateX(-50%);
            width: 700px;
            height: 200px;
            background-color: black;
            border: 2px solid white;
            border-radius: 4px;
            padding: 25px;
            box-sizing: border-box;
            color: white;
            font-family: Arial, sans-serif;
            z-index: 100; /* 确保在游戏画面上层 */
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        `;const e=document.createElement("div");e.className="character-name",e.id="character-name",e.style.cssText=`
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 8px;
        `;const i=document.createElement("div");i.className="text-container",i.id="text-container",i.style.cssText=`
            height: calc(100% - 26px); /* 预留名字高度 */
            overflow: hidden;
            position: relative;
        `;const s=document.createElement("p");s.className="text-content",s.id="text-content",s.style.cssText=`
            font-size: 16px;
            line-height: 22px;
            margin: 0;
        `;const a=document.createElement("div");a.className="prompt-text",a.id="prompt-text",a.style.cssText=`
            position: absolute;
            bottom: 5px;
            right: 5px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            display: none;
        `,a.textContent="按 Ctrl 继续",i.appendChild(s),i.appendChild(a),t.appendChild(e),t.appendChild(i),(document.getElementById("game")||document.body).appendChild(t),this.dialog=t,this.charName=e,this.textContent=s,this.promptText=a}handleInteraction(t){if(["plot","teach"].includes(t.type)&&t.data?.dialogs?.length){if(t.data.autoTrigger&&t.data.event){if(this.triggeredEvents.has(t.data.event))return;this.triggeredEvents.add(t.data.event)}this.startDialog(t.data.dialogs)}}startDialog(t){t&&t.length>0&&!this.printing&&(this.buffer=t,this.printing=!0,this.open().then(()=>this._printDialogLines()))}open(){return new Promise(t=>{this.charName.innerHTML="",this.textContent.innerHTML="",this.promptText.style.display="none",this.isActive=!0,this.dialog.style.display="block",setTimeout(()=>{this.dialog.style.opacity="1",setTimeout(t,300)},10)})}close(){return new Promise(t=>{this.dialog.style.opacity="0",setTimeout(()=>{this.dialog.style.display="none",this.printing=!1,this.isActive=!1,t()},300)})}async _printDialogLines(){for(let t=0;t<this.buffer.length;t++){if(!this.printing)return;const e=this.buffer[t],i=typeof e=="string"?e:e.text||"",s=typeof e=="object"?e.speaker:"";if(s){let a=s;this.charName.innerHTML=a}else this.charName.innerHTML="";this.textContent.innerHTML="",this.promptText.style.display="none";for(const a of i){if(!this.printing)return;const n=document.createElement("span");if(n.textContent=a,this.textContent.appendChild(n),p.isKeysDown(this.CTRL_KEYS)){await new Promise(o=>setTimeout(o,10));continue}await new Promise(o=>setTimeout(o,50))}this.promptText.style.display="block",await new Promise(a=>{const n=()=>{p.isKeysDown(this.CTRL_KEYS)?a():requestAnimationFrame(n)};n()}),this.promptText.style.display="none"}await this.close(),m.emit(c.dialog.end)}clear(){this.buffer=[],this.printing=!1,this.isActive=!1,this.close()}}const S=new kt;class J{static Framerate={dash:4,stand:4,melee:6,ranged:6,block:5};static Frames={dash:4,stand:4,melee:6,ranged:6,block:5};constructor(){this.status="stand",this.facing=1,this.frame=1,this.frameRun=0}setStatus(t,e){(t!=this.status||e!=this.facing)&&(this.frame=1,this.frameRun=0,this.status=t,this.facing=e)}update(t){this.frameRun+=t;const e=1e3/J.Framerate[this.status];this.frameRun>e&&(this.frame++,this.frameRun=0);const i=J.Frames[this.status];if(this.frame>i)switch(this.status){case"run":case"stand":case"ranged":case"block":this.frame=1;break;case"melee":this.frame=i;break;default:this.frame=i-1;break}else this.frame<1&&(this.frame=1)}getFrame(){let t;switch(this.status){case"dash":t=`dash_${this.frame}`;break;case"melee":t=`melee_${this.frame}`;break;case"ranged":t=`ranged_${this.frame}`;break;case"block":t=`block_${this.frame}`;break;case"stand":t=`stand_${this.frame}`;break;case"run":t="0";break;case"jump":case"fall":t="0";break;default:t="stand_1";break}return C.getTexture("player",t)}}class G extends W{static getSaveData(){return{position:this.instance.hitbox.position,state:this.instance.state,inventory:[],timestamp:new Date().toISOString()}}static loadSaveData(t){this.instance&&(this.instance.hitbox.position=t.position,this.instance.state=t.state)}constructor(t=new d(50,50)){if(G.instance)return G.instance;super(new d,t,new d),G.instance=this,this.size=t,this.type="player",this.jumping.type="player",this.isMeleeAttacking=!1,this.isRangedAttacking=!1,this.isRangedHolding=!1,this.rangedLoopCooldown=new A(0),this.isBlocking=!1,this.isParrying=!1,this.isInRecovery=!1,this.blockStartTime=0,this.blockCooldown=new A(0),this.recoveryCooldown=new A(0),this.blockMove=!1,this.baseState={hp_max:100,attack:{atk:10,MeleeStartupTime:50,MeleeRecoveryTime:900,RangedStartupTime:150,RangedRecoveryTime:700,RangedLoopInterval:850},dash_cooldownTime:600,dash_maxCount:1,block:{parryWindow:200,recoveryTime:300,damageReduction:.5,parryDamageMultiplier:1.5}},this.state={hp:this.baseState.hp_max,hp_max:this.baseState.hp_max,attack:{atk:this.baseState.attack.atk,damage:{melee:this.baseState.attack.atk,ranged:this.baseState.attack.atk},startupTime:{melee:this.baseState.attack.MeleeStartupTime,ranged:this.baseState.attack.RangedStartupTime},recoveryTime:{melee:this.baseState.attack.MeleeRecoveryTime,ranged:this.baseState.attack.RangedRecoveryTime},loopInterval:this.baseState.attack.RangedLoopInterval},block:{parryWindow:this.baseState.block.parryWindow,recoveryTime:this.baseState.block.recoveryTime,damageReduction:this.baseState.block.damageReduction,parryDamageMultiplier:this.baseState.block.parryDamageMultiplier}},this.attack={targetSelector:()=>E.enemies,melee:new rt(this),ranged:new ht(this)},this.facing=1,this.animation=new J,this.initDash(),this.hurtBox=this.hitbox,this.controllerX=()=>{if(this.blockMove||this.isInRecovery)return 0;let e=p.isKeysDown(["A","Left"]),i=p.isKeysDown(["D","Right"]),s=0;return e&&i?s=0:e?this.facing=s=-1:i&&(this.facing=s=1),s},this.controllerY=()=>this.blockMove?0:(p.isFirstDown("Space")&&this.jumping.jumpBuffer.start(),p.isHeld("Space")),this.dealDamageEvent=c.player.dealDamage,this.initMeleeAttackListener(),this.initRangedAttackListener(),this.rangedLoopCooldown.set(this.state.attack.loopInterval),this.initBlockSystem()}initMeleeAttackListener(){const t=this.attack.melee;t.startupCooldown||(t.startupCooldown=new A(0)),t.recoveryCooldown||(t.recoveryCooldown=new A(0));const e=t.trigger.bind(t);t.trigger=()=>{this.isMeleeAttacking=!0,t.startupCooldown.set(this.state.attack.startupTime.melee),t.startupCooldown.start(),setTimeout(()=>{this.isMeleeAttacking=!1},this.state.attack.startupTime.melee+this.state.attack.recoveryTime.melee),e(),v.playSound("player","melee")},m.on({event:c.dialog.start,handler:()=>{this.blockMove=!0,this.isRangedHolding=!1,this.isRangedAttacking=!1,this.isMeleeAttacking=!1,this.isBlocking=!1,this.isParrying=!1,this.isInRecovery=!1,this.dash.isDashing=!1},priority:0}),m.on({event:c.dialog.end,handler:()=>{this.blockMove=!1,this.isRangedHolding=!1,this.isRangedAttacking=!1,this.isMeleeAttacking=!1,this.isBlocking=!1,this.isParrying=!1,this.isInRecovery=!1,this.rangedLoopCooldown.reset()},priority:0})}initRangedAttackListener(){const t=this.attack.ranged;t.startupCooldown||(t.startupCooldown=new A(0)),t.recoveryCooldown||(t.recoveryCooldown=new A(0));const e=t.trigger.bind(t);t.trigger=()=>{S.isActive||(this.isRangedAttacking=!0,t.startupCooldown.set(this.state.attack.startupTime.ranged),t.startupCooldown.start(),setTimeout(()=>{this.isRangedHolding||(this.isRangedAttacking=!1)},this.state.attack.startupTime.ranged+this.state.attack.recoveryTime.ranged),e(),v.playSound("player","ranged"))}}initBlockSystem(){this.blockCooldown.set(0),this.recoveryCooldown.set(this.state.block.recoveryTime)}updateBlockInput(t){if(S.isActive)return;const e=Date.now();p.isFirstDown("U")&&!this.isInRecovery&&!this.isBlocking&&this.startBlocking(e),p.isReleased("U")&&this.isBlocking&&this.stopBlocking(),this.isBlocking&&this.updateBlockingState(e),this.isInRecovery&&this.updateRecoveryState(t)}startBlocking(t){this.isBlocking=!0,this.isParrying=!0,this.blockStartTime=t,console.log(`开始格挡 - 进入弹反窗口 (${this.state.block.parryWindow}ms)`)}stopBlocking(){this.isBlocking&&(this.isBlocking=!1,this.isParrying=!1,this.startRecovery(),console.log("停止格挡 - 进入后摇"))}updateBlockingState(t){const e=t-this.blockStartTime;e>=this.state.block.parryWindow&&this.isParrying&&(this.isParrying=!1,console.log(`弹反窗口结束 - 进入格挡状态 (经过${e}ms)`))}startRecovery(){this.isInRecovery=!0,this.recoveryCooldown.start()}updateRecoveryState(t){if(this.recoveryCooldown.tick(t),p.isFirstDown("Space")&&this.isInRecovery){this.cancelRecovery();return}this.recoveryCooldown.ready()&&(this.isInRecovery=!1,console.log("后摇结束"))}cancelRecovery(){this.isInRecovery=!1,this.recoveryCooldown.reset(),console.log("跳跃取消后摇")}isAttackFromFront(t){if(!t||!t.hitbox)return!1;const e=t.hitbox.getCenter().x,i=this.hitbox.getCenter().x;return this.facing>0?e>i:e<i}update(t){if(S.isActive){this.animation.setStatus("stand",this.facing),this.animation.update(t);return}this.updateState(),m.emit(c.player.hpPercent,this.state.hp/this.state.hp_max),p.isHeld("L")&&!this.isMeleeAttacking&&!this.isBlocking?this.isRangedHolding=!0:(this.isRangedHolding=!1,this.isRangedAttacking=!1,this.rangedLoopCooldown.reset()),this.isRangedHolding&&(this.rangedLoopCooldown.tick(t),this.rangedLoopCooldown.ready()&&this.animation.frame===1&&(this.attack.ranged.trigger(),this.rangedLoopCooldown.start())),this.updateBlockInput(t),!S.isActive&&p.isKeyDown("J")&&!this.isInRecovery&&!this.isBlocking&&this.attack.melee.trigger(),this.attack.melee.update(t),this.attack.ranged.update(t),this.dash.update(t);const e=60*t/1e3;let i=this.controllerX();this.updateXY(e,i,this.controllerY()),this.isMeleeAttacking?this.animation.setStatus("melee",this.facing):this.isRangedHolding||this.isRangedAttacking?this.animation.setStatus("ranged",this.facing):this.isBlocking||this.isParrying?this.animation.setStatus("block",this.facing):this.dash.isDashing?this.animation.setStatus("dash",this.facing):this.jumping.jumpVelocity>0?this.animation.setStatus("jump",this.facing):this.isOnGround()?i!==0&&!this.isInRecovery?this.animation.setStatus("run",this.facing):this.animation.setStatus("stand",this.facing):this.jumping.jumpVelocity<0&&this.animation.setStatus("fall",this.facing),this.animation.update(t)}updateXY(t,e,i){this.dash.isDashing||(this.updateY(t,i),this.velocity.y=-this.jumping.jumpVelocity,this.velocity.x=this.updateX(t,e));let s=this.rigidMove(t);s&1&&(this.velocity.x=0,this.dash.isDashing=0),s&2&&(this.velocity.y=this.jumping.jumpVelocity=0)}updateState(){const t=x.getAttrSum(g.player.HP),e=x.getAttrSum(g.player.ATK),i=x.getAttrSum(g.player.DMG),s=x.getAttrSum(g.player.MeteeStartupTime),a=x.getAttrSum(g.player.MeteeRecoveryTime),n=x.getAttrSum(g.player.RangedStartupTime),o=x.getAttrSum(g.player.RangedRecoveryTime),l=x.getAttrSum(g.player.DASH_CHARGE);this.state.hp_max=this.baseState.hp_max*(1+t),this.state.hp=Math.min(this.state.hp,this.state.hp_max),this.state.attack.atk=this.baseState.attack.atk*(1+e),this.state.attack.damage.melee=this.state.attack.atk*(1+i),this.state.attack.damage.ranged=this.state.attack.atk*(1+i),this.state.attack.startupTime.melee=this.baseState.attack.MeleeStartupTime+s,this.state.attack.startupTime.ranged=this.baseState.attack.RangedStartupTime+n,this.state.attack.recoveryTime.melee=this.baseState.attack.MeleeRecoveryTime+a,this.state.attack.recoveryTime.ranged=this.baseState.attack.RangedRecoveryTime+o,this.dash.dashCooldownTime=this.baseState.dash_cooldownTime*(1-l),this.dash.dashCooldown.set(this.dash.dashCooldownTime),this.rangedLoopCooldown.set(this.state.attack.loopInterval)}initDash(){this.dash={isDashing:!1,dashDuration:200,dashCooldownTime:this.baseState.dash_cooldownTime,dashSpeed:15,dashDir:{x:1,y:0},dashDurationCooldown:null,dashCooldown:null,dashMaxCount:this.baseState.dash_maxCount,dashCount:0,update:null},this.dash.dashDurationCooldown=new A(this.dash.dashDuration),this.dash.dashCooldown=new A(this.dash.dashCooldownTime),this.dash.update=t=>{if(S.isActive){this.dash.isDashing=!1;return}this.isOnGround()&&(this.dash.dashCooldown.tick(t),this.dash.dashCooldown.ready()&&this.dash.dashCount<this.dash.dashMaxCount&&(this.dash.dashCount++,this.dash.dashCooldown.start()));let e=0,i=0;if(p.isKeysDown(["A","Left"])&&(e-=1),p.isKeysDown(["D","Right"])&&(e+=1),p.isKeysDown(["W","Up"])&&(i-=1),p.isKeysDown(["S","Down"])&&(i+=1),!this.dash.isDashing&&this.dash.dashCount>0&&p.isKeyDown("K")&&!this.isInRecovery){e===0&&i===0&&(e=this.facing);let s=Math.sqrt(e*e+i*i);s===0&&(s=1),this.dash.dashDir={x:e/s,y:i/s},this.dash.isDashing=!0,this.dash.dashDurationCooldown.start(),this.dash.dashCount--,v.playSound("player","dash")}this.dash.isDashing&&(this.dash.dashDurationCooldown.tick(t),this.velocity.x=this.dash.dashSpeed*this.dash.dashDir.x,this.velocity.y=this.dash.dashSpeed*this.dash.dashDir.y,this.dash.dashDurationCooldown.ready()&&(this.dash.isDashing=!1,this.jumping.jumpVelocity=-this.velocity.y))}}beforeTakeDamage(t,e=null){return this.dash.isDashing!==!0}takeDamage(t,e,i=null){if(this.isBlocking&&i&&this.isAttackFromFront(i))if(this.isParrying){this.performParry(i),console.log("弹反成功！");return}else t=t*this.state.block.damageReduction,console.log(`格挡成功，伤害减免至: ${t}`);let s=m.emitReduce(c.player.takeDamage,{baseDamage:t},(a,n)=>n).baseDamage;this.state.hp-=s,this.state.hp<=0&&(m.emit(c.player.die),alert("你死了"))}performParry(t){if(console.log("执行弹反攻击！"),S.isActive)return;const e=this.state.attack.startupTime.melee,i=this.state.attack.recoveryTime.melee;this.state.attack.startupTime.melee=0,this.state.attack.recoveryTime.melee=0;const s=this.state.attack.damage.melee;this.state.attack.damage.melee*=this.state.block.parryDamageMultiplier,this.attack.melee.trigger(),setTimeout(()=>{this.state.attack.startupTime.melee=e,this.state.attack.recoveryTime.melee=i,this.state.attack.damage.melee=s},50),v.playSound("player","parry")}takeHeal(t,e=null){let i=t*(1+x.getAttrSum(g.player.HEAL));i=m.emitReduce(c.player.heal,{baseHeal:i},(a,n)=>n).baseHeal;const s=Math.max(0,i);this.state.hp=Math.min(this.state.hp_max,this.state.hp+s)}setPosition(t){this.hitbox.position=t}draw(t){const e=this.animation.getFrame();if(!e)return;const i=this.hitbox.position.x,s=this.hitbox.position.y;let a=this.size.x,n=this.size.y;if(this.animation.status==="block"){a=this.size.x*1.640625,n=this.size.y*1.640625;const l=(a-this.size.x)/2,y=(n-this.size.y)/2,b=i-l,Y=s-y;t.save(),this.animation.facing===-1?(t.translate(b+a,Y),t.scale(-1,1),t.drawImage(e,0,0,a,n)):t.drawImage(e,b,Y,a,n),t.restore()}else t.save(),this.animation.facing===-1?(t.translate(i+a,s),t.scale(-1,1),t.drawImage(e,0,0,a,n)):t.drawImage(e,i,s,a,n),t.restore();this.drawDashUI(t)}drawBoxs(t){t.strokeStyle=this.isInvulnerable?"#cccccc":"#00aaff",t.strokeRect(this.hitbox.position.x,this.hitbox.position.y,this.hitbox.size.x,this.hitbox.size.y),t.strokeStyle="#ff0000";const e=.5*(this.facing>=0?this.hitbox.size.x:-this.hitbox.size.x),i=this.hitbox.position.addVector(new d(e,this.hitbox.size.y*.2)),s=new d(this.hitbox.size.x*.8,this.hitbox.size.y*.5);t.strokeRect(i.x,i.y,s.x,s.y),t.restore()}drawDashUI(t){const e=this.dash.dashMaxCount,i=this.dash.dashCount,s=8,a=4,n=this.hitbox.position.x+this.size.x/2-(e*(s+a)-a)/2,o=this.hitbox.position.y-12;for(let l=0;l<e;l++)t.fillStyle=l<i?"cyan":"gray",t.fillRect(n+l*(s+a),o,s,s),t.strokeStyle="black",t.strokeRect(n+l*(s+a),o,s,s)}}const f=new G;class wt extends W{constructor(t,e,i,s,a={}){super(t,a.size||new d(10,10),e),this.type="enemy_projectile",this.damage=i,this.alive=!0,this.hurtBox=this.hitbox,this.from=s,this.color=a.color||"#ff6600",this.shape=a.shape||"rectangle",this.speed=a.speed||8,this.size=a.size||new d(10,10),X.add(this)}update(t){if(!this.alive)return;const e=60*t/1e3;if(this.rigidMove(e)){this.alive=!1;return}this.from.targetSelector().forEach(s=>{this.hurtBox.checkHit(s.hurtBox)&&(this.from.applyDamage(s,this.damage),this.alive=!1)})}draw(t){if(this.alive){if(t.save(),t.fillStyle=this.color,this.shape==="circle"){const e=this.hitbox.position.x+this.hitbox.size.x/2,i=this.hitbox.position.y+this.hitbox.size.y/2,s=Math.min(this.hitbox.size.x,this.hitbox.size.y)/2;t.beginPath(),t.arc(e,i,s,0,Math.PI*2),t.fill()}else t.fillRect(this.hitbox.position.x,this.hitbox.position.y,this.hitbox.size.x,this.hitbox.size.y);t.restore()}}}class xt extends st{constructor(t,e={}){super(t,"ranged"),this.config={projectileSpeed:e.projectileSpeed||8,projectileSize:e.projectileSize||new d(10,10),projectileColor:e.projectileColor||"#ff6600",projectileShape:e.projectileShape||"rectangle",damage:e.damage||15,cooldown:e.cooldown||2e3,...e},this.projectiles=[]}trigger(t={}){const e=t.direction||new d(this.owner.facing,0),i=t.speed||this.config.projectileSpeed,s=t.damage||this.config.damage,a=this.owner.hitbox.getCenter(),n=new d(e.x*i,e.y*i);new wt(a,n,s,this,{color:this.config.projectileColor,shape:this.config.projectileShape,size:this.config.projectileSize,speed:i})}update(t){}applyDamage(t,e){t&&typeof t.takeDamage=="function"&&t.takeDamage(e,"ranged",this.owner)}}const q={1:{defaultFrame:"1",hasAttackAnimation:!1,attackType:"ranged",rangedAttack:{range:500,cooldown:2e3,damage:12,projectileSpeed:6,projectileColor:"#ff4444",projectileSize:new d(8,8),projectileShape:"rectangle"}},2:{defaultFrame:"2",hasAttackAnimation:!1,attackType:"melee"},balingzhe:{defaultFrame:"balingzhe_1",hasAttackAnimation:!0,attackType:"melee",attack:{frames:5,framerate:8,duration:1e3,framePrefix:"balingzhe_attack_"}}};class vt{constructor(t){this.config=q[t]||q[1],this.enemyType=t,this.facing=1,this.isAttacking=!1,this.attackFrame=1,this.frameTimer=0,this.attackEndTime=0}setAttackState(t,e){this.config.hasAttackAnimation&&t?(this.isAttacking=!0,this.attackFrame=1,this.frameTimer=0,this.attackEndTime=Date.now()+this.config.attack.duration,this.facing=e):Date.now()>=this.attackEndTime&&(this.isAttacking=!1,this.facing=e)}update(t){if(!this.isAttacking||!this.config.hasAttackAnimation)return;const e=1e3/this.config.attack.framerate;for(this.frameTimer+=t;this.frameTimer>=e;)this.attackFrame++,this.frameTimer-=e,this.attackFrame>this.config.attack.frames&&(this.attackFrame=1)}getFrame(){if(this.isAttacking&&this.config.hasAttackAnimation){const t=`${this.config.attack.framePrefix}${this.attackFrame}`;return C.getTexture("enemy",t)||C.getTexture("enemy",this.config.defaultFrame)}return C.getTexture("enemy",this.config.defaultFrame)}}class Q extends W{constructor(t,e,i=new d(50,50),s=new d){super(e,i,s),this.Size=i,this.type="enemy"+t,this.enemytype=t,this.config=q[this.enemytype]||q[1],this.baseState={hp_max:100,attack:{atk:10,MeleeStartupTime:50,MeleeRecoveryTime:1500}},this.state={hp:this.baseState.hp_max,hp_max:this.baseState.hp_max,attack:{damage:{melee:this.baseState.attack.atk},startupTime:{melee:this.baseState.attack.MeleeStartupTime},recoveryTime:{melee:this.baseState.attack.MeleeRecoveryTime}}},this.facing=1,this.animation=new vt(this.enemytype),this.config.attackType==="ranged"&&this.config.rangedAttack?this.enemytype==="1"?this.attack={ranged:new xt(this,this.config.rangedAttack),targetSelector:()=>[f],isAttacking:!1,attackTimer:0,cooldownTimer:0,cooldownDuration:this.config.rangedAttack.cooldown,rangedCooldown:new A(this.config.rangedAttack.cooldown)}:this.attack={ranged:new ht(this),targetSelector:()=>[f],isAttacking:!1,attackTimer:0,cooldownTimer:0,cooldownDuration:this.config.rangedAttack.cooldown,rangedCooldown:new A(this.config.rangedAttack.cooldown)}:this.attack={melee:new rt(this),targetSelector:()=>[f],isAttacking:!1,attackTimer:0,cooldownTimer:0,cooldownDuration:2e3},this.hurtBox=this.hitbox,this._unbind_list=[]}update(t){this.updateState();const e=this.hitbox.getCenter(),i=f.hitbox.getCenter(),s=Math.abs(e.x-i.x),a=Math.abs(e.y-i.y),n=Math.sqrt(s**2+a**2);let o=!1,l="patrol";this.attack.cooldownTimer>0&&(this.attack.cooldownTimer-=t),this.config.attackType==="ranged"&&this.config.rangedAttack?a<150&&n<=this.config.rangedAttack.range?(l="attack",o=this.attack.cooldownTimer<=0):n>this.config.rangedAttack.range&&n<this.config.rangedAttack.range+200&&(l="approach"):Math.abs(a)<100&&s<400&&(l="attack",o=Math.random()<.15&&this.attack.cooldownTimer<=0),this.config.hasAttackAnimation?(o&&!this.attack.isAttacking&&(this.config.attackType==="ranged"&&this.attack.ranged?this.triggerRangedAttack():this.attack.melee.trigger(),this.attack.isAttacking=!0,this.attack.attackTimer=this.config.attack.duration||1e3,this.attack.cooldownTimer=this.attack.cooldownDuration),this.attack.isAttacking&&(this.attack.attackTimer-=t,this.attack.attackTimer<=0&&(this.attack.isAttacking=!1))):o&&(this.config.attackType==="ranged"&&this.attack.ranged?this.triggerRangedAttack():this.attack.melee.trigger(),this.attack.cooldownTimer=this.attack.cooldownDuration),this.config.attackType==="ranged"&&this.attack.ranged?this.attack.ranged.update(t):this.attack.melee.update(t),this.updateMovement(l),this.animation.setAttackState(this.attack.isAttacking,this.facing),this.animation.update(t)}updateMovement(t){const e=60*(E.deltaTime||16)/1e3;let i=0;const s=this.hitbox.getCenter().x,a=f.hitbox.getCenter().x;if(this.config.attackType==="ranged"&&this.config.rangedAttack){const n=Math.abs(s-a);switch(t){case"attack":this.facing=s<a?1:-1,n<this.config.rangedAttack.range*.7?i=-this.facing*.2:n>this.config.rangedAttack.range*.9?i=this.facing*.2:i=0;break;case"approach":this.facing=s<a?1:-1,i=this.facing*.25;break;default:Math.random()<.002&&(this.facing=Math.random()<.5?1:-1);const o=this.hitbox.position.x+this.facing*2,l=new M(new d(o,this.hitbox.position.y),this.hitbox.size);(k.getBlockHitboxes().some(b=>l.checkHit(b))||o<0||o>1280)&&(this.facing=-this.facing),i=this.facing*.15;break}}else if(t==="attack")this.facing=this.hitbox.position.x<f.hitbox.position.x?1:-1,i=this.facing*.3;else{Math.random()<.002&&(this.facing=Math.random()<.5?1:-1);const n=this.hitbox.position.x+this.facing*2,o=new M(new d(n,this.hitbox.position.y),this.hitbox.size);(k.getBlockHitboxes().some(y=>o.checkHit(y))||n<0||n>1280)&&(this.facing=-this.facing),i=this.facing*.2}this.updateXY(e,()=>i,()=>0,!0)}updateState(){const t=x.getAttrSum(g.enemy.HP),e=x.getAttrSum(g.enemy.ATK);this.state.hp_max=this.baseState.hp_max*(1+t),this.state.hp=Math.min(this.state.hp,this.state.hp_max),this.state.attack.damage.melee=this.baseState.attack.atk*(1+e),this.config.attackType==="ranged"&&this.config.rangedAttack&&(this.state.attack.damage.ranged=this.config.rangedAttack.damage*(1+e))}takeDamage(t){if(this.state.hp-=t,this.state.hp<=0){m.emit(c.enemy.die),this._unbind_list.forEach(i=>i());const e=E.enemies.indexOf(this);e!==-1&&E.enemies.splice(e,1)}}draw(t){const e=this.animation.getFrame();if(e){if(t.save(),this.facing===-1){const o=this.hitbox.position.x+this.Size.x;t.translate(o,this.hitbox.position.y),t.scale(-1,1),t.drawImage(e,0,0,this.Size.x,this.Size.y)}else t.drawImage(e,this.hitbox.position.x,this.hitbox.position.y,this.Size.x,this.Size.y);t.restore()}const i=this.Size.x,s=6,a=this.hitbox.position.x,n=this.hitbox.position.y-12;t.fillStyle="red",t.fillRect(a,n,i,s),t.fillStyle="green",t.fillRect(a,n,i*(this.state.hp/this.state.hp_max),s),t.strokeStyle="black",t.strokeRect(a,n,i,s),this.drawProjectiles(t)}triggerRangedAttack(){if(!this.attack.ranged)return;v.playSound("enemy","ranged_attack");const t=this.hitbox.getCenter().x<f.hitbox.getCenter().x?1:-1;this.enemytype==="1"&&this.attack.ranged.trigger?this.attack.ranged.trigger({direction:new d(t,0),speed:this.config.rangedAttack.projectileSpeed,damage:this.state.attack.damage.ranged}):this.attack.ranged.trigger({direction:new d(t,0),speed:this.config.rangedAttack.projectileSpeed,damage:this.state.attack.damage.ranged})}drawProjectiles(t){this.attack.ranged&&this.attack.ranged.projectiles&&this.attack.ranged.projectiles.forEach(e=>{t.save(),t.fillStyle=e.color||"#ff6600",t.beginPath(),t.arc(e.position.x,e.position.y,e.size||5,0,Math.PI*2),t.fill(),t.restore()})}}const h={NO_EXCHANGE:"noExcgange",NO_DROP:"noDrop",NO_RANDOM:"noRandom",SPECIAL_EXCHANGE:"specialExchange",ADD_SLOTS:"addSlots",UNIQUE_GLOBAL:"uniqueGlobal",UNIQUE_SINGLE:"uniqueSingle",MULTIPLE:"multiple"},w={ENDING:"end",NORMAL:"normal"},N={yy友谊:{name:"友谊",level:1,type:w.NORMAL,tags:[h.UNIQUE_GLOBAL,h.NO_EXCHANGE,h.NO_DROP,h.NO_RANDOM],effects:{[g.player.HP]:.25,[g.player.DMG]:.25,[g.boss.ATK]:.25,[g.boss.HP]:.3},hooks:r=>[{event:c.game.tick,handler:({deltaTime:t})=>r.state.healTimer.tick(t),priority:1},{event:c.player.hpPercent,handler:t=>{t<.25&&r.state.healTimer.ready()&&(r.state.healTimer.start(),f.takeHeal(f.state.hp_max*.01,r.id))}},{event:c.player.fatelDmg,handler:()=>(f.state.hp=f.state.hp_max,m.on({event:c.game.battle.end,handler:()=>{u.remove(r),u.tryAcquire(N.bc悲怆)},maxCalls:1}),!0),maxCalls:1},{event:c.game.finish,handler:t=>{t.unlockEnding?.("hidden_path_friendship",{desc:"使探索开启不同的方向"})},maxCalls:1}],onAcquire(r){},state:{healTimer:new A(1e3)}},bc悲怆:{name:"悲怆",level:1,type:w.NORMAL,tags:[h.UNIQUE_GLOBAL,h.NO_EXCHANGE,h.NO_DROP,h.NO_RANDOM],effects:{[g.player.HP]:-.6},hooks:r=>[{event:c.enemy.die,handler:()=>{x.addAttr(g.player.HP,.08,r.id),x.getAttrStackCount(g.player.HP,r.id)==10&&m.on({event:c.game.battle.end,handler:()=>{u.remove(r),u.tryAcquire(N.sn思念)},maxCalls:1})}},{event:c.game.finish,handler:t=>{},maxCalls:1}],onAcquire(r){}},sn思念:{name:"思念",level:1,type:w.NORMAL,tags:[h.UNIQUE_GLOBAL,h.NO_RANDOM],effects:{[g.player.HP]:.2},hooks:r=>[{event:c.player.dealDamage,handler:t=>{switch(Math.floor(Math.random()*3)){case 0:return{...t,baseDamage:t.baseDamage*1.15};case 1:m.on({event:c.player.takeDamage,handler:e=>({...e,baseDamage:e*.7}),maxCalls:1,source:r.id});break;case 2:f.takeHeal(f.state.hp_max*.01);break}}}],onAcquire(r){}},ds胆识:{name:"胆识",level:0,type:w.ENDING,tags:[h.UNIQUE_GLOBAL,h.NO_DROP,h.NO_RANDOM,h.SPECIAL_EXCHANGE],effects:{[g.enemy.DMG_DEC]:-15,[g.boss.HP]:.45},hooks:r=>[{event:c.game.finish,handler:t=>{},maxCalls:1}]},js决心:{name:"决心",level:0,type:w.ENDING,tags:[h.UNIQUE_GLOBAL,h.NO_DROP,h.NO_EXCHANGE,h.NO_RANDOM],effects:{[g.enemy.DMG_DEC]:-10,[g.player.ATK]:.35,[g.player.HP]:-.2},hooks:r=>[{event:c.game.finish,handler:t=>{},maxCalls:1}],onAcquire(r){f.state.hp=f.state.hp_max}},yy犹疑:{name:"犹疑",level:0,type:w.ENDING,tags:[h.UNIQUE_GLOBAL,h.NO_DROP,h.NO_RANDOM,h.SPECIAL_EXCHANGE],effects:{[g.player.SPD]:-.4,[g.player.ATK]:-.2}},gw观望:{name:"观望",level:0,type:w.ENDING,tags:[h.UNIQUE_GLOBAL,h.NO_DROP,h.NO_EXCHANGE,h.NO_RANDOM],effects:{[g.player.DASH_CHARGE]:.15}},hq好奇:{name:"好奇",level:1,type:w.NORMAL,tags:[h.UNIQUE_GLOBAL,h.NO_DROP,h.NO_EXCHANGE,h.SPECIAL_EXCHANGE],effects:{[g.player.TAKE_DMG]:.3},hooks:r=>[{event:c.game.enter.shop,handler:()=>{r.removeTag(h.NO_DROP),r.removeTag(h.NO_EXCHANGE)}}],onAcquire(r){}},zx珍惜:{name:"珍惜",level:1,type:w.NORMAL,tags:[h.UNIQUE_GLOBAL,h.NO_EXCHANGE,h.SPECIAL_EXCHANGE,h.NO_RANDOM],effects:{},hooks:r=>[{event:c.game.enter.shop,handler:()=>{r.removeTag(h.NO_EXCHANGE)}}],onAcquire(r){},onExchange(r){}},ls朗诵:{name:"朗诵",level:1,type:w.NORMAL,tags:[h.UNIQUE_GLOBAL,h.NO_RANDOM,h.ADD_SLOTS],onAcquire(r){u.addSlots(2,{maxLevel:3,type:w.NORMAL},r.id)},canRemove:r=>u.slots.filter(e=>e._source===r.id).every(e=>e.item==null||e.item===r)},xq休憩:{name:"休憩",level:1,type:w.NORMAL,tags:[h.MULTIPLE],hooks:r=>[{event:c.item.use,handler:({usedItem:t})=>{t===r&&(f.takeHeal(f.state.hp_max*.4,r.id),u.remove(r))}}]},jy惊讶:{name:"惊讶",level:1,type:w.NORMAL,tags:[h.UNIQUE_SINGLE]},dg祷告:{name:"祷告",level:1,type:w.NORMAL,tags:[h.UNIQUE_SINGLE,h.SPECIAL_EXCHANGE],effects:{[g.player.LOS]:-.3}}};let St=0;const et=new Set;class bt{constructor(t){this.config=t,this.state=t.state?{...t.state}:{},this.id=`${t.name}_${St++}`,this.name=t.name,this.tags=[...t.tags||[]],this.type=t.type,this.level=t.level,et.add(t.name),this._slot=null,this._init=!1,this._active=!1}activate(){if(!this._active){if(this._active=!0,this.config.effects)for(const t in this.config.effects)x.addAttr(t,this.config.effects[t],this.id);if(this.config.hooks)for(const t of this.config.hooks(this)){const e={...t,handler:t.handler.bind(this),source:this.id};m.on(e)}typeof this.config.onActivate=="function"&&this.config.onActivate(this),typeof this.config.onAcquire=="function"&&!this._init&&(this.config.onAcquire(this),this._init=!0)}}deactivate(){this._active&&(this._active=!1,x.removeAllAttrBySource(this.id),m.offBySource(this.id),this.hasTag(h.ADD_SLOTS)&&u.removeSlotsBySource(this.id))}addTag(t){this.tags.includes(t)||this.tags.push(t)}removeTag(t){this.tags=this.tags.filter(e=>e!==t)}hasTag(t){return this.tags.includes(t)}canRemove(){return this.hasTag(h.NO_DROP)?!1:typeof this.config.canRemove=="function"?this.config.canRemove(this):!0}dispose(){this.deactivate(),typeof this.config.onRemove=="function"&&this.config.onRemove(this)}}const R={INVENTORY:"INVENTORY",PICKUP:"PICKUP",TRUSH:"TRUSH"};class T{constructor({type:t=R.INVENTORY,itemType:e=null,maxLevel:i=1/0,_source:s=null}={}){this.type=t,this.itemType=e,this.maxLevel=i,this.item=null,this._source=s}canAccept(t){return t?!(this.type===R.PICKUP||this.type===R.TRUSH&&!t.canRemove()||this.itemType&&this.itemType!==t.type||this.maxLevel<t.level):!0}setItem(t){if(this.type===R.TRUSH){t.dispose();return}this.item=t,t&&(t._slot=this)}removeItem(){this.item&&(this.item._slot=null),this.item=null}isEmpty(){return this.item===null}}class U{constructor(){if(U.instance)return U.instance;U.instance=this,this.slots=[new T({itemType:w.ENDING,maxLevel:1/0}),new T({maxLevel:3}),new T({maxLevel:2}),new T({maxLevel:2}),new T({maxLevel:2}),new T({maxLevel:1}),new T({maxLevel:1}),new T({maxLevel:1})],this.trashSlot=new T({type:R.TRUSH}),this.selectedIndex=0,this.dragging=!1,this.draggingFrom=null,this.draggingItem=null}swapSlots(t,e){if(!t||!e)return!1;const i=t.item,s=e.item;return!e.canAccept(i)||!t.canAccept(s)||t.type!=R.INVENTORY&&s&&!s.canRemove()||e.type!=R.INVENTORY&&i&&!i.canRemove()?!1:(t.type!=R.INVENTORY&&s&&s.deactivate(),e.type!=R.INVENTORY&&i&&i.deactivate(),t.removeItem(),e.removeItem(),t.setItem(s),e.setItem(i),!0)}tryAcquire(t){if(t.tags?.includes(h.UNIQUE_GLOBAL)&&et.has(t.name)||t.tags?.includes(h.UNIQUE_SINGLE)&&this.slots.some(a=>a.item?.config.name===t.name))return null;const e=this.slots.findIndex(s=>!s.item&&s.canAccept(t));if(e===-1)return null;const i=new bt(t);return i.activate(),this.slots[e].setItem(i),i._slot=this.slots[e],i}remove(t){t.dispose(),t._slot.removeItem()}getAt(t){return this.slots[t]?.item||null}getAll(){return this.slots.map(t=>t.item)}selectNext(){this.selectedIndex=(this.selectedIndex+1)%this.slots.length}selectPrev(){this.selectedIndex=(this.selectedIndex-1+this.slots.length)%this.slots.length}getSelectedSlot(){return this.slots[this.selectedIndex]||null}getSelectedItem(){return this.slots[this.selectedIndex]?.item||null}addSlots(t,e={},i=null){const{maxLevel:s=1,type:a=w.NORMAL}=e;for(let n=0;n<t;n++){const o=new T({itemType:a,maxLevel:s,_source:i});this.slots.push(o)}}removeSlotsBySource(t,e=!0){t&&(this.slots=this.slots.filter(i=>i._source===t?(e&&i.item&&(i.item.dispose(),i.removeItem()),!1):!0))}getRandomConfig(t,e={}){const{exclude:i=[],type:s=w.NORMAL}=e,a=Object.values(N).filter(o=>!(o.level!==t||s&&o.type!==s||i.includes(o.name)||o.tags?.includes(h.NO_RANDOM)||o.tags?.includes(h.UNIQUE_GLOBAL)&&et.has(o.name)||o.tags?.includes(h.UNIQUE_SINGLE)&&this.slots.some(y=>y.item?.config.name===o.name)));return a.length===0?null:a[Math.floor(Math.random()*a.length)]}update(t){p.isFirstDown("N")&&u.selectNext(),p.isFirstDown("M")&&u.selectPrev(),p.isFirstDown("I")&&m.emit(c.item.use,{usedItem:this.getSelectedItem()})}}const u=new U;class at{constructor(t){this.name=t,this.elements=[],this.visible=!1}addElement(t){this.elements.push(t)}show(){this.visible=!0}hide(){this.visible=!1}draw(t){if(this.visible)for(let e of this.elements)e.draw(t)}handleEvent(t){if(!this.visible)return!1;for(let e=this.elements.length-1;e>=0;e--)if(this.elements[e].handleEvent(t))return!0;return!1}}class lt{constructor(t,e,i,s){this.x=t,this.y=e,this.width=i,this.height=s,this.visible=!0,this.draggable=!1,this.dragging=!1}draw(t){}update(t){}contains(t,e){return t>=this.x&&t<=this.x+this.width&&e>=this.y&&e<=this.y+this.height}handleEvent(t){return!1}}class ot extends lt{constructor(t,e,i,s){super(e,i,s,s),this.slot=t,this.size=s,this.padding=5,this.hovering=!1}draw(t){if(!this.visible)return;t.fillStyle="rgba(50,50,50,0.7)",t.fillRect(this.x,this.y,this.width,this.height),this.hovering&&u.draggingFrom?(t.strokeStyle=this.slot.canAccept(u.draggingItem)?"lime":"red",t.lineWidth=3):(t.strokeStyle=u.getSelectedSlot()===this.slot?"yellow":"white",t.lineWidth=u.getSelectedSlot()===this.slot?2:1),t.strokeRect(this.x,this.y,this.width,this.height);let e="空";this.slot.item&&this.slot!==u.draggingFrom?e=this.slot.item.name:this.slot.type===R.TRUSH&&(e="垃圾桶"),t.fillStyle="white",t.font=`${Math.min(this.width/3,14)}px sans-serif`,t.textAlign="center",t.textBaseline="middle",t.fillText(e,this.x+this.width/2,this.y+this.height/2)}handleEvent(t){const{type:e,offsetX:i,offsetY:s}=t;if(this.hovering=this.contains(i,s),!this.contains(i,s))return!1;switch(e){case"mousedown":if(this.slot.item)return u.dragging=!0,u.draggingFrom=this.slot,u.draggingItem=this.slot.item,!0;break;case"mouseup":if(u.dragging)return u.swapSlots(u.draggingFrom,this.slot)||console.warn("交换失败"),u.dragging=!1,u.draggingFrom=null,u.draggingItem=null,!0;break}return!1}}const At=document.getElementById("game-canvas"),Et=document.getElementById("ui-canvas");At.getContext("2d");Et.getContext("2d");const Z={width:1440,height:720};class Tt extends at{constructor(t="itemBar",e=80,i=60,s=5){super(t),this.name=t,this.width=e,this.slotSize=i,this.padding=s,this.visible=!0,this.elements=[];const a=Z.width-this.width+this.padding,n=Z.height-this.slotSize-this.padding;this.trashSlot=new ot(u.trashSlot,a,n,this.slotSize)}draw(t){if(this.elements.length!=u.slots.length+1){const e=Z.width-this.width+this.padding,i=this.padding;this.elements=u.slots.map((s,a)=>new ot(s,e,i+a*(this.slotSize+this.padding),this.slotSize)),this.elements.push(this.trashSlot)}super.draw(t),u.dragging&&(t.save(),t.globalAlpha=.8,t.fillStyle="white",t.font="16px bold sans-serif",t.textAlign="center",t.textBaseline="middle",t.fillText(u.draggingItem.name,tt.position.x,tt.position.y),t.restore())}}const Rt=new Tt;class $ extends lt{constructor(t,e,i,s,a,n){super(t,e,i,s),this.text=a,this.onClick=n,this.hover=!1}draw(t){if(!this.visible)return;t.fillStyle=this.hover?"rgba(3,102,241,0.8)":"rgba(30,41,59,0.9)",t.strokeStyle="rgba(3,102,241,0.5)",t.lineWidth=2,t.beginPath();const e=8;t.moveTo(this.x+e,this.y),t.arcTo(this.x+this.width,this.y,this.x+this.width,this.y+this.height,e),t.arcTo(this.x+this.width,this.y+this.height,this.x,this.y+this.height,e),t.arcTo(this.x,this.y+this.height,this.x,this.y,e),t.arcTo(this.x,this.y,this.x+this.width,this.y,e),t.closePath(),t.fill(),t.stroke(),t.fillStyle="#f8fafc",t.font="16px Inter",t.textAlign="center",t.textBaseline="middle",t.fillText(this.text,this.x+this.width/2,this.y+this.height/2)}handleEvent(t){return this.visible?t.type==="mousemove"?(this.hover=this.contains(t.offsetX,t.offsetY),this.hover):t.type==="mouseup"&&this.contains(t.offsetX,t.offsetY)?(this.onClick?.(),!0):!1:!1}}class Mt extends at{constructor(){super("soundSettings"),this.visible=!1,this.container=null}setupUI(){if(this.container)return;this.container=document.createElement("div"),this.container.style.cssText=`
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            color: white;
            font-family: Arial, sans-serif;
            z-index: 1000;
            min-width: 300px;
            display: none;
        `,this.createVolumeControl("主音量","masterVolume",v.masterVolume),this.createVolumeControl("音效音量","sfxVolume",v.sfxVolume),this.createVolumeControl("音乐音量","musicVolume",v.musicVolume);const t=document.createElement("button");t.textContent="关闭",t.style.cssText=`
            margin-top: 15px;
            padding: 8px 16px;
            background: #333;
            color: white;
            border: 1px solid #555;
            border-radius: 5px;
            cursor: pointer;
        `,t.addEventListener("click",()=>{this.hide()}),this.container.appendChild(t),document.body.appendChild(this.container)}createVolumeControl(t,e,i){const s=document.createElement("div");s.style.cssText=`
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        `;const a=document.createElement("label");a.textContent=t,a.style.cssText=`
            min-width: 80px;
            font-size: 14px;
        `;const n=document.createElement("input");n.type="range",n.min="0",n.max="100",n.value=Math.round(i*100),n.style.cssText=`
            flex: 1;
            height: 20px;
        `;const o=document.createElement("span");o.textContent=`${Math.round(i*100)}%`,o.style.cssText=`
            min-width: 40px;
            text-align: right;
            font-size: 12px;
        `,n.addEventListener("input",l=>{const y=l.target.value/100;switch(o.textContent=`${l.target.value}%`,e){case"masterVolume":v.setMasterVolume(y);break;case"sfxVolume":v.setSfxVolume(y);break;case"musicVolume":v.setMusicVolume(y);break}}),s.appendChild(a),s.appendChild(n),s.appendChild(o),this.container.appendChild(s)}show(){this.visible=!0,this.setupUI(),this.container.style.display="block"}hide(){this.visible=!1,this.container&&(this.container.style.display="none")}draw(t){}handleEvent(t){return t.type==="keydown"&&t.key==="Escape"?(this.hide(),!0):!1}}const ct=new Mt;class _t extends at{constructor(){super("pauseMenu"),this.menuWidth=300,this.menuHeight=300;const t=1440/2,e=720/2,i=200,s=50,a=20,n=e-60;this.addElement(new $(t-i/2,n,i,s,"继续游戏",()=>E.resume())),this.addElement(new $(t-i/2,n+(s+a),i,s,"音效设置",()=>{ct.show()})),this.addElement(new $(t-i/2,n+2*(s+a),i,s,"存档",()=>{E.save()})),this.addElement(new $(t-i/2,n+3*(s+a),i,s,"返回主菜单",()=>{window.location.href="menu.html"}))}draw(t){this.visible&&(t.fillStyle="rgba(30,41,59,0.8)",t.fillRect(80,0,1280,t.canvas.height),t.fillStyle="#f8fafc",t.font="20px Inter",t.textAlign="center",t.fillText("暂停菜单",t.canvas.width/2,t.canvas.height/2-100),super.draw(t))}}const Ct=new _t;class j{static instance;constructor(){if(j.instance)return j.instance;j.instance=this,this.screens={},this.currentScreen=null,this.persistentScreens=new Set}addScreen(t,e=!1){this.screens[t.name]=t,e&&this.persistentScreens.add(t.name)}switchScreen(t){this.currentScreen&&!this.persistentScreens.has(this.currentScreen.name)&&this.currentScreen.hide(),this.currentScreen=this.screens[t],this.currentScreen?.show()}draw(t){for(let e of this.persistentScreens){const i=this.screens[e];i.visible&&i.draw(t)}this.currentScreen&&!this.persistentScreens.has(this.currentScreen.name)&&this.currentScreen.visible&&this.currentScreen.draw(t)}handleEvent(t){for(let e of this.persistentScreens){const i=this.screens[e];if(i.visible&&typeof i.handleEvent=="function"&&i.handleEvent(t))return}if(!(this.currentScreen&&typeof this.currentScreen.handleEvent=="function"&&this.currentScreen.handleEvent(t))&&t.type==="mouseup")return u.dragging=!1,u.draggingFrom=null,u.draggingItem=null,!0}}const D=new j,Dt=document.getElementById("ui-canvas");["mousemove","mousedown","mouseup"].forEach(r=>{Dt.addEventListener(r,t=>D.handleEvent(t))});D.addScreen(Rt,!0);D.addScreen(Ct);D.addScreen(ct);class I{constructor(){if(I.instance)return I.instance;I.instance=this,this.canvas_game=document.getElementById("game-canvas"),this.canvas_ui=document.getElementById("ui-canvas"),this.canvas_ui.addEventListener("contextmenu",e=>e.preventDefault()),this.canvas_ui.addEventListener("dragstart",e=>e.preventDefault()),this.ctx_game=this.canvas_game.getContext("2d"),this.ctx_ui=this.canvas_ui.getContext("2d"),this.currentHpPercent=1,this.isStop=!1,this.isPaused=!1,this.lastTime=0;const t=60;this.targetFrameTime=1e3/t,this.loop=this.loop.bind(this),this.statistics={portal:0,bullet:0,restart:0,jump:0,jumpTime:0}}async init(){await C.load(),await v.load();const t=localStorage.getItem("selected_slot"),e=Math.max(1,parseInt(t||"1",10)||1);this.currentSlotId=e;let i=!1;try{i=await I.loadGame(e)}catch{i=!1}if(i||(await k.loadRoom(0,4),console.log("🎮 游戏初始化完成，当前房间: layer0/room3")),!i){const a=k.getPlayerSpawn();f.setPosition(new d(a.x,a.y))}m.on({event:c.player.hpPercent,handler:a=>{this.currentHpPercent=Math.max(0,Math.min(1,a))},priority:0}),m.on({event:c.game.tick,handler:({deltaTime:a})=>{S.isActive||k.update(a,f)},priority:.8}),m.on({event:c.game.tick,handler:({deltaTime:a})=>{S.isActive||u.update(a)},priority:1}),m.on({event:c.game.tick,handler:({deltaTime:a})=>{S.isActive||x.update(a)},priority:.7}),m.on({event:c.game.tick,handler:({deltaTime:a})=>{S.isActive||f.update(a)},priority:.5}),m.on({event:c.game.tick,handler:({deltaTime:a})=>{S.isActive||this.enemies.forEach(n=>n.update(a))},priority:.3}),m.on({event:c.game.tick,handler:({deltaTime:a})=>{S.isActive||X.update(a)},priority:.1}),m.on({event:c.player.die,handler:()=>{this.stop(),window.location.href="menu.html"}}),m.on({event:c.interaction.trigger,handler:a=>this.handleInteraction(a),priority:0});const s=k.getEnemySpawns();if(this.enemies=[],Array.isArray(s))for(const a of s)this.enemies.push(new Q(a.type,new d(a.x,a.y)));console.log("👹 敌人初始化完成:",{enemySpawnsCount:s?s.length:0,enemiesCount:this.enemies.length,enemyTypes:this.enemies.map(a=>a.type)}),u.tryAcquire(N.xq休憩),u.tryAcquire(N.yy友谊),u.tryAcquire(N.ls朗诵),window.itemManager=u}draw(){const t=this.ctx_game;t.clearRect(0,0,this.canvas_game.width,this.canvas_game.height);const e=this.ctx_ui;e.clearRect(0,0,this.canvas_ui.width,this.canvas_ui.height),k.draw(t),X.draw(t),this.enemies.forEach(i=>i.draw(t)),f.draw(t),D.draw(e),this.drawVerticalHpBar(e)}drawVerticalHpBar(t){const e={x:35,y:200,width:30,totalHeight:500,bgColor:"#ff3333",fgColor:"#33ff33",borderColor:"#000000",textColor:"#ffffff",fontSize:"14px Arial",textRightAlign:50},i=Math.round(f.state.hp),s=Math.round(f.state.hp_max),a=Math.round(f.state.attack.atk);t.font=e.fontSize,t.fillStyle=e.textColor,t.textAlign="center",t.fillText("血量：",e.textRightAlign,60),t.fillText(`${i}/${s}`,e.textRightAlign,80),t.fillText("攻击力：",e.textRightAlign,110),t.fillText(`${a}`,e.textRightAlign,130),t.fillStyle=e.bgColor,t.fillRect(e.x,e.y,e.width,e.totalHeight),t.strokeStyle=e.borderColor,t.lineWidth=1,t.strokeRect(e.x,e.y,e.width,e.totalHeight);const n=e.totalHeight*this.currentHpPercent,o=e.y+(e.totalHeight-n);t.fillStyle=e.fgColor,t.fillRect(e.x,o,e.width,n)}start(t=0){this.loop(0)}loop(t){const e=t-this.lastTime;e>=this.targetFrameTime&&(p.update(),p.isFirstDown("Esc")&&(S.isActive||this.switchPause()),E.enemies.length==0&&m.emit(c.game.battle.end),(!this.isPaused&&!this.isStop||S.isActive)&&m.emit(c.game.tick,{deltaTime:e}),this.draw()),this.lastTime=t-e%this.targetFrameTime,requestAnimationFrame(this.loop)}pause(){this.isPaused=!0,D.switchScreen("pauseMenu")}resume(){this.isPaused=!1,D.switchScreen()}switchPause(){this.isPaused?this.resume():this.pause()}stop(){this.isStop=!0}save(){const t=this.currentSlotId&&this.currentSlotId>0?this.currentSlotId:1;this.saveCurrentGame(t)}saveCurrentGame(t=1){const e={version:1,player:f.constructor.getSaveData(),enemies:this.enemies.map(s=>({type:s.type,position:s.hitbox.position,state:s.state,defeated:s.state.hp<=0})),layer:k.currentLayer,room:k.currentRoom,mapState:k.getMapState(),completedEvents:m.getCompletedEvents(),timestamp:new Date().toISOString()};if(!this.validateSaveData(e))return console.error("存档数据验证失败"),null;try{JSON.stringify(e)}catch(s){return console.error("存档数据序列化失败:",s),null}let i=null;try{i=JSON.parse(localStorage.getItem("present_data"))}catch{i=null,console.error("读取存档数据失败")}(!i||typeof i!="object")&&(i={saveSlots:[]}),i.saveSlots=i.saveSlots||[],i.saveSlots[t-1]=e;try{return localStorage.setItem("present_data",JSON.stringify(i)),console.log("存档成功:",e),e}catch(s){return console.error("存档写入失败:",s),null}}validateSaveData(t){return!t||typeof t!="object"?(console.warn("存档数据不是有效对象"),!1):typeof t.version!="number"||t.version<1?(console.warn("存档版本号无效:",t.version),!1):!t.player||typeof t.player!="object"?(console.warn("存档缺少玩家数据"),!1):typeof t.layer!="number"||typeof t.room!="number"?(console.warn("存档地图数据无效"),!1):Array.isArray(t.enemies)?!0:(console.warn("存档敌人数据不是数组"),!1)}repairSaveData(t){return console.log("尝试修复存档数据..."),typeof t.version!="number"&&(t.version=1),(!t.player||typeof t.player!="object")&&(console.log("修复玩家数据"),t.player={position:{x:100,y:100},state:{hp:100,hp_max:100,attack:{atk:10}},timestamp:new Date().toISOString()}),typeof t.layer!="number"&&(t.layer=0),typeof t.room!="number"&&(t.room=3),Array.isArray(t.enemies)||(t.enemies=[]),(!t.mapState||typeof t.mapState!="object")&&(t.mapState={triggeredInteractions:[],completedEvents:[],currentLayer:t.layer,currentRoom:t.room}),Array.isArray(t.completedEvents)||(t.completedEvents=[]),console.log("存档数据修复完成"),t}async loadGame(t=1){console.log("开始加载存档，槽位:",t);let e=null;try{const s=localStorage.getItem("present_data");console.log("原始存档数据:",s),e=JSON.parse(s)}catch(s){console.error("解析存档数据失败:",s),e=null}if(!e?.saveSlots?.[t-1])return console.log("存档槽位不存在:",t),!1;let i=e.saveSlots[t-1];if(console.log("存档数据内容:",i),!this.validateSaveData(i)){if(console.warn("存档数据验证失败，尝试修复..."),i=this.repairSaveData(i),!this.validateSaveData(i))return console.error("存档数据无法修复，加载失败"),!1;e.saveSlots[t-1]=i;try{localStorage.setItem("present_data",JSON.stringify(e)),console.log("修复后的存档数据已保存")}catch(s){console.warn("保存修复后的存档数据失败:",s)}}switch(i.version){case 1:break;default:console.warn(`未知的存档版本: ${i.version}，尝试按版本1处理`);break}console.log(`加载地图: layer${i.layer}/room${i.room}`),await k.loadRoom(i.layer,i.room);try{if(i.player?.position){const s=i.player.position;console.log("恢复玩家位置:",s),f.setPosition(new d(s.x,s.y))}i.player?.state&&(console.log("恢复玩家状态:",i.player.state),f.state=i.player.state),Array.isArray(i.enemies)&&(console.log("恢复敌人状态，数量:",i.enemies.length),this.enemies=i.enemies.map(s=>{const a=new Q(s.type,new d(s.position.x,s.position.y));return s.state&&(a.state={...a.state,...s.state,attack:{...a.state.attack,...s.state.attack||{}}},a.state.hp=Math.min(a.state.hp,a.state.hp_max)),s.defeated&&(console.log(`敌人 ${s.type} 已被击败`),a.state.hp=0,a.state.isDefeated=!0),a})),i.mapState&&(console.log("恢复地图状态:",i.mapState),k.restoreMapState(i.mapState)),Array.isArray(i.completedEvents)&&(console.log("恢复已完成事件:",i.completedEvents),m.restoreCompletedEvents(i.completedEvents))}catch(s){console.error("加载存档时出错:",s)}return console.log("存档加载完成"),!0}async handleInteraction(t){const{type:e,event:i,data:s}=t;console.log("🎮 交互点触发:",{type:e,event:i,data:s});try{switch(e){case"next_room":case"exit":await this.handleRoomTransition(i,s);break;case"plot":case"teach":case"fire":case"sword":this.handlePlotEvent(i,s);break;case"npc":case"angel":this.handleNPCEvent(i,s);break;case"chest":this.handleChestEvent(i,s);break;case"hidden":this.handleHiddenRoomEvent(i,s);break;default:console.log("未处理的交互类型:",e,i)}}catch(a){console.error("处理交互事件时出错:",a)}}async handleRoomTransition(t,e){console.log("🚪 房间切换触发:",t,e);const i=this.enemies.length>0,s=e.can_be_used_when==="battle_end"||i;if(console.log("🔍 初始检查:",{hasEnemies:i,enemiesCount:this.enemies.length,requiresBattleEnd:s,explicitCondition:e.can_be_used_when==="battle_end"}),s){const y=this.enemies.filter(b=>b.state&&b.state.hp>0);if(console.log("🔍 检查敌人状态:",{totalEnemies:this.enemies.length,aliveEnemies:y.length,enemyHPs:this.enemies.map(b=>b.state?b.state.hp:"no state"),requiresBattleEnd:s,hasEnemies:i,explicitCondition:e.can_be_used_when==="battle_end"}),y.length>0){console.log("⚠️ 还有敌人存活，无法切换房间");return}}const a=k.currentLayer,n=k.currentRoom;let o=a,l=n+1;a===0?n>=4&&(o=1,l=1):a===1&&n>=1&&(o=0,l=1),console.log(`🔄 从 layer${a}/room${n} 切换到 layer${o}/room${l}`),await this.switchRoom(o,l)}async switchRoom(t,e){try{this.saveCurrentGame(this.currentSlotId),await k.loadRoom(t,e);const i=k.getPlayerSpawn();i&&f.setPosition(new d(i.x,i.y));const s=k.getEnemySpawns();if(this.enemies=[],Array.isArray(s))for(const a of s)this.enemies.push(new Q(a.type,new d(a.x,a.y)));console.log("👹 新房间敌人初始化:",{layer:t,room:e,enemySpawnsCount:s?s.length:0,enemiesCount:this.enemies.length,enemyTypes:this.enemies.map(a=>a.type)}),console.log(`✅ 成功切换到 layer${t}/room${e}`)}catch(i){console.error("房间切换失败:",i)}}handlePlotEvent(t,e){console.log("剧情事件触发:",t,e)}handleNPCEvent(t,e){console.log("NPC事件触发:",t,e)}handleChestEvent(t,e){console.log("宝箱事件触发:",t,e)}handleHiddenRoomEvent(t,e){console.log("隐藏房间事件触发:",t,e)}}const E=new I;window.onload=()=>{E.init().then(()=>{E.start()})};
