class T{constructor(){if(T.instance)return T.instance;T.instance=this}async loadJSON(t){const e=await fetch(t);if(!e.ok)throw new Error(`Failed to load JSON: ${t}`);return await e.json()}async loadImg(t){return new Promise((e,i)=>{const s=new Image;s.src=t,s.onload=()=>e(s),s.onerror=a=>i(new Error(`Failed to load image: ${t}`))})}}const G=new T;class _{constructor(){if(_.instance)return _.instance;_.instance=this}async load(){this.tempCanvas=document.querySelector("canvas#buffer"),this.texturesURL=await G.loadJSON("assets/imgs/Textures.json"),this.textures={};const t=new Map,e=[];for(const s of Object.keys(this.texturesURL))for(const a of Object.keys(this.texturesURL[s]))e.push(this.texturesURL[s][a]);const i=e.map(async s=>{const a=await fetch(s);if(!a.ok)throw new Error(`Failed to load image: ${s}`);const n=await a.blob(),r=await createImageBitmap(n);t.set(s,r)});await Promise.all(i);for(const s of Object.keys(this.texturesURL)){this.textures[s]={};for(const a of Object.keys(this.texturesURL[s]))this.textures[s][a]=t.get(this.texturesURL[s][a])}}getTexture(t,e="0"){return this.textures[t]&&this.textures[t][e]?this.textures[t][e]:null}}const M=new _;class L{constructor(){if(L.instance)return L.instance;L.instance=this,this.canvas=document.getElementById("canvas"),this.container=document.querySelector("#game-container"),this.isCapture=!1,this.ratio=this.canvas.width/this.container.clientWidth,this.x=0,this.y=0,this.prevX=0,this.prevY=0,this.left=!1,this.right=!1,this.clickable=!1,this.container.addEventListener("click",()=>this.capture()),this.container.addEventListener("mousemove",t=>this.move(t)),this.container.addEventListener("mousedown",t=>this.mouseDown(t)),this.container.addEventListener("mouseup",t=>this.mouseUp(t)),document.addEventListener("pointerlockchange",()=>this.uncapture()),document.addEventListener("visibilitychange",()=>this.blur()),document.addEventListener("click",()=>A.continue())}async capture(){this.isCapture||(await this.container.requestPointerLock({unadjustedMovement:!1}),this.isCapture=!0,setTimeout(()=>{this.clickable=!0},200))}blur(){document.visibilityState==="hidden"&&(document.exitPointerLock(),this.uncapture())}uncapture(){console.debug("uncapture: ",document.pointerLockElement,this.container),console.debug("uncapture: ",document.pointerLockElement!==this.container),document.pointerLockElement!==this.container&&(this.isCapture=!1,A.pause()),this.clickable=!1}mouseDown(t){t.preventDefault(),this.clickable&&(t.button===0&&(this.left=!0),t.button===2&&(this.right=!0))}mouseUp(t){t.preventDefault(),t.button===0&&(this.left=!1),t.button===2&&(this.right=!1)}move(t){t.preventDefault(),this.isCapture&&(this.ratio=this.canvas.width/this.container.clientWidth,this.x+=t.layerX-this.prevX,this.y+=t.layerY-this.prevY,this.prevX=t.layerX,this.prevY=t.layerY,this.x+=t.movementX*this.ratio,this.y+=t.movementY*this.ratio,this.x<0&&(this.x=0),this.y<0&&(this.y=0),this.x>this.canvas.width&&(this.x=this.canvas.width),this.y>this.canvas.height&&(this.y=this.canvas.height))}draw(t){t.drawImage(M.getTexture("cursor"),12,9,16,22,this.x-4,this.y-5,16,22)}get position(){return new Vector(this.x,this.y)}}class N{status;KEYMAP=new Map([["ShiftLeft","LShift"],["ShiftRight","RShift"],["ControlLeft","LCtrl"],["ControlRight","RCtrl"],["AltLeft","LAlt"],["AltRight","RAlt"],["MetaLeft","LWin"],["MetaRight","RWin"],["Escape","Esc"],["F1","F1"],["F2","F2"],["F3","F3"],["F4","F4"],["F5","F5"],["F6","F6"],["F7","F7"],["F8","F8"],["F9","F9"],["F10","F10"],["F11","F11"],["F12","F12"],["Digit0","0"],["Digit1","1"],["Digit2","2"],["Digit3","3"],["Digit4","4"],["Digit5","5"],["Digit6","6"],["Digit7","7"],["Digit8","8"],["Digit9","9"],["KeyA","A"],["KeyB","B"],["KeyC","C"],["KeyD","D"],["KeyE","E"],["KeyF","F"],["KeyG","G"],["KeyH","H"],["KeyI","I"],["KeyJ","J"],["KeyK","K"],["KeyL","L"],["KeyM","M"],["KeyN","N"],["KeyO","O"],["KeyP","P"],["KeyQ","Q"],["KeyR","R"],["KeyS","S"],["KeyT","T"],["KeyU","U"],["KeyV","V"],["KeyW","W"],["KeyX","X"],["KeyY","Y"],["KeyZ","Z"],["ArrowUp","Up"],["ArrowDown","Down"],["ArrowLeft","Left"],["ArrowRight","Right"],["Home","Home"],["End","End"],["PageUp","Page Up"],["PageDown","Page Down"],["Enter","Enter"],["Space","Space"],["Backspace","Backspace"],["Tab","Tab"],["Delete","Delete"],["Insert","Insert"],["CapsLock","Caps Lock"],["NumLock","Num Lock"],["ScrollLock","Scroll Lock"],["Pause","Pause"],["PrintScreen","Print Screen"],["Numpad0","NUMPAD0"],["Numpad1","NUMPAD1"],["Numpad2","NUMPAD2"],["Numpad3","NUMPAD3"],["Numpad4","NUMPAD4"],["Numpad5","NUMPAD5"],["Numpad6","NUMPAD6"],["Numpad7","NUMPAD7"],["Numpad8","NUMPAD8"],["Numpad9","NUMPAD9"],["NumpadMultiply","Mul"],["NumpadAdd","Add"],["NumpadSubtract","Sub"],["NumpadDecimal","Dec"],["NumpadDivide","Div"],["ContextMenu","Apps"],["Help","Help"]]);constructor(){if(N.instance)return N.instance;N.instance=this,this.status=new Map,this.KEYMAP.forEach((t,e)=>{this.status.set(t,!1)}),document.addEventListener("keydown",t=>{const e=this.KEYMAP.get(t.code);this.status.has(e)&&this.status.set(e,!0)}),document.addEventListener("keyup",t=>{const e=this.KEYMAP.get(t.code);this.status.has(e)&&this.status.set(e,!1)}),addEventListener("keydown",t=>{t.preventDefault()})}isKeyDown(t){return this.status.get(t)||!1}isKeysDown(t){let e=!1;return t.forEach(i=>{e=e||this.isKeyDown(i)}),e}}class q{constructor(){this.keyboard=new N,this.mouse=new L,this.keyPrevState=new Map,this.keyCurrState=new Map}update(){[...this.keyboard.KEYMAP.values(),"ClickLeft","ClickRight"].forEach(e=>{this.keyPrevState.set(e,this.keyCurrState.get(e)||!1),this.keyCurrState.set(e,this.isKeyDown(e))})}isKeyDown(t){return t==="ClickLeft"?this.mouse.left:t==="ClickRight"?this.mouse.right:this.keyboard.isKeyDown(t)}isKeysDown(t){return t.some(e=>this.isKeyDown(e))}isAllKeysDown(t){return t.every(e=>this.isKeyDown(e))}isFirstDown(t){return this.keyCurrState.get(t)&&!this.keyPrevState.get(t)}isHeld(t){return this.keyCurrState.get(t)}isReleased(t){return!this.keyCurrState.get(t)&&this.keyPrevState.get(t)}}const x=new q;class P{constructor(){if(P.instance)return P.instance;P.instance=this,this.backgroundMusic=null,this.init()}handleClick=()=>{const t=new Audio;t.muted=!0,t.play().catch(()=>{}),document.removeEventListener("click",this.handleClick)};init(){document.addEventListener("click",this.handleClick)}async load(){this.sounds={},this.soundsURL=await G.loadJSON("assets/audios/Sounds.json");for(const t of Object.keys(this.soundsURL)){this.sounds[t]={};for(const e of Object.keys(this.soundsURL[t])){const i=new Audio(this.soundsURL[t][e]);i.loop=!1,this.sounds[t][e]=i}}}async playSound(t,e=0){const i=this.sounds[t]&&this.sounds[t][e];if(i)if(i.paused)i.currentTime=0,i.play().catch(s=>{console.error(`Error playing sound: ${t+e}`,s)});else{if(t==="walk")return;const s=i.cloneNode();s.currentTime=0,s.play().catch(a=>{console.error(`Error playing sound: ${t+e}`,a)})}}}const z=new P,u={game:{tick:"GAME_TICK",battle:{start:"GAME_BATTLE_START",end:"GAME_BATTLE_END"},enter:{shop:"GAME_ENTER_SHOP"},finish:"GAME_FINISH"},item:{gain:"ITEM_GAIN",use:"ITEM_USE"},player:{die:"PLAYER_DIE",hpPercent:"PLAYER_HP_PERCENT",heal:"PLAYER_HEAL",dealDamage:"PLAYER_DEAL_DAMAGE",takeDamage:"PLAYER_TAKE_DAMAGE",fatelDmg:"PLAYER_FATEL_DAMAGE"},enemy:{die:"ENEMY_DIE"},boss:{},interaction:{trigger:"MAP_INTERACTION_TRIGGER"}};class C{constructor(){if(C.instance)return C.instance;C.instance=this,this.listeners=new Map,this.validEvents=new Set,this._initValidEvents(u)}_initValidEvents(t){for(const e in t)typeof t[e]=="object"?this._initValidEvents(t[e]):this.validEvents.add(t[e])}_checkEvent(t){this.validEvents.has(t)||console.warn(`[EventBus] 事件 "${t}" 不存在`)}on({event:t,handler:e,priority:i=0,maxCalls:s=1/0,onDispose:a=null,source:n=null}){this._checkEvent(t),this.listeners.has(t)||this.listeners.set(t,[]);const r=this.listeners.get(t),l={handler:e,priority:i,maxCalls:s,callCount:0,onDispose:a,source:n},o=r.findIndex(v=>i>v.priority);return o===-1?r.push(l):r.splice(o,0,l),()=>this.off(t,e)}off(t,e){this._checkEvent(t);const i=this.listeners.get(t);i&&this.listeners.set(t,i.filter(s=>s.handler===e?(s.onDispose&&s.onDispose(),!1):!0))}offBySource(t){for(const[e,i]of this.listeners.entries()){const s=i.filter(a=>a.source&&a.source===t?(a.onDispose&&a.onDispose(),!1):!0);s.length>0?this.listeners.set(e,s):this.listeners.delete(e)}}emit(t,e){this._checkEvent(t);const i=this.listeners.get(t);if(i)for(const s of[...i]){try{s.handler(e)}catch(a){console.error(`[EventBus] ${t} handler error`,a)}s.callCount++,s.callCount>=s.maxCalls&&this.off(t,s.handler)}}emitInterruptible(t,e){this._checkEvent(t);const i=this.listeners.get(t);if(!i)return!1;for(const s of[...i]){let a=!1;try{a=s.handler(e)===!0}catch(n){console.error(`[EventBus] ${t} handler error`,n)}if(s.callCount++,s.callCount>=s.maxCalls&&this.off(t,s.handler),a)return!0}return!1}emitReduce(t,e,i){this._checkEvent(t);const s=this.listeners.get(t);if(!s)return e;let a=e;for(const n of[...s]){try{const r=n.handler(a);r!==void 0&&(a=i(a,r))}catch(r){console.error(`[EventBus] ${t} handler error`,r)}n.callCount++,n.callCount>=n.maxCalls&&this.off(t,n.handler)}return a}}const f=new C;class S{constructor(t,e){this.position=t,this.size=e}add(t,e=new Vector(0,0)){return new S(t.addVector(this.position),e.addVector(this.size))}getCenter(){return this.position.addVector(this.size.scale(.5))}getTopLeft(){return this.position}getBottomRight(){return this.position.addVector(this.size)}contains(t){const e=this.getTopLeft(),i=this.getBottomRight();return t.x>=e.x&&t.x<=i.x&&t.y>=e.y&&t.y<=i.y}checkHit(t){const e=this.getTopLeft().x,i=this.getBottomRight().x,s=this.getTopLeft().y,a=this.getBottomRight().y,n=t.getTopLeft().x,r=t.getBottomRight().x,l=t.getTopLeft().y,o=t.getBottomRight().y;return!(i<=n||e>=r||s>=o||a<=l)}checkHits(t,e){for(let i of t)if(this.checkHit(i))return e(),i;return null}merge(t){let e=new Vector(Math.min(this.position.x,t.position.x),Math.min(this.position.y,t.position.y)),i=new Vector(Math.max(this.position.x+this.size.x,t.position.x+t.size.x),Math.max(this.position.y+this.size.y,t.position.y+t.size.y));return Y(e,i)}clip(t){let e=new Vector(Math.max(this.position.x,t.position.x),Math.max(this.position.y,t.position.y)),i=new Vector(Math.min(this.position.x+this.size.x,t.position.x+t.size.x),Math.min(this.position.y+this.size.y,t.position.y+t.size.y));return Y(e,i)}}const Y=(h,t)=>h.x>=t.x||h.y>=t.y?null:new S(h,t.subVector(h));let d=class w{constructor(t=0,e=0){this.x=t,this.y=e}copy(){return new w(this.x,this.y)}getAxis(t){return t===0?this.x:this.y}add(t,e){return new w(this.x+t,this.y+e)}addVector(t){return this.add(t.x,t.y)}sub(t,e){return this.add(-t,-e)}subVector(t){return this.sub(t.x,t.y)}addEqual(t){return this.x+=t.x,this.y+=t.y,this}subEqual(t){return this.x-=t.x,this.y-=t.y,this}scale(t){return new w(this.x*t,this.y*t)}magnitude(){return Math.sqrt(this.x**2+this.y**2)}normalize(){const t=this.magnitude();return t===0?new w(0,0):new w(this.x/t,this.y/t)}dot(t){return this.x*t.x+this.y*t.y}rotate(t){const e=Math.cos(t),i=Math.sin(t),s=this.x*e-this.y*i,a=this.x*i+this.y*e;return new w(s,a)}angle(){return Math.atan2(this.y,this.x)}round(){return new w(Math.round(this.x),Math.round(this.y))}};class $ extends S{constructor(t,e,i){super(new d(t.x,t.y),new d(e.x,e.y)),this.type=i}}class W extends S{constructor(t,e,i,s,a={}){super(new d(t.x,t.y),new d(e.x,e.y)),this.type=i,this.autoTrigger=!!s,Object.assign(this,a)}}class O{constructor(){if(O.instance)return O.instance;O.instance=this,this.backgrounds=[],this.blocks=[],this.textures=[],this.interactions=[],this.mapHitBox=new S(new d(0,0),new d(1280,720)),this._triggeredInteractionIds=new Set}async loadRoom(t,e){const i=`assets/stages/layer${t}/room${e}.json`,s=`assets/stages/layer${t}/Room${e}.json`;try{let a=null;try{a=await G.loadJSON(i)}catch{a=await G.loadJSON(s)}this.rawMapData=JSON.parse(JSON.stringify(a)),this.currentLayer=typeof t=="string"?parseInt(t,10):t,this.currentRoom=typeof e=="string"?parseInt(e,10):e,this.playerSpawn=a.playerSpawn?{...a.playerSpawn}:null,this.enemySpawns=Array.isArray(a.enemySpawns)?a.enemySpawns.map(o=>({...o})):[],this.backgrounds=(a.backgrounds||[]).map(o=>({...o})),this.blocks=(a.blocks||[]).map(o=>new $(o.position,o.size,o.type)),this.textures=(a.textures||[]).map(o=>({...o}));const n=(a.interactions||[]).map((o,v)=>new W(o.position,o.size,o.type,o.autoTrigger,{...o,__id:v}));this.interactions=[...n.filter(o=>o.autoTrigger),...n.filter(o=>!o.autoTrigger)],this.blockHitboxes=this.blocks.map(o=>new S(new d(o.position.x,o.position.y),new d(o.size.x,o.size.y)));const r=this.interactions.filter(o=>o.autoTrigger),l=this.interactions.filter(o=>!o.autoTrigger);this.interactionHitboxes=[...r.map(o=>new S(new d(o.position.x,o.position.y),new d(o.size.x,o.size.y))),...l.map(o=>new S(new d(o.position.x,o.position.y),new d(o.size.x,o.size.y)))],this._triggeredInteractionIds.clear()}catch(a){console.error("MapManager.loadRoom error:",a)}}getPlayerSpawn(){return this.playerSpawn}getEnemySpawns(){return this.enemySpawns||[]}getBlockHitboxes(){return this.blockHitboxes||[]}getInteractionHitboxes(){return this.interactionHitboxes||[]}update(t,e){try{if(!e||!this.interactionHitboxes||this.interactionHitboxes.length===0)return;const i=e.hitbox||e.getHitbox?.();if(!i)return;for(let s=0;s<this.interactions.length;s++){const a=this.interactions[s],n=this.interactionHitboxes[s];if(!n)continue;const r=i.checkHit(n),l=this._triggeredInteractionIds.has(a.__id);if(r){if(a.autoTrigger&&!l){this._triggeredInteractionIds.add(a.__id),f.emit(u.interaction.trigger,{type:a.type,event:a.event,data:a});continue}!a.autoTrigger&&x.isKeyDown&&x.isKeyDown("KeyE")&&f.emit(u.interaction.trigger,{type:a.type,event:a.event,data:a})}}}catch(i){console.error("MapManager.update error:",i)}}draw(t){for(const e of this.backgrounds)this.drawItem(t,e,"background");for(const e of this.blocks)this.drawItem(t,e,"block");for(const e of this.textures)this.drawItem(t,e,"texture")}drawItem(t,e,i){t.save();let s=null,a=i+"s";s=M.getTexture(a,e.type),s?t.drawImage(s,e.position.x,e.position.y,e.size.x,e.size.y):(i==="background"?t.fillStyle="#e0e0e0":i==="block"?t.fillStyle="#654321":i==="texture"?t.fillStyle="#8888ff":t.fillStyle="#cccccc",t.fillRect(e.position.x,e.position.y,e.size.x,e.size.y)),t.restore()}}const b=new O;class F{constructor(t=0){this.t=0,this.cd=t}start(){this.t=this.cd}tick(t){this.t=Math.max(0,this.t-t)}ready(){return this.t===0}reset(){this.t=0}set(t=0){this.cd=t}}class Q{constructor(t,e,i,s,a){this.baseJump=t,this.maxJump=e,this.gravity=i,this.coyoteTime=s,this.jumpBuffer=new F(a),this.jumpBufferTime=a,this.isJumping=!1,this.isFalling=!1,this.jumpVelocity=0,this.chargeTime=0,this.coyoteTimer=0,this.times=1}startJump(){this.isJumping=!0,this.isFalling=!1,this.chargeTime=0,this.jumpBuffer.reset(),this.coyoteTimer=0,z.playSound(this.type,"jump")}updateJump(t,e,i){this.jumpBuffer.tick(e),i?(this.coyoteTimer=this.coyoteTime,this.isJumping=!1,this.isFalling=!1,!i&2&&(this.jumpVelocity=0),i&2?this.times=1.5:this.times=1,this.jumpBuffer.ready()||this.startJump()):(this.isJumping||(this.isFalling=!0),this.coyoteTimer=Math.max(this.coyoteTimer-e,0),!this.isJumping&&!this.jumpBuffer.ready()&&this.coyoteTimer>0&&this.startJump()),this.isJumping?!this.isFalling&&t&&this.chargeTime<this.maxJump*this.times?(this.chargeTime+=e,this.jumpVelocity=Math.min(this.baseJump+this.chargeTime/this.maxJump*this.times*(this.maxJump*this.times-this.baseJump),this.maxJump*this.times)):(this.isFalling=!0,this.updateFalling(e)):this.isFalling&&this.updateFalling(e)}updateFalling(t){this.jumpVelocity-=this.gravity*t,this.jumpVelocity=Math.max(-6*this.baseJump,this.jumpVelocity)}}class U{constructor(t,e,i=new d){this.type="",this.velocity=i,this.hitbox=new S(t,e),this.jumping=new Q(4,9,.5,8,15),this.MaxSpeed=6,this.attackBox=null,this.hurtBox=null}getCenter(){return this.hitbox.getCenter()}isOnGround(){if(this.velocity.y<0)return!1;this.hitbox.position.y+=1;let t=!1;const e=b.getBlockHitboxes();return t=!!this.hitbox.checkHits(e,()=>{}),this.hitbox.position.y-=1,t&&(this.isflying=0),t}rigidMove(t){let e=this.velocity.scale(t).round(),i=0,s=b.getBlockHitboxes();for(let a=0;a<Math.abs(e.x);++a)if(this.hitbox.position.x+=Math.sign(e.x),this.hitbox.checkHits(s,()=>{this.hitbox.position.x-=Math.sign(e.x)})){i|=1;break}for(let a=0;a<Math.abs(e.y);++a)if(this.hitbox.position.y+=Math.sign(e.y),this.hitbox.checkHits(s,()=>{this.hitbox.position.y-=Math.sign(e.y)})){i|=2;break}return i}updateY(t,e){this.jumping.updateJump(e,t,this.isOnGround())}updateX(t,e){const i=this.isOnGround();let s=this.velocity.x;if(i){if(e===0)s*=Math.exp(-.5*t);else{const a=10*t;s=e*Math.min(Math.sqrt(this.velocity.x*this.velocity.x+a),this.MaxSpeed)}e&&z.playSound(this.type,"walk")}else{const a=.3*t;e!==0?(s+=a*(e*this.MaxSpeed-this.velocity.x),Math.abs(s)>this.MaxSpeed&&(s=this.MaxSpeed*Math.sign(s))):s*=Math.exp(-.05*t)}return s}updateXY(t,e,i){this.updateY(t,i()),this.velocity.y=-this.jumping.jumpVelocity,this.velocity.x=this.updateX(t,e());let s=this.rigidMove(t);s&1&&(this.velocity.x=0),s&2&&(this.velocity.y=this.jumping.jumpVelocity=0)}update(t){deltaFrame=60*t/1e3,this.updateXY(deltaFrame,()=>0,()=>0)}draw(t){t.fillStyle="rgba(221, 100, 0, 1)",t.fillRect(this.hitbox.position.x,this.hitbox.position.y,this.hitbox.size.x,this.hitbox.size.y)}}class Z extends U{constructor(t,e,i,s,a=new d(10,10)){super(t,a,e),this.type="projectile",this.damage=i,this.alive=!0,this.hurtBox=this.hitbox,this.from=s,j.add(this)}update(t){if(!this.alive)return;const e=60*t/1e3;if(this.rigidMove(e)){this.alive=!1;return}this.from.targetSelector().forEach(s=>{this.hurtBox.checkHit(s.hurtBox)&&(this.from.applyDamage(s,this.damage),this.alive=!1)})}draw(t){this.alive&&(t.fillStyle="yellow",t.fillRect(this.hitbox.position.x,this.hitbox.position.y,this.hitbox.size.x,this.hitbox.size.y))}}class I{constructor(){if(I.instance)return I.instance;I.instance=this,this.projectiles=[]}add(t){this.projectiles.push(t)}update(t){this.projectiles.forEach(e=>e.update(t)),this.projectiles=this.projectiles.filter(e=>e.alive)}draw(t){this.projectiles.forEach(e=>e.draw(t))}clear(){this.projectiles.length=0}}const j=new I;class tt{constructor(t=0){this.duration=t,this.remainingTime=0}start(t=null){t!==null&&(this.duration=t),this.remainingTime=this.duration}tick(t){this.remainingTime=Math.max(0,this.remainingTime-t)}expired(){return this.remainingTime<=0}reset(){this.remainingTime=0}remaining(){return this.remainingTime}set(t){this.duration=t}}const m={player:{ATK:"PLAYER_ATK",HP:"PLAYER_HP",SPD:"PLAYER_SPD",HEAL:"PLAYER_HEAL",DMG:"PLAYER_DMG",LOS:"PLAYER_LOS",TAKE_DMG:"PLAYER_TAKE_DAMAGE",AttackStartupTime:"PLAYER_AttackStartupTime",AttackRecoveryTime:"PLAYER_AttackRecoveryTime",MeteeStartupTime:"PLAYER_MeteeStartupTime",MeteeRecoveryTime:"PLAYER_MeteeRecoveryTime",RangedStartupTime:"PLAYER_RangedStartupTime",RangedRecoveryTime:"PLAYER_RangedRecoveryTime"},enemy:{ATK:"ENEMY_ATK",HP:"ENEMY_HP",DMG:"ENEMY_DMG",DMG_DEC:"ENEMY_DMG_DEC",AttackStartupTime:"ENEMY_AttackStartupTime",AttackRecoveryTime:"ENEMY_AttackRecoveryTime",MeteeStartupTime:"ENEMY_MeteeStartupTime",MeteeRecoveryTime:"ENEMY_MeteeRecoveryTime",RangedStartupTime:"ENEMY_RangedStartupTime",RangedRecoveryTime:"ENEMY_RangedRecoveryTime"},boss:{ATK:"BOSS_ATK",HP:"BOSS_HP",AttackStartupTime:"BOSS_AttackStartupTime",AttackRecoveryTime:"BOSS_AttackRecoveryTime",MeteeStartupTime:"BOSS_MeteeStartupTime",MeteeRecoveryTime:"BOSS_MeteeRecoveryTime",RangedStartupTime:"BOSS_RangedStartupTime",RangedRecoveryTime:"BOSS_RangedRecoveryTime"}};class H{constructor(){if(H.instance)return H.instance;H.instance=this,this.attributes={},this.validAttributes=new Set,this._initValidAttributes(m)}_initValidAttributes(t){for(const e in t)typeof t[e]=="object"?this._initValidAttributes(t[e]):this.validAttributes.add(t[e])}_checkAttr(t){const e=this.validAttributes.has(t);return e||console.warn(`[AttributeManager] 属性 "${t}" 不存在`),e}addAttr(t,e,i,s=null,a=null){if(!this._checkAttr(t))return;this.attributes[t]||(this.attributes[t]={}),this.attributes[t][i]||(this.attributes[t][i]=[]);const n=this.attributes[t][i];for(;a&&n.length>=a;)n.shift();const r=s!==null?new tt(s):null;r&&r.start(s),n.push({value:e,timer:r})}removeAttrBySource(t,e){this.attributes[t]&&delete this.attributes[t][e]}removeOneAttrLayer(t,e){if(!this._checkAttr(t)||!this.attributes[t]||!this.attributes[t][e])return!1;const i=this.attributes[t][e];return i.length===0?!1:(i.shift(),i.length===0&&delete this.attributes[t][e],!0)}removeAllAttrBySource(t){for(const e of Object.keys(this.attributes))this.attributes[e][t]&&delete this.attributes[e][t]}refreshAttrDuration(t,e,i){if(this._checkAttr(t)&&!(!this.attributes[t]||!this.attributes[t][e]))for(const s of this.attributes[t][e])s.timer&&s.timer.start(i)}getAttrSum(t){if(!this._checkAttr(t)||!this.attributes[t])return 0;let e=0;for(const i of Object.keys(this.attributes[t])){const s=this.attributes[t][i];e+=s.reduce((a,n)=>a+n.value,0)}return e}getAttrStackCount(t,e){return!this._checkAttr(t)||!this.attributes[t]||!this.attributes[t][e]?0:this.attributes[t][e].length}getAllAttrByType(t){const e={};for(const i of Object.keys(t)){const s=t[i];e[s]=this.getAttrSum(s)}return e}getAllAttr(){const t={};for(const e of Object.keys(this.attributes))t[e]=this.getAttrSum(e);return t}update(t){for(const e of Object.keys(this.attributes))for(const i of Object.keys(this.attributes[e])){const s=this.attributes[e][i];for(const a of s)a.timer&&a.timer.tick(t);this.attributes[e][i]=s.filter(a=>!a.timer||!a.timer.expired()),this.attributes[e][i].length===0&&delete this.attributes[e][i]}}}const g=new H;class V{constructor(t,e){this.owner=t,this.type=e,this.state="idle",this.timer=0}get damage(){return this.owner.state.attack.damage[this.type]}get startupTime(){return this.owner.state.attack.startupTime[this.type]}get recoveryTime(){return this.owner.state.attack.recoveryTime[this.type]}get targetSelector(){return this.owner.attack.targetSelector}trigger(){return this.state==="idle"?(this.state="startup",this.timer=this.startupTime,!0):!1}update(t){if(this.state!=="idle"&&(this.timer-=t,!(this.timer>0)))switch(this.state){case"startup":this.enterActive();break;case"active":this.enterRecovery();break;case"recovery":this.state="idle";break}}enterActive(){this.state="active",z.playSound(this.owner.type,this.type+"Attack"),this.onHit(this.owner,this.damage)}enterRecovery(){this.state="recovery",this.timer=this.recoveryTime}applyDamage(t,e){if(t.beforeTakeDamage&&!t.beforeTakeDamage())return;let i=e;this.owner.dealDamageEvent&&(i=f.emitReduce(this.owner.dealDamageEvent,{baseDamage:i},(s,a)=>a).baseDamage),t.takeDamage(i,this.type)}onHit(t,e){}}class X extends V{constructor(t){super(t,"melee")}onHit(t,e){const s=t.facing>0?t.hitbox.size.x/2:-t.hitbox.size.x/2,a=t.hitbox.position.addVector(new d(s,t.hitbox.size.y*.25)),n=new d(t.hitbox.size.x*.8,t.hitbox.size.y*.5),r=new S(a,n);this.targetSelector().forEach(l=>{r.checkHit(l.hurtBox)&&this.applyDamage(l,e)})}}class et extends V{constructor(t){super(t,"ranged")}onHit(t,e){const s=t.facing,a=t.hitbox.getCenter();new Z(a,new d(12*s,0),e,this)}}class it{static Framerate={run:6,jump:30,fall:30,stand:8};static Frames={run:6,jump:4,fall:2,stand:7};constructor(){this.status="run",this.facing=1,this.frame=1,this.frameRun=0}setStatus(t,e){(t!=this.status||e!=this.facing)&&(this.frame=1,this.frameRun=0,this.status=t,this.facing=e)}update(t){}getFrame(){return M.getTexture("player",0)}}class B extends U{static getSaveData(){return{position:this.instance.hitbox.position,state:this.instance.state,inventory:[],timestamp:new Date().toISOString()}}static loadSaveData(t){this.instance&&(this.instance.hitbox.position=t.position,this.instance.state=t.state)}constructor(t=new d(50,50)){if(B.instance)return B.instance;super(new d,t,new d),B.instance=this,this.size=t,this.type="player",this.jumping.type="player",this.baseState={hp_max:100,attack:{atk:10,MeleeStartupTime:50,MeleeRecoveryTime:900,RangedStartupTime:150,RangedRecoveryTime:700},dash_cooldownTime:600,dash_maxCount:1},this.state={hp:this.baseState.hp_max,hp_max:this.baseState.hp_max,attack:{atk:this.baseState.attack.atk,damage:{melee:this.baseState.attack.atk,ranged:this.baseState.attack.atk},startupTime:{melee:this.baseState.attack.MeleeStartupTime,ranged:this.baseState.attack.RangedStartupTime},recoveryTime:{melee:this.baseState.attack.MeleeRecoveryTime,ranged:this.baseState.attack.RangedRecoveryTime}}},this.attack={targetSelector:()=>A.enemies,melee:new X(this),ranged:new et(this)},this.facing=1,this.animation=new it,this.initDash(),this.hurtBox=this.hitbox,this.controllerX=()=>{if(this.blockMove)return 0;let e=x.isKeysDown(["A","Left"]),i=x.isKeysDown(["D","Right"]),s=0;return e&&i?s=0:e?this.facing=s=-1:i&&(this.facing=s=1),s},this.controllerY=()=>this.blockMove?0:(x.isFirstDown("Space")&&this.jumping.jumpBuffer.start(),x.isHeld("Space")),this.dealDamageEvent=u.player.dealDamage}update(t){this.updateState(),f.emit(u.player.hpPercent,this.state.hp/this.state.hp_max),x.isKeyDown("J")&&this.attack.melee.trigger(),x.isKeyDown("L")&&this.attack.ranged.trigger(),this.attack.melee.update(t),this.attack.ranged.update(t),this.dash.update(t);const e=60*t/1e3;this.updateXY(e,this.controllerX(),this.controllerY()),this.jumping.jumpVelocity>0?this.animation.setStatus("jump",this.facing):this.isOnGround()?this.animation.setStatus("stand",this.facing):this.jumping.jumpVelocity<0&&this.animation.setStatus("fall",this.facing),this.animation.update(e)}updateXY(t,e,i){this.dash.isDashing||(this.updateY(t,i),this.velocity.y=-this.jumping.jumpVelocity,this.velocity.x=this.updateX(t,e));let s=this.rigidMove(t);s&1&&(this.velocity.x=0,this.dash.isDashing=0),s&2&&(this.velocity.y=this.jumping.jumpVelocity=0)}updateState(){const t=g.getAttrSum(m.player.HP),e=g.getAttrSum(m.player.ATK),i=g.getAttrSum(m.player.DMG),s=g.getAttrSum(m.player.MeteeStartupTime),a=g.getAttrSum(m.player.MeteeRecoveryTime),n=g.getAttrSum(m.player.RangedStartupTime),r=g.getAttrSum(m.player.RangedRecoveryTime);this.state.hp_max=this.baseState.hp_max*(1+t),this.state.hp=Math.min(this.state.hp,this.state.hp_max),this.state.attack.atk=this.baseState.attack.atk*(1+e),this.state.attack.damage.melee=this.state.attack.atk*(1+i),this.state.attack.damage.ranged=this.state.attack.atk*(1+i),this.state.attack.startupTime.melee=this.baseState.attack.MeleeStartupTime+s,this.state.attack.startupTime.ranged=this.baseState.attack.RangedStartupTime+n,this.state.attack.recoveryTime.melee=this.baseState.attack.MeleeRecoveryTime+a,this.state.attack.recoveryTime.ranged=this.baseState.attack.RangedRecoveryTime+r}initDash(){this.dash={isDashing:!1,dashDuration:200,dashCooldownTime:this.baseState.dash_cooldownTime,dashSpeed:15,dashDir:{x:1,y:0},dashDurationCooldown:null,dashCooldown:null,dashMaxCount:this.baseState.dash_maxCount,dashCount:0,update:null},this.dash.dashDurationCooldown=new F(this.dash.dashDuration),this.dash.dashCooldown=new F(this.dash.dashCooldownTime),this.dash.update=t=>{this.isOnGround()&&(this.dash.dashCooldown.tick(t),this.dash.dashCooldown.ready()&&this.dash.dashCount<this.dash.dashMaxCount&&(this.dash.dashCount++,this.dash.dashCooldown.start()));let e=0,i=0;if(x.isKeysDown(["A","Left"])&&(e-=1),x.isKeysDown(["D","Right"])&&(e+=1),x.isKeysDown(["W","Up"])&&(i-=1),x.isKeysDown(["S","Down"])&&(i+=1),!this.dash.isDashing&&this.dash.dashCount>0&&x.isKeyDown("K")){e===0&&i===0&&(e=this.facing);let s=Math.sqrt(e*e+i*i);s===0&&(s=1),this.dash.dashDir={x:e/s,y:i/s},this.dash.isDashing=!0,this.dash.dashDurationCooldown.start(),this.dash.dashCount--,z.playSound("player","dash")}this.dash.isDashing&&(this.dash.dashDurationCooldown.tick(t),this.velocity.x=this.dash.dashSpeed*this.dash.dashDir.x,this.velocity.y=this.dash.dashSpeed*this.dash.dashDir.y,this.dash.dashDurationCooldown.ready()&&(this.dash.isDashing=!1,this.jumping.jumpVelocity=-this.velocity.y))}}beforeTakeDamage(t){return this.dash.isDashing!==!0}takeDamage(t,e){let i=f.emitReduce(u.player.takeDamage,{baseDamage:t},(s,a)=>a).baseDamage;this.state.hp-=i,this.state.hp<=0&&(f.emitInterruptible(u.player.fatelDmg)||(f.emit(u.player.die),alert("你死了")))}takeHeal(t,e=null){let i=t*(1+g.getAttrSum(m.player.HEAL));i=f.emitReduce(u.player.heal,{baseHeal:i},(a,n)=>n).baseHeal;const s=Math.max(0,i);this.state.hp=Math.min(this.state.hp_max,this.state.hp+s)}setPosition(t){this.hitbox.position=t}draw(t){t.drawImage(this.animation.getFrame(),this.hitbox.position.x,this.hitbox.position.y,this.size.x,this.size.y);const e=this.size.x,i=6,s=this.hitbox.position.x,a=this.hitbox.position.y-12;t.save(),t.fillStyle="red",t.fillRect(s,a,e,i),t.fillStyle="green";const n=Math.max(this.state.hp,0)/this.state.hp_max,r=e*n;t.fillRect(s,a,r,i),t.strokeStyle="black",t.strokeRect(s,a,e,i),t.restore(),this.drawDashUI(t)}drawBoxs(t){t.strokeStyle=this.isInvulnerable?"#cccccc":"#00aaff",t.strokeRect(this.hitbox.position.x,this.hitbox.position.y,this.hitbox.size.x,this.hitbox.size.y),t.strokeStyle="#ff0000";const e=.5*(this.facing>=0?this.hitbox.size.x:-this.hitbox.size.x),i=this.hitbox.position.addVector(new d(e,this.hitbox.size.y*.2)),s=new d(this.hitbox.size.x*.8,this.hitbox.size.y*.5);t.strokeRect(i.x,i.y,s.x,s.y),t.restore()}drawDashUI(t){const e=this.dash.dashMaxCount,i=this.dash.dashCount,s=8,a=4,n=this.hitbox.position.x+this.size.x/2-(e*(s+a)-a)/2,r=this.hitbox.position.y-24;for(let l=0;l<e;l++)t.fillStyle=l<i?"cyan":"gray",t.fillRect(n+l*(s+a),r,s,s),t.strokeStyle="black",t.strokeRect(n+l*(s+a),r,s,s)}}const y=new B;class st{static Framerate={run:6,jump:30,fall:30,stand:8};static Frames={run:6,jump:4,fall:2,stand:7};constructor(){this.status="run",this.facing=1,this.frame=1,this.frameRun=0}setStatus(t,e){(t!=this.status||e!=this.facing)&&(this.frame=1,this.frameRun=0,this.status=t,this.facing=e)}update(t){}getFrame(){return M.getTexture("enemy",0)}}class at extends U{constructor(t,e,i=new d(50,50),s=new d){super(e,i,s),this.Size=i,this.type="enemy"+t,this.enemytype=t,this.baseState={hp_max:100,attack:{atk:10,MeleeStartupTime:50,MeleeRecoveryTime:900,RangedStartupTime:150,RangedRecoveryTime:700}},this.state={hp:this.baseState.hp_max,hp_max:this.baseState.hp_max,attack:{damage:{melee:this.baseState.attack_baseDamage,ranged:this.baseState.attack_baseDamage},startupTime:{melee:this.baseState.attack_baseMeleeStartupTime,ranged:this.baseState.attack_baseRangedStartupTime},recoveryTime:{melee:this.baseState.attack_baseMeleeRecoveryTime,ranged:this.baseState.attack_baseRangedStartupTime}}},this.facing=1,this.animation=new st,this.attack={melee:new X(this),targetSelector:()=>[y]},this.hurtBox=this.hitbox,this._unbind_list=[]}update(t){this.updateState();const e=Math.abs(this.hitbox.getCenter().x-y.hitbox.getCenter().x),i=this.hitbox.getCenter().y-y.hitbox.getCenter().y;let s=!1,a="patrol";i>50?e<400&&Math.abs(i)<100&&(a="seek_path",this.hasDirectPathToPlayer()&&(s=Math.random()<.2)):i<-50?e<300&&Math.abs(i)<80&&(a="wait",this.hasSafeDropPath()&&(s=Math.random()<.3)):e<400&&Math.abs(i)<60&&(a="attack",s=Math.random()<.4),s&&this.attack.melee.trigger(),this.attack.melee.update(t),this.updateMovementByMode(a,e,i);const n=60*t/1e3;let r=0;this.updateXY(n,()=>{if(this.blockMove)return 0;if(r=0,a==="attack"||a==="seek_path")this.hitbox.position.x<y.hitbox.position.x?this.facing=r=1:this.facing=r=-1,r*=.3;else if(a==="wait")r=0;else{Math.random()<.002&&(this.facing=Math.random()<.5?1:-1);const l=this.hitbox.position.x+this.facing*2,o=new S(new d(l,this.hitbox.position.y),this.hitbox.size),v=b.getBlockHitboxes();let E=!1;for(const J of v)if(o.checkHit(J)){E=!0;break}(E||l<0||l>1280)&&(this.facing=-this.facing),r=this.facing*.2}return r},()=>{if(this.blockMove||!(a==="attack"||a==="seek_path"))return 0},!0),this.jumping.jumpVelocity>0?this.animation.setStatus("jump",this.facing):this.isOnGround()?r?this.animation.setStatus("run",this.facing):this.animation.setStatus("stand",this.facing):this.jumping.jumpVelocity<0&&this.animation.setStatus("fall",this.facing),this.animation.update(n)}hasDirectPathToPlayer(){const t=y.hitbox.position,e=this.hitbox.position,i=b.getBlockHitboxes(),s=new S(new d(Math.min(e.x,t.x),Math.min(e.y,t.y)),new d(Math.abs(t.x-e.x),Math.abs(t.y-e.y)));for(const a of i)if(s.checkHit(a))return!1;return!0}hasSafeDropPath(){y.hitbox.position;const t=this.hitbox.position,e=b.getBlockHitboxes(),i=t.y+100,s=new S(new d(t.x,t.y),new d(this.hitbox.size.x,i-t.y));for(const a of e)if(s.checkHit(a))return!0;return!1}updateMovementByMode(t,e,i){switch(t){case"seek_path":this.seekVerticalPath();break;case"wait":this.waitForPlayer();break;case"attack":this.normalMovement();break;case"patrol":default:this.patrolMovement();break}}seekVerticalPath(){const t=y.hitbox.position,e=this.hitbox.position,i=b.getBlockHitboxes();let s=null,a=1/0;for(const n of i)if(n.position.y<e.y&&n.position.y>t.y-50){const r=Math.abs(n.position.x-e.x);r<a&&(a=r,s=n)}s?this.moveToTarget(s):this.wait()}waitForPlayer(){this.hasSafeDropPath()?this.seekDropPoint():this.patrolMovement()}normalMovement(){}patrolMovement(){Math.random()<.02&&(this.facing=Math.random()<.5?1:-1);const t=this.hitbox.position.x+this.facing*2,e=new S(new d(t,this.hitbox.position.y),this.hitbox.size),i=b.getBlockHitboxes();let s=!1;for(const a of i)if(e.checkHit(a)){s=!0;break}(s||t<0||t>1280)&&(this.facing=-this.facing)}moveToTarget(t){const e=t.position,i=this.hitbox.position;e.x>i.x?this.facing=1:e.x<i.x&&(this.facing=-1),e.y<i.y&&this.isOnGround()&&this.jumping.jumpBuffer.start()}seekDropPoint(){const t=y.hitbox.position,e=this.hitbox.position,i=b.getBlockHitboxes();let s=null,a=1/0;for(const n of i)if(n.position.y>e.y&&n.position.y<t.y+50){const r=Math.abs(n.position.x-e.x);r<a&&(a=r,s=n)}s&&this.moveToTarget(s)}wait(){}updateState(){const t=g.getAttrSum(m.enemy.HP),e=g.getAttrSum(m.enemy.ATK),i=g.getAttrSum(m.enemy.DMG),s=g.getAttrSum(m.enemy.DMG_DEC),a=g.getAttrSum(m.enemy.MeteeStartupTime),n=g.getAttrSum(m.enemy.MeteeRecoveryTime),r=g.getAttrSum(m.enemy.RangedStartupTime),l=g.getAttrSum(m.enemy.RangedRecoveryTime);this.state.hp_max=this.baseState.hp_max*(1+t),this.state.hp=Math.min(this.state.hp,this.state.hp_max),this.state.attack.atk=this.baseState.attack.atk*(1+e),this.state.attack.startupTime.melee=this.baseState.attack.MeleeStartupTime+a,this.state.attack.startupTime.ranged=this.baseState.attack.RangedStartupTime+r,this.state.attack.recoveryTime.melee=this.baseState.attack.MeleeRecoveryTime+n,this.state.attack.recoveryTime.ranged=this.baseState.attack.RangedRecoveryTime+l;let o=this.state.attack.atk*(1+i);o=Math.max(o-s,.1*o),this.state.attack.damage.melee=o,this.state.attack.damage.ranged=o}takeDamage(t,e){if(this.state.hp-=t,this.state.hp<=0){f.emit(u.enemy.die,{attackType:e}),this._unbind_list.forEach(s=>s()),this._unbind_list=[];const i=A.enemies.indexOf(this);i!==-1&&A.enemies.splice(i,1)}}draw(t){t.drawImage(M.getTexture("enemy",this.enemytype),this.hitbox.position.x,this.hitbox.position.y,this.Size.x,this.Size.y);const e=this.Size.x,i=6,s=this.hitbox.position.x,a=this.hitbox.position.y-12;t.save(),t.fillStyle="red",t.fillRect(s,a,e,i),t.fillStyle="green";const n=Math.max(this.state.hp,0)/this.state.hp_max,r=e*n;t.fillRect(s,a,r,i),t.strokeStyle="black",t.strokeRect(s,a,e,i),t.restore()}drawBoxs(t){t.strokeStyle=this.isInvulnerable?"#cccccc":"#00aaff",t.strokeRect(this.hitbox.position.x,this.hitbox.position.y,this.hitbox.size.x,this.hitbox.size.y),t.strokeStyle="#ff0000";const e=.5*(this.facing>=0?this.hitbox.size.x:-this.hitbox.size.x),i=this.hitbox.position.addVector(new d(e,this.hitbox.size.y*.25)),s=new d(this.hitbox.size.x*.8,this.hitbox.size.y*.5);t.strokeRect(i.x,i.y,s.x,s.y),t.restore()}}let nt=0;class rt{constructor(t){if(this.config=t,this.state=t.state?{...t.state}:{},this._instanceId=`${t.id}_${nt++}`,this.tags=[...t.tags||[]],t.effects)for(const e in t.effects)g.addAttr(e,t.effects[e],this._instanceId);if(t.hooks)for(const e of t.hooks(this)){const i={...e,handler:e.handler.bind(this),source:this._instanceId};f.on(i)}typeof t.onAcquire=="function"&&t.onAcquire(this)}addTag(t){this.tags.includes(t)||this.tags.push(t)}removeTag(t){this.tags=this.tags.filter(e=>e!==t)}hasTag(t){return this.tags.includes(t)}canRemove(){return typeof this.config.canRemove=="function"?this.config.canRemove(this):!0}onRemove(){typeof this.config.onRemove=="function"&&this.config.onRemove(this)}dispose(){this.config.effects&&g.removeAllAttrBySource(this._instanceId),f.offBySource(this._instanceId),this.onRemove()}}const c={NO_EXCHANGE:"noExcgange",NO_DROP:"noDrop",NO_RANDOM:"noRandom",SPECIAL_EXCHANGE:"specialExchange",UNIQUE_GLOBAL:"uniqueGlobal",UNIQUE_SINGLE:"uniqueSingle",MULTIPLE:"multiple"},p={ENDING:"end",NORMAL:"normal"},D={yy友谊:{id:"友谊",level:1,type:p.NORMAL,tags:[c.NO_EXCHANGE,c.NO_DROP,c.NO_RANDOM],effects:{[m.player.HP]:.25,[m.player.DMG]:.25,[m.boss.ATK]:.25,[m.boss.HP]:.3},hooks:h=>[{event:u.game.tick,handler:({deltaTime:t})=>h.state.healTimer.tick(t),priority:1},{event:u.player.hpPercent,handler:t=>{t<.25&&h.state.healTimer.ready()&&(h.state.healTimer.start(),y.takeHeal(y.state.hp_max*.01,h._instanceId))}},{event:u.player.fatelDmg,handler:()=>(y.state.hp=y.state.hp_max,f.on({event:u.game.battle.end,handler:()=>{k.remove(h),k.tryAcquire(D.bc悲怆)},maxCalls:1}),!0),maxCalls:1},{event:u.game.finish,handler:t=>{t.unlockEnding?.("hidden_path_friendship",{desc:"使探索开启不同的方向"})},maxCalls:1}],onAcquire(h){},state:{healTimer:new F(1e3)}},bc悲怆:{id:"悲怆",level:1,type:p.NORMAL,tags:[c.NO_EXCHANGE,c.NO_DROP,c.NO_RANDOM],effects:{[m.player.HP]:-.6},hooks:h=>[{event:u.enemy.die,handler:()=>{g.addAttr(m.player.HP,.08,h.id),g.getAttrStackCount(m.player.HP,h.id)==10&&f.on({event:u.game.battle.end,handler:()=>{k.remove(h),k.tryAcquire(D.sn思念)},maxCalls:1})}},{event:u.game.finish,handler:t=>{},maxCalls:1}],onAcquire(h){}},sn思念:{id:"思念",level:1,type:p.NORMAL,tags:[c.NO_RANDOM],effects:{[m.player.HP]:.2},hooks:h=>[{event:u.player.dealDamage,handler:t=>{switch(Math.floor(Math.random()*3)){case 0:return{...t,baseDamage:t.baseDamage*1.15};case 1:f.on({event:u.player.takeDamage,handler:e=>({...e,baseDamage:e*.7}),maxCalls:1,source:h._instanceId});break;case 2:y.takeHeal(y.state.hp_max*.01);break}}}],onAcquire(h){}},ds胆识:{id:"胆识",level:0,type:p.ENDING,tags:[c.NO_DROP,c.NO_RANDOM,c.SPECIAL_EXCHANGE],effects:{[m.enemy.DMG_DEC]:-15,[m.boss.HP]:.45},hooks:h=>[{event:u.game.finish,handler:t=>{},maxCalls:1}]},js决心:{id:"决心",level:0,type:p.ENDING,tags:[c.NO_DROP,c.NO_EXCHANGE,c.NO_RANDOM],effects:{[m.enemy.DMG_DEC]:-10,[m.player.ATK]:.35,[m.player.HP]:-.2},hooks:h=>[{event:u.game.finish,handler:t=>{},maxCalls:1}],onAcquire(h){y.state.hp=y.state.hp_max}},yy犹疑:{id:"犹疑",level:0,type:p.ENDING,tags:[c.NO_DROP,c.NO_RANDOM,c.SPECIAL_EXCHANGE],effects:{[m.player.SPD]:-.4,[m.player.ATK]:-.2}},gw观望:{id:"观望",level:0,type:p.ENDING,tags:[c.NO_DROP,c.NO_EXCHANGE,c.NO_RANDOM],effects:{}},hq好奇:{id:"好奇",level:1,type:p.NORMAL,tags:[c.NO_DROP,c.NO_EXCHANGE,c.UNIQUE_GLOBAL,c.SPECIAL_EXCHANGE],effects:{[m.player.TAKE_DMG]:.3},hooks:h=>[{event:u.game.enter.shop,handler:()=>{h.removeTag(c.NO_DROP),h.removeTag(c.NO_EXCHANGE)}}],onAcquire(h){}},zx珍惜:{id:"珍惜",level:1,type:p.NORMAL,tags:[c.NO_EXCHANGE,c.UNIQUE_GLOBAL,c.SPECIAL_EXCHANGE,c.NO_RANDOM],effects:{},hooks:h=>[{event:u.game.enter.shop,handler:()=>{h.removeTag(c.NO_EXCHANGE)}}],onAcquire(h){},onExchange(h){}},ls朗诵:{id:"朗诵",level:1,type:p.NORMAL,tags:[c.NO_RANDOM],onAcquire(h){k.addSlots(2,{maxLevel:1,type:p.NORMAL},h._instanceId)},canRemove:h=>k.slots.filter(e=>e._sourceItem===h._instanceId).every(e=>e.item==null)},xq休憩:{id:"休憩",level:1,type:p.NORMAL,tags:[c.MULTIPLE],hooks:h=>[{event:u.item.use,handler:({usedItem:t})=>{t===h&&(y.takeHeal(y.state.hp_max*.4,h._instanceId),k.remove(h))}}]},jy惊讶:{id:"惊讶",level:1,type:p.NORMAL},dg祷告:{id:"祷告",level:1,type:p.NORMAL,tags:[c.SPECIAL_EXCHANGE],effects:{[m.player.LOS]:-.3}}};class K{constructor(){if(K.instance)return K.instance;K.instance=this,this.slots=[{maxLevel:1/0,type:p.ENDING,item:null},{maxLevel:3,type:p.NORMAL,item:null},{maxLevel:2,type:p.NORMAL,item:null},{maxLevel:2,type:p.NORMAL,item:null},{maxLevel:2,type:p.NORMAL,item:null},{maxLevel:1,type:p.NORMAL,item:null},{maxLevel:1,type:p.NORMAL,item:null},{maxLevel:1,type:p.NORMAL,item:null}],this.selectedIndex=0,this.acquiredHistory=new Set}tryAcquire(t){if(t.tags||(t.tags=[]),!t.tags.includes(c.UNIQUE_GLOBAL)&&!t.tags.includes(c.MULTIPLE)&&(t.tags.includes(c.UNIQUE_SINGLE)||t.tags.push(c.UNIQUE_SINGLE)),t.tags?.includes(c.UNIQUE_GLOBAL)&&this.acquiredHistory.has(t.id)||t.tags?.includes(c.UNIQUE_SINGLE)&&this.slots.some(a=>a.item?.config.id===t.id))return null;const e=this.slots.findIndex(s=>!(s.item||s.type&&s.type!==t.type||s.maxLevel<t.level));if(e===-1)return null;console.log(t);const i=new rt(t);return t.tags?.includes(c.UNIQUE_GLOBAL)&&this.acquiredHistory.add(t.id),this.slots[e].item=i,i._slotIndex=e,i}remove(t){const e=this.slots.findIndex(i=>i.item===t);if(e===-1)return!1;if(!t.canRemove())return console.warn("该道具暂时不能移除"),!1;t.dispose(),this.slots[e].item=null,this.slots=this.slots.filter(i=>i._source!==t._instanceId)}getAt(t){return this.slots[t]?.item||null}getAll(){return this.slots.map(t=>t.item)}selectNext(){this.selectedIndex=(this.selectedIndex+1)%this.slots.length}selectPrev(){this.selectedIndex=(this.selectedIndex-1+this.slots.length)%this.slots.length}getSelectedSlot(){return this.slots[this.selectedIndex]||null}getSelectedItem(){return this.slots[this.selectedIndex]?.item||null}move(t,e){if(e<0||e>=this.slots.length)return!1;const i=this.slots[e];if(i.item||i.type&&i.type!==t.config.type||i.maxLevel<t.config.level)return!1;const s=t._slotIndex;return s===void 0?!1:(this.slots[s].item=null,i.item=t,t._slotIndex=e,!0)}addSlots(t,e={}){const{maxLevel:i=1,type:s=p.NORMAL}=e;for(let a=0;a<t;a++)this.slots.push({maxLevel:i,type:s,item:null})}addSlots(t,e={},i=null){const{maxLevel:s=1,type:a=p.NORMAL}=e,n=[];for(let r=0;r<t;r++){const l={maxLevel:s,type:a,item:null,_source:i};this.slots.push(l),n.push(l)}return n}getRandomConfig(t,e={}){const{exclude:i=[],type:s=p.NORMAL}=e,a=Object.values(D).filter(r=>!(r.level!==t||s&&r.type!==s||i.includes(r.id)||r.tags?.includes(c.NO_RANDOM)||r.tags?.includes(c.UNIQUE_GLOBAL)&&this.acquiredHistory.has(r.id)||r.tags?.includes(c.UNIQUE_SINGLE)&&this.slots.some(o=>o.item?.config.id===r.id)));return a.length===0?null:a[Math.floor(Math.random()*a.length)]}update(t){x.isFirstDown("N")&&k.selectNext(),x.isFirstDown("M")&&k.selectPrev(),x.isFirstDown("I")&&f.emit(u.item.use,{usedItem:this.getSelectedItem()})}draw(t){const e=this.slots,i=5,s=t.canvas.width,a=t.canvas.height,n=Math.min(60,s-2*i),r=this.getSelectedSlot();e.forEach((l,o)=>{const v=i,E=i+o*(n+i);E+n>a||(t.fillStyle="rgba(50,50,50,0.7)",t.fillRect(v,E,n,n),t.strokeStyle=l===r?"yellow":"white",t.lineWidth=l===r?2:1,t.strokeRect(v,E,n,n),t.fillStyle=l.item?"white":"rgba(200,200,200,0.3)",t.font=`${Math.min(n/3,14)}px sans-serif`,t.textAlign="center",t.textBaseline="middle",t.fillText(l.item?l.item.config.id:"空",v+n/2,E+n/2))})}}const k=new K;class R{static saveCurrentGame(t=1){const e={player:y.constructor.getSaveData(),layer:b.currentLayer,room:b.currentRoom,timestamp:new Date().toISOString()};let i=null;try{i=JSON.parse(localStorage.getItem("present_data"))}catch{i=null}return(!i||typeof i!="object")&&(i={saveSlots:[]}),i.saveSlots=i.saveSlots||[],i.saveSlots[t-1]=e,localStorage.setItem("present_data",JSON.stringify(i)),e}static async loadGame(t=1){let e=null;try{e=JSON.parse(localStorage.getItem("present_data"))}catch{e=null}if(!e?.saveSlots?.[t-1])return!1;const i=e.saveSlots[t-1];await b.loadRoom(i.layer,i.room);try{if(i.player?.position){const s=i.player.position;y.setPosition(new d(s.x,s.y))}i.player?.state&&(y.state=i.player.state)}catch{}return!0}constructor(){if(R.instance)return R.instance;R.instance=this,this.canvas=document.getElementById("canvas"),this.canvas.addEventListener("contextmenu",e=>e.preventDefault()),this.canvas.addEventListener("dragstart",e=>e.preventDefault()),this.ctx=this.canvas.getContext("2d"),this.leftCanvas=document.getElementById("left-ui"),this.rightCanvas=document.getElementById("right-ui"),this.leftCtx=this.leftCanvas.getContext("2d"),this.rightCtx=this.rightCanvas.getContext("2d"),this.isStop=!1,this.isPaused=!1,this.lastTime=0;const t=60;this.targetFrameTime=1e3/t,this.loop=this.loop.bind(this),this.statistics={portal:0,bullet:0,restart:0,jump:0,jumpTime:0}}async init(){await new Promise(n=>{document.readyState==="complete"?n():window.addEventListener("load",n)});const t=document.getElementById("exit-btn");if(t){t.replaceWith(t.cloneNode(!0));const n=document.getElementById("exit-btn");n.addEventListener("click",r=>{console.log("Exit button clicked - event:",r);try{document.pointerLockElement&&document.exitPointerLock()}catch{}this.stop()}),n.style.pointerEvents="auto",console.log("Exit button initialized:",n)}else console.error("Exit button not found!");await M.load(),await z.load();const e=localStorage.getItem("selected_slot"),i=Math.max(1,parseInt(e||"1",10)||1);this.currentSlotId=i;let s=!1;try{s=await R.loadGame(i)}catch{s=!1}if(s||await b.loadRoom(0,1),!s){const n=b.getPlayerSpawn();y.setPosition(new d(n.x,n.y))}f.on({event:u.game.tick,handler:({deltaTime:n})=>b.update(n,y),priority:.8}),f.on({event:u.game.tick,handler:({deltaTime:n})=>k.update(n),priority:1}),f.on({event:u.game.tick,handler:({deltaTime:n})=>g.update(n),priority:.7}),f.on({event:u.game.tick,handler:({deltaTime:n})=>y.update(n),priority:.5}),f.on({event:u.game.tick,handler:({deltaTime:n})=>this.enemies.forEach(r=>r.update(n)),priority:.3}),f.on({event:u.game.tick,handler:({deltaTime:n})=>j.update(n),priority:.1}),f.on({event:u.game.tick,handler:()=>{const n=this.ctx;n.clearRect(0,0,this.canvas.width,this.canvas.height),b.draw(n),j.draw(n),this.enemies.forEach(o=>o.draw(n)),y.draw(n),this.leftCtx.clearRect(0,0,this.leftCanvas.width,this.leftCanvas.height);const l=this.rightCtx;l.clearRect(0,0,this.rightCanvas.width,this.rightCanvas.height),k.draw(l)},priority:-1}),f.on({event:u.player.die,handler:()=>this.stop()});const a=b.getEnemySpawns();if(this.enemies=[],Array.isArray(a))for(const n of a)this.enemies.push(new at(n.type,new d(n.x,n.y)));k.tryAcquire(D.xq休憩),k.tryAcquire(D.yy友谊),k.tryAcquire(D.ls朗诵),window.itemManager=k}start(t=0){this.loop(0)}loop(t){const e=t-this.lastTime;e>=this.targetFrameTime&&(x.update(),A.enemies.length==0&&f.emit(u.game.battle.end),!this.isPaused&&!this.isStop&&f.emit(u.game.tick,{deltaTime:e})),this.lastTime=t-e%this.targetFrameTime,this.rafId=requestAnimationFrame(this.loop)}pause(){this.isPaused=!0}continue(){this.isPaused=!1}stop(){this.isStop=!0;try{this.rafId&&cancelAnimationFrame(this.rafId)}catch{}try{document.pointerLockElement&&document.exitPointerLock()}catch{}const t=this.currentSlotId&&this.currentSlotId>0?this.currentSlotId:1;R.saveCurrentGame(t)}}const A=new R;window.onload=()=>{A.init().then(()=>{A.start()})};
